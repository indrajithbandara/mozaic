<!DOCTYPE html><html><head><title>router.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../index.html" class="source"><span class="file_name">README</span></a><a href="../core~/api_mock.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">api_mock.coffee</span></a><a href="../core~/application_controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">application_controller.coffee</span></a><a href="../core~/auth.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">auth.coffee</span></a><a href="../core~/base_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_collection.coffee</span></a><a href="../core~/base_model.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_model.coffee</span></a><a href="../core~/base_widgets/autocomplete.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">autocomplete.coffee</span></a><a href="../core~/base_widgets/base_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">base_form.coffee</span></a><a href="../core~/base_widgets/delete_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">delete_form.coffee</span></a><a href="../core~/base_widgets/expanding_list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">expanding_list.coffee</span></a><a href="../core~/base_widgets/item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">item_count.coffee</span></a><a href="../core~/base_widgets/list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">list.coffee</span></a><a href="../core~/base_widgets/mediator_widget.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">mediator_widget.coffee</span></a><a href="../core~/base_widgets/nested_attributes_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">nested_attributes_form.coffee</span></a><a href="../core~/base_widgets/new_items_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">new_items_count.coffee</span></a><a href="../core~/base_widgets/notification_bar.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notification_bar.coffee</span></a><a href="../core~/base_widgets/notifications.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notifications.coffee</span></a><a href="../core~/base_widgets/order_by.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">order_by.coffee</span></a><a href="../core~/base_widgets/update_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">update_form.coffee</span></a><a href="../core~/base_widgets/url.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">url.coffee</span></a><a href="../core~/base_widgets/user_item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">user_item_count.coffee</span></a><a href="../core~/base_widgets/widget_editor.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">widget_editor.coffee</span></a><a href="../core~/channels_utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">channels_utils.coffee</span></a><a href="../core~/constants.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">constants.coffee</span></a><a href="../core~/context_processors.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">context_processors.coffee</span></a><a href="../core~/controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">controller.coffee</span></a><a href="../core~/core_modules.js.html" class="source "><span class="base_path">core~ / </span><span class="file_name">core_modules.js</span></a><a href="../core~/datasource/channel/create.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">create.coffee</span></a><a href="../core~/datasource/channel/destroy.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">destroy.coffee</span></a><a href="../core~/datasource/channel/read.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">read.coffee</span></a><a href="../core~/datasource/channel/update.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">update.coffee</span></a><a href="../core~/datasource/channel.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">channel.coffee</span></a><a href="../core~/datasource/datasource.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">datasource.coffee</span></a><a href="../core~/datasource/gc.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">gc.coffee</span></a><a href="../core~/datasource/refresher.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">refresher.coffee</span></a><a href="../core~/datasource/scheduler.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">scheduler.coffee</span></a><a href="../core~/datasource/widget.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">widget.coffee</span></a><a href="../core~/flags_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">flags_collection.coffee</span></a><a href="../core~/interceptor.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">interceptor.coffee</span></a><a href="../core~/layout.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">layout.coffee</span></a><a href="../core~/loader.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loader.coffee</span></a><a href="../core~/loading_animation.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loading_animation.coffee</span></a><a href="../core~/logging/sentry_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">sentry_logger.coffee</span></a><a href="../core~/logging/standard_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">standard_logger.coffee</span></a><a href="../core~/mocks.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mocks.coffee</span></a><a href="../core~/modal_window.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">modal_window.coffee</span></a><a href="../core~/module.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">module.coffee</span></a><a href="../core~/mozaic_backbone_form.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mozaic_backbone_form.coffee</span></a><a href="../core~/profiler.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">profiler.coffee</span></a><a href="../core~/pubsub.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">pubsub.coffee</span></a><a href="../core~/raw_data.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">raw_data.coffee</span></a><a href="../core~/router.coffee.html" class="source selected"><span class="base_path">core~ / </span><span class="file_name">router.coffee</span></a><a href="../core~/scrollable_widget.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">scrollable_widget.coffee</span></a><a href="../core~/utils/dom.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">dom.coffee</span></a><a href="../core~/utils/images.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">images.coffee</span></a><a href="../core~/utils/misc.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">misc.coffee</span></a><a href="../core~/utils/mozaic.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">mozaic.coffee</span></a><a href="../core~/utils/time.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">time.coffee</span></a><a href="../core~/utils/urls.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">urls.coffee</span></a><a href="../core~/utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">utils.coffee</span></a><a href="../core~/widget/aggregated_channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">aggregated_channels.coffee</span></a><a href="../core~/widget/backbone_events.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">backbone_events.coffee</span></a><a href="../core~/widget/channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">channels.coffee</span></a><a href="../core~/widget/modal_widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">modal_widget.coffee</span></a><a href="../core~/widget/params.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">params.coffee</span></a><a href="../core~/widget/rendering.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">rendering.coffee</span></a><a href="../core~/widget/states.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">states.coffee</span></a><a href="../core~/widget/widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">widget.coffee</span></a><a href="../core~/widget_starter.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">widget_starter.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>router.coffee</h1><div class="filepath">core~/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span><span class="s">&#39;cs!mozaic_module&#39;</span><span class="p">],</span> <span class="nf">(Module) -&gt;</span>
    <span class="k">class</span> <span class="nx">Router</span> <span class="k">extends</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Router</span>
        <span class="nv">delegateToController: </span><span class="nf">(controller_config, params...) =&gt;</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>Delegates the action of the controller to a specialized class
which is configured in App.urls.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>In case users don't have read access to a particular section of
the website, give a 404. This is to cover the cases when a user
has a link to some section which they shouldn't see</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">perm = </span><span class="nx">controller_config</span><span class="p">.</span><span class="nx">permissions</span>
            <span class="k">if</span> <span class="nx">perm</span><span class="o">?</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">Utils</span><span class="p">.</span><span class="nx">has_permission</span><span class="p">(</span><span class="nx">perm</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">)</span>
                <span class="nv">controller_config = </span><span class="nx">@urls</span><span class="p">[</span><span class="s">&#39;*not_found&#39;</span><span class="p">]</span>

            <span class="nv">module = </span><span class="s">&quot;cs!controller/&quot;</span> <span class="o">+</span> <span class="nx">controller_config</span><span class="p">.</span><span class="nx">controller</span>
            <span class="nv">page_layout = </span><span class="nx">App</span><span class="p">.</span><span class="nx">general</span><span class="p">.</span><span class="nx">PAGE_LAYOUT</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>Get the last parameter from "params" and filter it according to
the allowed<em>get</em>params controller configuration.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">get_params = </span><span class="nx">params</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
            <span class="nv">filtered_params = </span><span class="p">{}</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>Check if there is a definition of allowed<em>get</em>params first.
IF THERE IS NONE, ASSUME THAT NO GET PARAMS ARE EXPECTED (!!!)</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="s">&#39;allowed_get_params&#39;</span> <span class="k">of</span> <span class="nx">controller_config</span>
                <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">get_params</span>
                    <span class="k">if</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">controller_config</span><span class="p">.</span><span class="nx">allowed_get_params</span>
                        <span class="nx">filtered_params</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
            <span class="nx">params</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">filtered_params</span><span class="p">)</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Load controller layout</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">loader</span><span class="p">.</span><span class="nx">load_template</span><span class="p">(</span> <span class="nx">page_layout</span><span class="p">,</span> <span class="nf">(page_template) =&gt;</span>
                <span class="nx">loader</span><span class="p">.</span><span class="nx">load_module</span><span class="p">(</span><span class="s">&#39;cs!application_controller&#39;</span><span class="p">,</span> <span class="nf">(app_controller) =&gt;</span>
                    <span class="nx">app_controller</span><span class="p">.</span><span class="nx">new_controller</span><span class="p">(</span><span class="nx">controller_config</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Set the current controller in App.currentController</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nv">App.currentController = </span><span class="nx">controller_config</span><span class="p">.</span><span class="nx">controller</span>
                <span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">App</span><span class="p">.</span><span class="nx">general</span><span class="p">.</span><span class="nx">PAGE_LAYOUT</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="nv">constructor: </span><span class="nf">(urls) -&gt;</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Our router constructor receives a copy of App.urls array,
parses it and creates a routes array that will get passed
to the Backbone Router constructor.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">super</span><span class="p">()</span>
            <span class="vi">@urls = </span><span class="nx">urls</span>
            <span class="vi">@routes = </span><span class="p">{}</span>
            <span class="vi">@regexp_to_route = </span><span class="p">{}</span>
            <span class="k">for</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">data</span> <span class="k">of</span> <span class="nx">urls</span>
                <span class="nv">controller = </span><span class="nx">@urls</span><span class="p">[</span><span class="nx">path</span><span class="p">].</span><span class="nx">controller</span>
                <span class="nx">@routes</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;delegateToController&quot;</span>
                <span class="nv">regexp = </span><span class="nx">@_routeToRegExp</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
                <span class="nx">@regexp_to_route</span><span class="p">[</span><span class="nx">regexp</span><span class="p">]</span> <span class="o">=</span> <span class="nx">path</span>
                <span class="nv">data.url = </span><span class="nx">path</span>
            <span class="k">super</span><span class="p">({</span><span class="nv">routes: </span><span class="nx">@routes</span><span class="p">})</span>

        <span class="nv">namedParam    = </span><span class="sr">/:\w+/g</span>
        <span class="nv">splatParam    = </span><span class="sr">/\*\w+/g</span>
        <span class="nv">escapeRegExp  = </span><span class="sr">/[-[\]{}()+?.,\\^$|#\s]/g</span>

        <span class="nv">_routeToRegExp : </span><span class="nf">(route) -&gt;</span>
            <span class="nv">route = </span><span class="nx">route</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">escapeRegExp</span><span class="p">,</span> <span class="s">&quot;\\$&amp;&quot;</span><span class="p">)</span>
                         <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">namedParam</span><span class="p">,</span> <span class="s">&quot;([^\/?]*)&quot;</span><span class="p">)</span>
                         <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">splatParam</span><span class="p">,</span> <span class="s">&quot;([^\?]*)&quot;</span><span class="p">)</span>
            <span class="nx">route</span> <span class="o">+=</span> <span class="s">&#39;[/]?([\?]{1}.*)?&#39;</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">route</span> <span class="o">+</span> <span class="s">&#39;$&#39;</span><span class="p">)</span>

        <span class="nv">_extractParameters: </span><span class="nf">(route, fragment) -&gt;</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>We override Backbone.Router's parameter extraction method to also
return the route for which the parameters were extracted to the
callback function. This allows us to use the same function
(delegateToController) for multiple urls.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">result = </span><span class="k">super</span><span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">fragment</span><span class="p">)</span>
            <span class="nv">path = </span><span class="nx">@regexp_to_route</span><span class="p">[</span><span class="nx">route</span><span class="p">]</span>
            <span class="nx">result</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">@urls</span><span class="p">[</span><span class="nx">path</span><span class="p">])</span>
            <span class="nx">result</span>
    <span class="k">return</span> <span class="nx">Router</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Mon Aug 05 2013 15:56:42 GMT+0300 (EEST)  </div></div></body></html>