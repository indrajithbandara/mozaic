<!DOCTYPE html><html><head><title>mediator_widget.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../index.html" class="source"><span class="file_name">README</span></a><a href="../../core~/api_mock.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">api_mock.coffee</span></a><a href="../../core~/application_controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">application_controller.coffee</span></a><a href="../../core~/auth.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">auth.coffee</span></a><a href="../../core~/base_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_collection.coffee</span></a><a href="../../core~/base_model.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_model.coffee</span></a><a href="../../core~/base_widgets/autocomplete.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">autocomplete.coffee</span></a><a href="../../core~/base_widgets/base_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">base_form.coffee</span></a><a href="../../core~/base_widgets/delete_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">delete_form.coffee</span></a><a href="../../core~/base_widgets/expanding_list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">expanding_list.coffee</span></a><a href="../../core~/base_widgets/item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">item_count.coffee</span></a><a href="../../core~/base_widgets/list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">list.coffee</span></a><a href="../../core~/base_widgets/mediator_widget.coffee.html" class="source selected"><span class="base_path">core~ / base_widgets / </span><span class="file_name">mediator_widget.coffee</span></a><a href="../../core~/base_widgets/nested_attributes_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">nested_attributes_form.coffee</span></a><a href="../../core~/base_widgets/new_items_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">new_items_count.coffee</span></a><a href="../../core~/base_widgets/notification_bar.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notification_bar.coffee</span></a><a href="../../core~/base_widgets/notifications.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notifications.coffee</span></a><a href="../../core~/base_widgets/order_by.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">order_by.coffee</span></a><a href="../../core~/base_widgets/update_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">update_form.coffee</span></a><a href="../../core~/base_widgets/url.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">url.coffee</span></a><a href="../../core~/base_widgets/user_item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">user_item_count.coffee</span></a><a href="../../core~/base_widgets/widget_editor.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">widget_editor.coffee</span></a><a href="../../core~/channels_utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">channels_utils.coffee</span></a><a href="../../core~/constants.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">constants.coffee</span></a><a href="../../core~/context_processors.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">context_processors.coffee</span></a><a href="../../core~/controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">controller.coffee</span></a><a href="../../core~/core_modules.js.html" class="source "><span class="base_path">core~ / </span><span class="file_name">core_modules.js</span></a><a href="../../core~/datasource/channel/create.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">create.coffee</span></a><a href="../../core~/datasource/channel/destroy.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">destroy.coffee</span></a><a href="../../core~/datasource/channel/read.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">read.coffee</span></a><a href="../../core~/datasource/channel/update.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">update.coffee</span></a><a href="../../core~/datasource/channel.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">channel.coffee</span></a><a href="../../core~/datasource/datasource.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">datasource.coffee</span></a><a href="../../core~/datasource/gc.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">gc.coffee</span></a><a href="../../core~/datasource/refresher.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">refresher.coffee</span></a><a href="../../core~/datasource/scheduler.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">scheduler.coffee</span></a><a href="../../core~/datasource/widget.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">widget.coffee</span></a><a href="../../core~/flags_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">flags_collection.coffee</span></a><a href="../../core~/interceptor.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">interceptor.coffee</span></a><a href="../../core~/layout.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">layout.coffee</span></a><a href="../../core~/loader.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loader.coffee</span></a><a href="../../core~/loading_animation.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loading_animation.coffee</span></a><a href="../../core~/logging/sentry_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">sentry_logger.coffee</span></a><a href="../../core~/logging/standard_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">standard_logger.coffee</span></a><a href="../../core~/mocks.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mocks.coffee</span></a><a href="../../core~/modal_window.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">modal_window.coffee</span></a><a href="../../core~/module.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">module.coffee</span></a><a href="../../core~/mozaic_backbone_form.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mozaic_backbone_form.coffee</span></a><a href="../../core~/profiler.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">profiler.coffee</span></a><a href="../../core~/pubsub.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">pubsub.coffee</span></a><a href="../../core~/raw_data.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">raw_data.coffee</span></a><a href="../../core~/router.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">router.coffee</span></a><a href="../../core~/scrollable_widget.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">scrollable_widget.coffee</span></a><a href="../../core~/utils/dom.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">dom.coffee</span></a><a href="../../core~/utils/images.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">images.coffee</span></a><a href="../../core~/utils/misc.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">misc.coffee</span></a><a href="../../core~/utils/mozaic.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">mozaic.coffee</span></a><a href="../../core~/utils/time.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">time.coffee</span></a><a href="../../core~/utils/urls.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">urls.coffee</span></a><a href="../../core~/utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">utils.coffee</span></a><a href="../../core~/widget/aggregated_channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">aggregated_channels.coffee</span></a><a href="../../core~/widget/backbone_events.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">backbone_events.coffee</span></a><a href="../../core~/widget/channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">channels.coffee</span></a><a href="../../core~/widget/modal_widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">modal_widget.coffee</span></a><a href="../../core~/widget/params.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">params.coffee</span></a><a href="../../core~/widget/rendering.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">rendering.coffee</span></a><a href="../../core~/widget/states.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">states.coffee</span></a><a href="../../core~/widget/widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">widget.coffee</span></a><a href="../../core~/widget_starter.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">widget_starter.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>mediator_widget.coffee</h1><div class="filepath">core~/base_widgets/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span><span class="s">&#39;cs!channels_utils&#39;</span><span class="p">,</span> <span class="s">&#39;cs!widget&#39;</span><span class="p">],</span> <span class="nf">(channels_utils, Widget) -&gt;</span>
    <span class="k">class</span> <span class="nx">MediatorWidget</span> <span class="k">extends</span> <span class="nx">Widget</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>The Mediator Widget listens for events on the input channels and
triggeres events on the datasource that refresh the output channels.
These events can be /refresh, /scroll, etc.
The data from all input channels is merged together into a single object
and pushed as params to all output channels, thus triggering a new
data fetch from the server.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Warning! The mediator should not be used to modify data channels directly.
That's datasource's job. It's only purpose is to translate changes from
input channels into changes on output channels.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>The MediatorWidget has 4 main parameters:
- input<em>channel: it listens to events on this datasource channel
- output</em>channels: the datasource channels to give as a parameter
when an event on input_channel happens
- message: the message to send to the datasource
(can be '/refresh', '/scroll', etc., anything
that receivs a list of channels as a parameter).
Default value: 'refresh'.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>The Mediator widget also supports a list of fixed attributes for
the output channels, which should always be present regardless of
what the input channels trigger.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>The Mediator widget also supports a list of ignored attributes for
the input channels, which changed alone shouldn't trigger any
changes on the output channels. The ignored attributes are also
removed from the output channel params when other (not ignored)
attributes trigger publishing.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>This widget has priority when it comes to garbage collection</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">URGENT_FOR_GC: </span><span class="kc">true</span>

        <span class="nv">params_defaults:</span>
            <span class="s">&#39;message&#39;</span><span class="o">:</span> <span class="s">&#39;/refresh&#39;</span>
            <span class="s">&#39;input_channel&#39;</span><span class="o">:</span> <span class="s">&#39;data-params&#39;</span>
            <span class="s">&#39;input_channels&#39;</span><span class="o">:</span> <span class="s">&#39;data-params&#39;</span>
            <span class="s">&#39;output_channel&#39;</span><span class="o">:</span> <span class="s">&#39;data-params&#39;</span>
            <span class="s">&#39;output_channels&#39;</span><span class="o">:</span> <span class="s">&#39;data-params&#39;</span>
            <span class="s">&#39;skip_first&#39;</span><span class="o">:</span> <span class="s">&#39;data-params&#39;</span>
            <span class="s">&#39;fixed_attributes&#39;</span><span class="o">:</span> <span class="nf">(attrs) -&gt;</span> <span class="nx">attrs</span> <span class="o">or</span> <span class="p">{}</span>
            <span class="s">&#39;ignored_attributes&#39;</span><span class="o">:</span> <span class="nf">(attrs) -&gt;</span> <span class="nx">attrs</span> <span class="o">or</span> <span class="p">[]</span>

        <span class="nv">initialize: </span><span class="o">=&gt;</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>HORRIBLE HACK (see https://github.com/bogdans83/ubvu-unleashed/issues/1190)
By default skip_first = true because most mediators have
filters as their input channels, which results in an extra
API call due to a datasource bug :)
TODO(andrei): remove this once DS bug gets fixed</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="o">not</span> <span class="nx">@skip_first</span><span class="o">?</span>
               <span class="vi">@skip_first = </span><span class="kc">true</span>

            <span class="k">if</span> <span class="nx">@input_channel</span><span class="o">?</span>
                <span class="vi">@input_channels = </span><span class="p">[</span><span class="nx">@input_channel</span><span class="p">]</span>
            <span class="k">if</span> <span class="nx">@output_channel</span><span class="o">?</span>
                <span class="vi">@output_channels = </span><span class="p">[</span><span class="nx">@output_channel</span><span class="p">]</span>
            <span class="vi">@first = </span><span class="kc">true</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>Subscribe to the input channels</p>
</td><td class="code"><div class="highlight"><pre>            <span class="vi">@subscribed_channels = </span><span class="nx">@input_channels</span>
            <span class="vi">@aggregated_channels = </span><span class="p">{</span><span class="nv">get_input_channels: </span><span class="nx">@subscribed_channels</span><span class="p">}</span>

            <span class="vi">@pipe = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">get_module</span><span class="p">(</span><span class="s">&#39;pubsub&#39;</span><span class="p">)</span>

        <span class="nv">get_input_channels: </span><span class="nf">(params...) =&gt;</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>get<em>input</em>channels is an aggregated channels callback that gets triggered
on every event of the input channels. It collects data from all
events an pushes it to the data channel, which in turn refreshed the
output channels.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>skip_first skips the first aggregated event for this
set of channels. It is useful in order to avoid spurious events
like the case of filters being initialized either before
or after this widget in the Datasource.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>TODO(andrei): find a better solution</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">@first</span>
                <span class="vi">@first = </span><span class="kc">false</span>
                <span class="k">if</span> <span class="nx">@skip_first</span>
                    <span class="k">return</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Decide whether to continue with publishing on the output channels
if other attributes than the ignored ones have been changed</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">eventIsRelevant = </span><span class="kc">false</span>
            <span class="k">for</span> <span class="nx">channel_params</span> <span class="k">in</span> <span class="nx">params</span>
                <span class="nv">changedAttributes = </span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">channel_params</span><span class="p">.</span><span class="nx">changed_attributes</span> <span class="o">or</span> <span class="p">{})</span>
                <span class="nv">changedAttributes = </span><span class="nx">_</span><span class="p">.</span><span class="nx">without</span><span class="p">(</span><span class="nx">changedAttributes</span><span class="p">,</span>
                                              <span class="nx">@ignored_attributes</span><span class="p">...)</span>
                <span class="nv">eventIsRelevant = </span><span class="kc">true</span> <span class="k">if</span> <span class="nx">changedAttributes</span><span class="p">.</span><span class="nx">length</span>

            <span class="nx">@publishToChannel</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="k">if</span> <span class="nx">eventIsRelevant</span>

        <span class="nv">publishToChannel: </span><span class="nf">(params, options = {}) =&gt;</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>This method publishes an event of type @message
Allow the option to skipStreampollBuffer when publishing refresh to channel
@param {Array} params - array of channel parameters (like initial data)
that get merged together then published on the output channel.
@param {Object} [options] - options passed to Pubsub#publish
@param {Boolean} [options.skipStreampollBuffer]</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">skipStreampollBuffer = </span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">skipStreampollBuffer</span><span class="o">?</span> <span class="k">then</span> <span class="nx">options</span><span class="p">.</span><span class="nx">skipStreampollBuffer</span> <span class="k">else</span> <span class="kc">false</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>Merge data input channels data into a single object.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">translated_channel_params = </span><span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">@fixed_attributes</span><span class="p">)</span>
            <span class="k">for</span> <span class="nx">channel_params</span> <span class="k">in</span> <span class="nx">params</span>
                <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">translated_channel_params</span><span class="p">,</span> <span class="nx">@translateParams</span><span class="p">(</span><span class="nx">channel_params</span><span class="p">))</span>

            <span class="k">for</span> <span class="nx">channel</span> <span class="k">in</span> <span class="nx">@output_channels</span>
                <span class="nv">translated_output_channel = </span><span class="nx">@channel_mapping</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span>
                <span class="nv">channel_message = </span><span class="p">{}</span>
                <span class="nx">channel_message</span><span class="p">[</span><span class="nx">translated_output_channel</span><span class="p">]</span> <span class="o">=</span> <span class="nx">translated_channel_params</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>Notify each channel in output channels
with @message event</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">@pipe</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="nx">@message</span><span class="p">,</span> <span class="nx">channel_message</span><span class="p">,</span> <span class="p">{</span> <span class="nv">skipStreampollBuffer: </span><span class="nx">skipStreampollBuffer</span> <span class="p">})</span>

        <span class="nv">translateParams: </span><span class="nf">(params) -&gt;</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>Translates parameters from the input_channel format
to the format accepted by the output channel.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>Override this in your mediator class to pass whatever parameters
you like to the output channel.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p>@params {String} [params.type] - type of the channel event
@see Widget#_translateEventParams() for details on possible values.
@params {Object} [params.model] - instance of BaseModel, is passed for events
on channels that are backed by a single model. Ex: /streams/{{id}}
@params {Object} [params.collection] - instance of BaseCollection backing the channel.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">omit</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(),</span> <span class="nx">@ignored_attributes</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">MediatorWidget</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Mon Aug 05 2013 15:56:32 GMT+0300 (EEST)  </div></div></body></html>