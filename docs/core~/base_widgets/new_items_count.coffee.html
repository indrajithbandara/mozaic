<!DOCTYPE html><html><head><title>new_items_count.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../index.html" class="source"><span class="file_name">README</span></a><a href="../../core~/api_mock.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">api_mock.coffee</span></a><a href="../../core~/application_controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">application_controller.coffee</span></a><a href="../../core~/auth.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">auth.coffee</span></a><a href="../../core~/base_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_collection.coffee</span></a><a href="../../core~/base_model.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_model.coffee</span></a><a href="../../core~/base_widgets/autocomplete.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">autocomplete.coffee</span></a><a href="../../core~/base_widgets/base_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">base_form.coffee</span></a><a href="../../core~/base_widgets/delete_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">delete_form.coffee</span></a><a href="../../core~/base_widgets/expanding_list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">expanding_list.coffee</span></a><a href="../../core~/base_widgets/item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">item_count.coffee</span></a><a href="../../core~/base_widgets/list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">list.coffee</span></a><a href="../../core~/base_widgets/mediator_widget.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">mediator_widget.coffee</span></a><a href="../../core~/base_widgets/nested_attributes_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">nested_attributes_form.coffee</span></a><a href="../../core~/base_widgets/new_items_count.coffee.html" class="source selected"><span class="base_path">core~ / base_widgets / </span><span class="file_name">new_items_count.coffee</span></a><a href="../../core~/base_widgets/notification_bar.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notification_bar.coffee</span></a><a href="../../core~/base_widgets/notifications.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notifications.coffee</span></a><a href="../../core~/base_widgets/order_by.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">order_by.coffee</span></a><a href="../../core~/base_widgets/update_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">update_form.coffee</span></a><a href="../../core~/base_widgets/url.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">url.coffee</span></a><a href="../../core~/base_widgets/user_item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">user_item_count.coffee</span></a><a href="../../core~/base_widgets/widget_editor.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">widget_editor.coffee</span></a><a href="../../core~/channels_utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">channels_utils.coffee</span></a><a href="../../core~/constants.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">constants.coffee</span></a><a href="../../core~/context_processors.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">context_processors.coffee</span></a><a href="../../core~/controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">controller.coffee</span></a><a href="../../core~/core_modules.js.html" class="source "><span class="base_path">core~ / </span><span class="file_name">core_modules.js</span></a><a href="../../core~/datasource/channel/create.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">create.coffee</span></a><a href="../../core~/datasource/channel/destroy.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">destroy.coffee</span></a><a href="../../core~/datasource/channel/read.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">read.coffee</span></a><a href="../../core~/datasource/channel/update.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">update.coffee</span></a><a href="../../core~/datasource/channel.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">channel.coffee</span></a><a href="../../core~/datasource/datasource.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">datasource.coffee</span></a><a href="../../core~/datasource/gc.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">gc.coffee</span></a><a href="../../core~/datasource/refresher.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">refresher.coffee</span></a><a href="../../core~/datasource/scheduler.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">scheduler.coffee</span></a><a href="../../core~/datasource/widget.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">widget.coffee</span></a><a href="../../core~/flags_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">flags_collection.coffee</span></a><a href="../../core~/interceptor.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">interceptor.coffee</span></a><a href="../../core~/layout.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">layout.coffee</span></a><a href="../../core~/loader.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loader.coffee</span></a><a href="../../core~/loading_animation.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loading_animation.coffee</span></a><a href="../../core~/logging/sentry_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">sentry_logger.coffee</span></a><a href="../../core~/logging/standard_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">standard_logger.coffee</span></a><a href="../../core~/mocks.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mocks.coffee</span></a><a href="../../core~/modal_window.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">modal_window.coffee</span></a><a href="../../core~/module.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">module.coffee</span></a><a href="../../core~/mozaic_backbone_form.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mozaic_backbone_form.coffee</span></a><a href="../../core~/profiler.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">profiler.coffee</span></a><a href="../../core~/pubsub.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">pubsub.coffee</span></a><a href="../../core~/raw_data.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">raw_data.coffee</span></a><a href="../../core~/router.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">router.coffee</span></a><a href="../../core~/scrollable_widget.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">scrollable_widget.coffee</span></a><a href="../../core~/utils/dom.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">dom.coffee</span></a><a href="../../core~/utils/images.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">images.coffee</span></a><a href="../../core~/utils/misc.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">misc.coffee</span></a><a href="../../core~/utils/mozaic.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">mozaic.coffee</span></a><a href="../../core~/utils/time.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">time.coffee</span></a><a href="../../core~/utils/urls.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">urls.coffee</span></a><a href="../../core~/utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">utils.coffee</span></a><a href="../../core~/widget/aggregated_channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">aggregated_channels.coffee</span></a><a href="../../core~/widget/backbone_events.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">backbone_events.coffee</span></a><a href="../../core~/widget/channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">channels.coffee</span></a><a href="../../core~/widget/modal_widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">modal_widget.coffee</span></a><a href="../../core~/widget/params.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">params.coffee</span></a><a href="../../core~/widget/rendering.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">rendering.coffee</span></a><a href="../../core~/widget/states.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">states.coffee</span></a><a href="../../core~/widget/widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">widget.coffee</span></a><a href="../../core~/widget_starter.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">widget_starter.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>new_items_count.coffee</h1><div class="filepath">core~/base_widgets/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span><span class="s">&#39;cs!widget&#39;</span><span class="p">],</span> <span class="nf">(Widget) -&gt;</span>

    <span class="k">class</span> <span class="nx">NewItemCountWidget</span> <span class="k">extends</span> <span class="nx">Widget</span>
        <span class="nv">subscribed_channels: </span><span class="p">[</span><span class="s">&#39;/items&#39;</span><span class="p">,</span> <span class="s">&#39;/filters&#39;</span><span class="p">]</span>
        <span class="nv">template_name: </span><span class="s">&#39;templates/new-items-count.hjs&#39;</span>
        <span class="nv">events:</span>
            <span class="s">&quot;click .item-refresh-link a&quot;</span><span class="o">:</span> <span class="s">&quot;refreshItems&quot;</span>
        <span class="nv">params_defaults:</span>
            <span class="s">&#39;single_item&#39;</span><span class="o">:</span> <span class="s">&#39;data-params&#39;</span>
            <span class="s">&#39;multiple_items&#39;</span><span class="o">:</span> <span class="s">&#39;data-params&#39;</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>Use the scroll of the entire window if not specific scrollable
target has been specified</p>
</td><td class="code"><div class="highlight"><pre>            <span class="s">&#39;scrollable_target&#39;</span><span class="o">:</span> <span class="nf">(target) -&gt;</span> <span class="nx">target</span> <span class="o">or</span> <span class="s">&#39;html, body&#39;</span>
        <span class="nv">bound_to_buffer: </span><span class="kc">false</span>


        <span class="nv">refreshItems: </span><span class="nf">(event) =&gt;</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Whenever the user wants to see the latest mentions,
refresh the mentions channel and hide the new mentions counter.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>First, scroll to the top because the new mentions count
is shown permanently as an overlay. This will allow the user
to actually see the new mentions being inserted into the DOM.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">$</span><span class="p">(</span><span class="nx">@scrollable_target</span><span class="p">).</span><span class="nx">animate</span><span class="p">(</span><span class="nv">scrollTop: </span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;slow&#39;</span><span class="p">)</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>Ask for a fresh batch of mentions. These might come from the
streampoll buffering mechanism immediately.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@refreshChannel</span><span class="p">(</span><span class="s">&#39;/items&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">false</span>


        <span class="nv">get_items_buffer: </span><span class="nf">(type, params...) =&gt;</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>This function is subscribed to the events of the mention buffer.
Since it's not subscribed through the widget mechanisms
(but manually), we will translate the event params manually.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">translated = </span><span class="nx">@_translateEventParams</span><span class="p">(</span><span class="s">&#39;collection&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">params</span><span class="p">...)</span>
            <span class="k">if</span> <span class="nx">translated</span> <span class="o">and</span> <span class="nx">translated</span><span class="p">.</span><span class="nx">collection</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Check that the items from the buffer are actually not
part of the underlying collection (a.k.a. they are truly new).
Duplicated items sometimes arrive due to a race in DataSource.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nv">length = </span><span class="mi">0</span>
                <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">translated</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">models</span>
                    <span class="k">if</span> <span class="o">not</span> <span class="nx">translated</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
                        <span class="nv">length = </span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="nx">@el</span><span class="p">.</span><span class="nx">show</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">100</span>
                        <span class="nv">length = </span><span class="s">&#39;&gt; 100&#39;</span>
                    <span class="nv">items = </span><span class="nx">@multiple_items</span>
                    <span class="k">if</span> <span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">@single_item</span><span class="o">?</span>
                        <span class="nv">items = </span><span class="nx">@single_item</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Modify page title to let the user know there are some new items</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">Utils</span><span class="p">.</span><span class="nx">setTitle</span><span class="p">(</span><span class="nv">count: </span><span class="nx">length</span><span class="p">)</span>
                    <span class="nx">@renderLayout</span><span class="p">({</span><span class="nv">result: </span><span class="nx">length</span><span class="p">,</span> <span class="nv">timespan: </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span> <span class="nv">items: </span><span class="nx">items</span><span class="p">})</span>
                <span class="k">else</span>
                    <span class="nx">Utils</span><span class="p">.</span><span class="nx">setTitle</span><span class="p">(</span><span class="nv">count: </span><span class="mi">0</span><span class="p">)</span>
                    <span class="nx">@el</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>

        <span class="nv">get_items: </span><span class="nf">(params) =&gt;</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>Whenever a whole new mentions collection has arrived,
subscribe the local widget to its buffer's events.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">params</span><span class="p">.</span><span class="nx">collection</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@bound_to_buffer</span>
                <span class="vi">@bound_to_buffer = </span><span class="kc">true</span>
                <span class="k">if</span> <span class="nx">params</span><span class="p">.</span><span class="nx">collection</span> <span class="o">and</span> <span class="nx">params</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">buffer</span>
                    <span class="nx">params</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="nx">@get_items_buffer</span><span class="p">)</span>

        <span class="nv">get_filters: </span><span class="nf">(filters_params, mentions_params) =&gt;</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>Whenever the user selects a new value for filters,
hide the current item count because it's invalid.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@el</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>

        <span class="nv">destroy: </span><span class="o">=&gt;</span>
            <span class="k">super</span><span class="p">()</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>TODO: somehow unbind from the buffer</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="nx">NewItemCountWidget</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Mon Aug 05 2013 15:56:32 GMT+0300 (EEST)  </div></div></body></html>