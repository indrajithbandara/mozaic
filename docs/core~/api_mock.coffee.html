<!DOCTYPE html><html><head><title>api_mock.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../index.html" class="source"><span class="file_name">README</span></a><a href="../core~/api_mock.coffee.html" class="source selected"><span class="base_path">core~ / </span><span class="file_name">api_mock.coffee</span></a><a href="../core~/application_controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">application_controller.coffee</span></a><a href="../core~/auth.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">auth.coffee</span></a><a href="../core~/base_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_collection.coffee</span></a><a href="../core~/base_model.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_model.coffee</span></a><a href="../core~/base_widgets/autocomplete.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">autocomplete.coffee</span></a><a href="../core~/base_widgets/base_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">base_form.coffee</span></a><a href="../core~/base_widgets/delete_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">delete_form.coffee</span></a><a href="../core~/base_widgets/expanding_list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">expanding_list.coffee</span></a><a href="../core~/base_widgets/item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">item_count.coffee</span></a><a href="../core~/base_widgets/list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">list.coffee</span></a><a href="../core~/base_widgets/mediator_widget.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">mediator_widget.coffee</span></a><a href="../core~/base_widgets/nested_attributes_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">nested_attributes_form.coffee</span></a><a href="../core~/base_widgets/new_items_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">new_items_count.coffee</span></a><a href="../core~/base_widgets/notification_bar.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notification_bar.coffee</span></a><a href="../core~/base_widgets/notifications.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notifications.coffee</span></a><a href="../core~/base_widgets/order_by.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">order_by.coffee</span></a><a href="../core~/base_widgets/update_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">update_form.coffee</span></a><a href="../core~/base_widgets/url.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">url.coffee</span></a><a href="../core~/base_widgets/user_item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">user_item_count.coffee</span></a><a href="../core~/base_widgets/widget_editor.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">widget_editor.coffee</span></a><a href="../core~/channels_utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">channels_utils.coffee</span></a><a href="../core~/constants.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">constants.coffee</span></a><a href="../core~/context_processors.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">context_processors.coffee</span></a><a href="../core~/controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">controller.coffee</span></a><a href="../core~/core_modules.js.html" class="source "><span class="base_path">core~ / </span><span class="file_name">core_modules.js</span></a><a href="../core~/datasource/channel/create.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">create.coffee</span></a><a href="../core~/datasource/channel/destroy.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">destroy.coffee</span></a><a href="../core~/datasource/channel/read.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">read.coffee</span></a><a href="../core~/datasource/channel/update.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">update.coffee</span></a><a href="../core~/datasource/channel.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">channel.coffee</span></a><a href="../core~/datasource/datasource.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">datasource.coffee</span></a><a href="../core~/datasource/gc.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">gc.coffee</span></a><a href="../core~/datasource/refresher.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">refresher.coffee</span></a><a href="../core~/datasource/scheduler.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">scheduler.coffee</span></a><a href="../core~/datasource/widget.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">widget.coffee</span></a><a href="../core~/flags_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">flags_collection.coffee</span></a><a href="../core~/interceptor.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">interceptor.coffee</span></a><a href="../core~/layout.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">layout.coffee</span></a><a href="../core~/loader.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loader.coffee</span></a><a href="../core~/loading_animation.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loading_animation.coffee</span></a><a href="../core~/logging/sentry_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">sentry_logger.coffee</span></a><a href="../core~/logging/standard_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">standard_logger.coffee</span></a><a href="../core~/mocks.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mocks.coffee</span></a><a href="../core~/modal_window.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">modal_window.coffee</span></a><a href="../core~/module.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">module.coffee</span></a><a href="../core~/mozaic_backbone_form.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mozaic_backbone_form.coffee</span></a><a href="../core~/profiler.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">profiler.coffee</span></a><a href="../core~/pubsub.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">pubsub.coffee</span></a><a href="../core~/raw_data.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">raw_data.coffee</span></a><a href="../core~/router.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">router.coffee</span></a><a href="../core~/scrollable_widget.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">scrollable_widget.coffee</span></a><a href="../core~/utils/dom.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">dom.coffee</span></a><a href="../core~/utils/images.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">images.coffee</span></a><a href="../core~/utils/misc.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">misc.coffee</span></a><a href="../core~/utils/mozaic.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">mozaic.coffee</span></a><a href="../core~/utils/time.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">time.coffee</span></a><a href="../core~/utils/urls.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">urls.coffee</span></a><a href="../core~/utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">utils.coffee</span></a><a href="../core~/widget/aggregated_channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">aggregated_channels.coffee</span></a><a href="../core~/widget/backbone_events.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">backbone_events.coffee</span></a><a href="../core~/widget/channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">channels.coffee</span></a><a href="../core~/widget/modal_widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">modal_widget.coffee</span></a><a href="../core~/widget/params.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">params.coffee</span></a><a href="../core~/widget/rendering.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">rendering.coffee</span></a><a href="../core~/widget/states.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">states.coffee</span></a><a href="../core~/widget/widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">widget.coffee</span></a><a href="../core~/widget_starter.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">widget_starter.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>api_mock.coffee</h1><div class="filepath">core~/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span><span class="s">&#39;cs!tests/factories/master_factory&#39;</span><span class="p">],</span> <span class="nf">(MasterFactory) -&gt;</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>TODO: Document mocking params</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nv">master_factory = </span><span class="k">new</span> <span class="nx">MasterFactory</span><span class="p">()</span>

    <span class="nv">ApiMock =</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Property exposes MasterFactory's mapping between channels
and factories.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">channelsToFactoriesMapping: </span><span class="o">\</span>
            <span class="nx">master_factory</span><span class="p">.</span><span class="nx">getChannelsToFactoriesMapping</span><span class="p">()</span>

        <span class="nv">apiMock: </span><span class="nf">(resources) -&gt;</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>Mock some api calls.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">result = </span><span class="p">{}</span>
            <span class="k">if</span> <span class="o">not</span> <span class="nx">@mocks</span>
                <span class="vi">@mocks = </span><span class="p">{}</span>
            <span class="k">for</span> <span class="nx">resource</span><span class="p">,</span> <span class="nx">params</span> <span class="k">of</span> <span class="nx">resources</span>
                <span class="k">if</span> <span class="nx">params</span><span class="p">.</span><span class="nx">response</span>
                    <span class="nv">response = </span><span class="nx">params</span><span class="p">.</span><span class="nx">response</span>
                <span class="k">else</span>
                    <span class="nv">response = </span><span class="nx">@getMockedApiResponse</span><span class="p">(</span><span class="nx">resource</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span>
                <span class="nv">id = </span><span class="nx">@mockResource</span><span class="p">(</span><span class="nx">resource</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>Save the id to be able to clear it later and rebind it.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">@mocks</span><span class="p">[</span><span class="nx">resource</span><span class="p">]</span> <span class="o">=</span> <span class="nx">id</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Depending on the channel type (relational or api), populate
the response object the same way as the objects would be
received inside the channel callback</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">objects</span>
                    <span class="nx">result</span><span class="p">[</span><span class="nx">resource</span><span class="p">]</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">objects</span>
                <span class="k">else</span>
                    <span class="nx">result</span><span class="p">[</span><span class="nx">resource</span><span class="p">]</span> <span class="o">=</span> <span class="nx">response</span>
            <span class="k">return</span> <span class="nx">result</span>

        <span class="nv">mockResource: </span><span class="nf">(resource, response, params = {}) -&gt;</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>The mockjax_options allow you to pass extra params
to the mockjax configuration.
Example of use case:
you want the status to be 403, not 200 which is by
default.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">$</span><span class="p">.</span><span class="nx">mockjax</span><span class="p">(</span>
                <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">params</span><span class="p">.</span><span class="nx">mockjax_options</span><span class="p">,</span>
                    <span class="nv">url: </span><span class="nx">@getResourceRegExp</span><span class="p">(</span><span class="nx">resource</span><span class="p">)</span>
                    <span class="nv">response: </span><span class="nf">-&gt;</span>
                        <span class="vi">@responseText = </span><span class="nx">response</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="nv">getResourceRegExp: </span><span class="nf">(resource) -&gt;</span>
            <span class="nv">endpoint = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">App</span><span class="p">.</span><span class="nx">general</span><span class="p">.</span><span class="nx">FRONTAPI_URL</span><span class="si">}</span><span class="s">/.*/</span><span class="si">#{</span><span class="nx">resource</span><span class="si">}</span><span class="s">/([^a-z]|$)&quot;</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">endpoint</span><span class="p">)</span>

        <span class="nv">getMockedApiResponse: </span><span class="nf">(resource, params) -&gt;</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Mock some API response</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">response = </span><span class="nx">master_factory</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">resource</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>If is_api channel do not wrap the response under 'objects' key
Useful for calls to analytics
Api responses should be returned directly, w/out being wrapped
inside any array (this should be the default actually)</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">response</span><span class="o">?</span><span class="p">.</span><span class="nx">is_api</span>
                <span class="k">return</span> <span class="nx">response</span>
            <span class="k">else</span> <span class="k">if</span> <span class="nx">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">is_api</span>
                <span class="k">return</span> <span class="nx">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span>
                <span class="k">if</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
                    <span class="nv">response = </span><span class="p">[</span><span class="nx">response</span><span class="p">]</span>
                <span class="k">return</span> <span class="p">{</span><span class="s">&#39;objects&#39;</span><span class="o">:</span> <span class="nx">response</span><span class="p">}</span>

        <span class="nv">clearResource: </span><span class="nf">(resource) -&gt;</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">mockjaxClear</span><span class="p">(</span><span class="nx">@mocks</span><span class="p">[</span><span class="nx">resource</span><span class="p">])</span>

        <span class="nv">mockChannel: </span><span class="nf">(args) -&gt;</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>This method mocks channels. It create It uses @apiMock internally,
however it mocks and creates <strong>one</strong> channel instead of
mocking multiple urls.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>@see tests/modules/reports/widget/report<em>widget</em>sentiment<em>meter</em>form.coffee#injectSentimentMeterForm()
@param {Object} args
@param {String} args.type - the channel type to mock
@see conf/datasource.js for channel types.
@param {Object} args.params - params to pass on to ApiMock.
Defaults to {}. @see BaseTest#<em>apiMock for params.
@param {Object} args.channel</em>params - optional params for
channel creation - used for the cases when
creating a channel needs mandatory params
for building the channel URL.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>@return {Object} output - an object with the following props:
@return {String} output.id - id of newly created channel
@return {Object|Array} output.data - data that will be served
to the channel when a request to it will be made.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">factoryType = </span><span class="nx">ApiMock</span><span class="p">.</span><span class="nx">channelsToFactoriesMapping</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span>
            <span class="k">unless</span> <span class="nx">factoryType</span><span class="o">?</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;No factory for channel `</span><span class="si">#{</span><span class="nx">args</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="s">`&quot;</span>

            <span class="nv">new_data_channels_params = </span><span class="p">{}</span>
            <span class="nx">new_data_channels_params</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">channel_creation_params</span> <span class="o">or</span> <span class="p">{}</span>
            <span class="p">[</span><span class="nx">channelInstanceId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Utils</span><span class="p">.</span><span class="nx">newDataChannels</span><span class="p">(</span><span class="nx">new_data_channels_params</span><span class="p">)</span>

            <span class="nv">mockParams = </span><span class="p">{}</span>
            <span class="nx">mockParams</span><span class="p">[</span><span class="nx">factoryType</span><span class="p">]</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">params</span> <span class="o">or</span> <span class="p">{}</span>
            <span class="nv">channelMocks = </span><span class="nx">@apiMock</span><span class="p">(</span><span class="nx">mockParams</span><span class="p">)[</span><span class="nx">factoryType</span><span class="p">]</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Always return an array for consistency</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">channelMocks</span><span class="p">)</span>
                <span class="nv">channelMocks = </span><span class="p">[</span><span class="nx">channelMocks</span><span class="p">]</span>

            <span class="nv">output =</span>
                <span class="nv">id: </span><span class="nx">channelInstanceId</span>
                <span class="nv">data: </span><span class="nx">channelMocks</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Mon Aug 05 2013 15:56:29 GMT+0300 (EEST)  </div></div></body></html>