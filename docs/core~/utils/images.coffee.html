<!DOCTYPE html><html><head><title>images.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../index.html" class="source"><span class="file_name">README</span></a><a href="../../core~/api_mock.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">api_mock.coffee</span></a><a href="../../core~/application_controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">application_controller.coffee</span></a><a href="../../core~/auth.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">auth.coffee</span></a><a href="../../core~/base_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_collection.coffee</span></a><a href="../../core~/base_model.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_model.coffee</span></a><a href="../../core~/base_widgets/autocomplete.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">autocomplete.coffee</span></a><a href="../../core~/base_widgets/base_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">base_form.coffee</span></a><a href="../../core~/base_widgets/delete_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">delete_form.coffee</span></a><a href="../../core~/base_widgets/expanding_list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">expanding_list.coffee</span></a><a href="../../core~/base_widgets/item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">item_count.coffee</span></a><a href="../../core~/base_widgets/list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">list.coffee</span></a><a href="../../core~/base_widgets/mediator_widget.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">mediator_widget.coffee</span></a><a href="../../core~/base_widgets/nested_attributes_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">nested_attributes_form.coffee</span></a><a href="../../core~/base_widgets/new_items_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">new_items_count.coffee</span></a><a href="../../core~/base_widgets/notification_bar.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notification_bar.coffee</span></a><a href="../../core~/base_widgets/notifications.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notifications.coffee</span></a><a href="../../core~/base_widgets/order_by.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">order_by.coffee</span></a><a href="../../core~/base_widgets/update_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">update_form.coffee</span></a><a href="../../core~/base_widgets/url.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">url.coffee</span></a><a href="../../core~/base_widgets/user_item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">user_item_count.coffee</span></a><a href="../../core~/base_widgets/widget_editor.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">widget_editor.coffee</span></a><a href="../../core~/channels_utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">channels_utils.coffee</span></a><a href="../../core~/constants.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">constants.coffee</span></a><a href="../../core~/context_processors.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">context_processors.coffee</span></a><a href="../../core~/controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">controller.coffee</span></a><a href="../../core~/core_modules.js.html" class="source "><span class="base_path">core~ / </span><span class="file_name">core_modules.js</span></a><a href="../../core~/datasource/channel/create.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">create.coffee</span></a><a href="../../core~/datasource/channel/destroy.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">destroy.coffee</span></a><a href="../../core~/datasource/channel/read.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">read.coffee</span></a><a href="../../core~/datasource/channel/update.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">update.coffee</span></a><a href="../../core~/datasource/channel.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">channel.coffee</span></a><a href="../../core~/datasource/datasource.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">datasource.coffee</span></a><a href="../../core~/datasource/gc.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">gc.coffee</span></a><a href="../../core~/datasource/refresher.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">refresher.coffee</span></a><a href="../../core~/datasource/scheduler.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">scheduler.coffee</span></a><a href="../../core~/datasource/widget.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">widget.coffee</span></a><a href="../../core~/flags_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">flags_collection.coffee</span></a><a href="../../core~/interceptor.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">interceptor.coffee</span></a><a href="../../core~/layout.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">layout.coffee</span></a><a href="../../core~/loader.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loader.coffee</span></a><a href="../../core~/loading_animation.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loading_animation.coffee</span></a><a href="../../core~/logging/sentry_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">sentry_logger.coffee</span></a><a href="../../core~/logging/standard_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">standard_logger.coffee</span></a><a href="../../core~/mocks.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mocks.coffee</span></a><a href="../../core~/modal_window.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">modal_window.coffee</span></a><a href="../../core~/module.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">module.coffee</span></a><a href="../../core~/mozaic_backbone_form.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mozaic_backbone_form.coffee</span></a><a href="../../core~/profiler.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">profiler.coffee</span></a><a href="../../core~/pubsub.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">pubsub.coffee</span></a><a href="../../core~/raw_data.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">raw_data.coffee</span></a><a href="../../core~/router.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">router.coffee</span></a><a href="../../core~/scrollable_widget.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">scrollable_widget.coffee</span></a><a href="../../core~/utils/dom.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">dom.coffee</span></a><a href="../../core~/utils/images.coffee.html" class="source selected"><span class="base_path">core~ / utils / </span><span class="file_name">images.coffee</span></a><a href="../../core~/utils/misc.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">misc.coffee</span></a><a href="../../core~/utils/mozaic.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">mozaic.coffee</span></a><a href="../../core~/utils/time.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">time.coffee</span></a><a href="../../core~/utils/urls.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">urls.coffee</span></a><a href="../../core~/utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">utils.coffee</span></a><a href="../../core~/widget/aggregated_channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">aggregated_channels.coffee</span></a><a href="../../core~/widget/backbone_events.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">backbone_events.coffee</span></a><a href="../../core~/widget/channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">channels.coffee</span></a><a href="../../core~/widget/modal_widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">modal_widget.coffee</span></a><a href="../../core~/widget/params.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">params.coffee</span></a><a href="../../core~/widget/rendering.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">rendering.coffee</span></a><a href="../../core~/widget/states.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">states.coffee</span></a><a href="../../core~/widget/widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">widget.coffee</span></a><a href="../../core~/widget_starter.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">widget_starter.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>images.coffee</h1><div class="filepath">core~/utils/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">define</span> <span class="p">[],</span> <span class="p">()</span> <span class="nf">-&gt;</span>

    <span class="nv">CLASS_IMG_LOADED = </span><span class="s">&#39;img-load-success&#39;</span>

    <span class="nv">images =</span>
        <span class="nv">mapDefaultImages: </span><span class="nf">(el, types = {}) -&gt;</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>Map broken image paths to corresponding
default ones</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>The types argument must be a key-value object, where
the key is a jQuery selector and the value is a
default image name from Constants.DEFAULT_IMAGES</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>The value can also be null if the img tags have
pre-defined data-default-image values
Go through specified types and replace the defaut-image
data param of the targeted img tags</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">for</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">types</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>Add event handler for error</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">selector</span><span class="p">).</span><span class="nx">on</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Prevent infinite loop if default image is also broken</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">off</span><span class="p">(</span><span class="s">&#39;error&#39;</span><span class="p">)</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Replace image source</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">this</span><span class="p">.</span><span class="nv">src = </span><span class="nx">src</span> <span class="k">if</span> <span class="p">(</span><span class="nv">src = </span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;default-image&#39;</span><span class="p">))</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Populate default-image data value from constants, if a src
for the given image name is defined</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="nv">src = </span><span class="nx">Utils</span><span class="p">.</span><span class="nx">getDefaultImage</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span>
                    <span class="nx">el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">selector</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;default-image&#39;</span><span class="p">,</span> <span class="nx">src</span><span class="p">)</span>

        <span class="nv">getDefaultImage: </span><span class="nf">(name) -&gt;</span>
            <span class="k">if</span> <span class="o">not</span> <span class="nx">Constants</span><span class="p">.</span><span class="nx">DEFAULT_IMAGES</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span><span class="o">?</span>
                <span class="k">return</span> <span class="kc">false</span>
            <span class="k">return</span> <span class="nx">Utils</span><span class="p">.</span><span class="nx">getStaticUrl</span><span class="p">(</span><span class="nx">Constants</span><span class="p">.</span><span class="nx">DEFAULT_IMAGES</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span>

        <span class="nv">lazyLoadImages: </span><span class="nf">($images, options) -&gt;</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>Method loads images in the background, then pops them
into the DOM. It expects as param a jQuery object
with an img (or a list of imgs) that has a <code>data-src</code>
attribute containing the url of the image to be loaded
in the background.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>Process:()
1. clone the img element in memory
2. get url from data-src and put it in src in the cloned img tag
- if we're doing twitter avatars load a fast low-res image first.
3. wait until appropriate image is loaded on the cloned img tag
- if it has load add a class <code>img-load-success</code>
4. replace the original img tag with the cloned and loaded img
- if it's not loaded keep the original image (which will display nothing)</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>@param {Object} $images - jQuery object
@param {Object} options
@param {Function} [options.callback] - gets executed either on
error or on success when loading the image.
@param {String} [options.twitterAvatarSize] - if executed on a
twitter avatar, resize it to this image
@return undefined</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>TODO (topliceanu) allow this function to be controlled from the
DOM, using a data-size attribute, which will override anything.
Ex: <img data-src="..' data-size="_mini"/></p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">defaults =</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>This is the size that the image should be resized to.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nv">twitterAvatarSize: </span><span class="s">&#39;_bigger&#39;</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>This method is executed when the final image is loaded.
It's called wither with an error or the final image jQuery el.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nv">callback: </span><span class="nf">-&gt;</span>

            <span class="nv">options = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">defaults</span><span class="p">,</span> <span class="nx">options</span>

            <span class="nv">twitterPostfixes = </span><span class="p">[</span>
                <span class="s">&#39;_reasonably_small&#39;</span> <span class="c1"># 128x128px</span>
                <span class="s">&#39;_bigger&#39;</span> <span class="c1"># 73x73px</span>
                <span class="s">&#39;_normal&#39;</span> <span class="c1"># 48x48px</span>
                <span class="s">&#39;_mini&#39;</span> <span class="c1"># 24x24px</span>
            <span class="p">]</span>

            <span class="nx">$images</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(index, image) -&gt;</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>Filter out elements that are not <code>img</code> tags and don't have
<code>data-src</code> attribute.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">return</span> <span class="k">unless</span> <span class="nx">image</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">is</span> <span class="s">&#39;img&#39;</span> <span class="o">and</span>
                    <span class="nx">image</span><span class="p">.</span><span class="nx">hasAttribute</span> <span class="s">&#39;data-src&#39;</span>

                <span class="nv">$image = </span><span class="nx">$</span><span class="p">(</span><span class="nx">image</span><span class="p">)</span>
                <span class="nv">$clone = </span><span class="nx">$image</span><span class="p">.</span><span class="nx">clone</span><span class="p">()</span>
                <span class="nv">originalUrl = </span><span class="nx">$clone</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&#39;data-src&#39;</span>

                <span class="nv">isTwitterAvatar = </span><span class="kc">false</span>
                <span class="k">for</span> <span class="nx">postfix</span> <span class="k">in</span> <span class="nx">twitterPostfixes</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">originalUrl</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">postfix</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                        <span class="nv">isTwitterAvatar = </span><span class="kc">true</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="nx">isTwitterAvatar</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>Load the low-res avatar for smooth experience, but
prepare to replace it with the appropriate res version.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nv">fastAvatar = </span><span class="nx">originalUrl</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">postfix</span><span class="p">,</span> <span class="s">&#39;_mini&#39;</span>
                    <span class="nv">appropriateUrl = </span><span class="nx">originalUrl</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">postfix</span><span class="p">,</span>
                        <span class="nx">options</span><span class="p">.</span><span class="nx">twitterAvatarSize</span>
                    <span class="nx">$image</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&#39;src&#39;</span><span class="p">,</span> <span class="nx">fastAvatar</span>
                <span class="k">else</span>
                    <span class="nv">appropriateUrl = </span><span class="nx">originalUrl</span>

                <span class="p">(</span><span class="nx">$clone</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&#39;src&#39;</span><span class="p">,</span> <span class="nx">appropriateUrl</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">load</span> <span class="nf">-&gt;</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>Mark the image tag as loaded by adding setting a class.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">$clone</span><span class="p">.</span><span class="nx">addClass</span> <span class="nx">CLASS_IMG_LOADED</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>Ensures indempotency. If this helper is used multiple
times on the same template, it will not reload images.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">$clone</span><span class="p">.</span><span class="nx">removeAttr</span> <span class="s">&#39;data-src&#39;</span>
                        <span class="nx">$image</span><span class="p">.</span><span class="nx">replaceWith</span> <span class="nx">$clone</span>
                        <span class="nx">options</span><span class="p">.</span><span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">$clone</span>
                    <span class="p">.</span><span class="nx">error</span> <span class="nf">-&gt;</span>
                        <span class="nx">options</span><span class="p">.</span><span class="nx">callback</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;could not load image&#39;</span><span class="p">),</span> <span class="nx">$image</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Mon Aug 05 2013 15:56:43 GMT+0300 (EEST)  </div></div></body></html>