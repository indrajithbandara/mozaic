<!DOCTYPE html><html><head><title>loader.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../index.html" class="source"><span class="file_name">README</span></a><a href="../core~/api_mock.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">api_mock.coffee</span></a><a href="../core~/application_controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">application_controller.coffee</span></a><a href="../core~/auth.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">auth.coffee</span></a><a href="../core~/base_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_collection.coffee</span></a><a href="../core~/base_model.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_model.coffee</span></a><a href="../core~/base_widgets/autocomplete.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">autocomplete.coffee</span></a><a href="../core~/base_widgets/base_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">base_form.coffee</span></a><a href="../core~/base_widgets/delete_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">delete_form.coffee</span></a><a href="../core~/base_widgets/expanding_list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">expanding_list.coffee</span></a><a href="../core~/base_widgets/item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">item_count.coffee</span></a><a href="../core~/base_widgets/list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">list.coffee</span></a><a href="../core~/base_widgets/mediator_widget.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">mediator_widget.coffee</span></a><a href="../core~/base_widgets/nested_attributes_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">nested_attributes_form.coffee</span></a><a href="../core~/base_widgets/new_items_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">new_items_count.coffee</span></a><a href="../core~/base_widgets/notification_bar.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notification_bar.coffee</span></a><a href="../core~/base_widgets/notifications.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notifications.coffee</span></a><a href="../core~/base_widgets/order_by.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">order_by.coffee</span></a><a href="../core~/base_widgets/update_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">update_form.coffee</span></a><a href="../core~/base_widgets/url.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">url.coffee</span></a><a href="../core~/base_widgets/user_item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">user_item_count.coffee</span></a><a href="../core~/base_widgets/widget_editor.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">widget_editor.coffee</span></a><a href="../core~/channels_utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">channels_utils.coffee</span></a><a href="../core~/constants.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">constants.coffee</span></a><a href="../core~/context_processors.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">context_processors.coffee</span></a><a href="../core~/controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">controller.coffee</span></a><a href="../core~/core_modules.js.html" class="source "><span class="base_path">core~ / </span><span class="file_name">core_modules.js</span></a><a href="../core~/datasource/channel/create.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">create.coffee</span></a><a href="../core~/datasource/channel/destroy.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">destroy.coffee</span></a><a href="../core~/datasource/channel/read.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">read.coffee</span></a><a href="../core~/datasource/channel/update.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">update.coffee</span></a><a href="../core~/datasource/channel.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">channel.coffee</span></a><a href="../core~/datasource/datasource.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">datasource.coffee</span></a><a href="../core~/datasource/gc.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">gc.coffee</span></a><a href="../core~/datasource/refresher.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">refresher.coffee</span></a><a href="../core~/datasource/scheduler.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">scheduler.coffee</span></a><a href="../core~/datasource/widget.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">widget.coffee</span></a><a href="../core~/flags_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">flags_collection.coffee</span></a><a href="../core~/interceptor.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">interceptor.coffee</span></a><a href="../core~/layout.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">layout.coffee</span></a><a href="../core~/loader.coffee.html" class="source selected"><span class="base_path">core~ / </span><span class="file_name">loader.coffee</span></a><a href="../core~/loading_animation.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loading_animation.coffee</span></a><a href="../core~/logging/sentry_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">sentry_logger.coffee</span></a><a href="../core~/logging/standard_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">standard_logger.coffee</span></a><a href="../core~/mocks.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mocks.coffee</span></a><a href="../core~/modal_window.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">modal_window.coffee</span></a><a href="../core~/module.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">module.coffee</span></a><a href="../core~/mozaic_backbone_form.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mozaic_backbone_form.coffee</span></a><a href="../core~/profiler.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">profiler.coffee</span></a><a href="../core~/pubsub.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">pubsub.coffee</span></a><a href="../core~/raw_data.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">raw_data.coffee</span></a><a href="../core~/router.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">router.coffee</span></a><a href="../core~/scrollable_widget.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">scrollable_widget.coffee</span></a><a href="../core~/utils/dom.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">dom.coffee</span></a><a href="../core~/utils/images.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">images.coffee</span></a><a href="../core~/utils/misc.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">misc.coffee</span></a><a href="../core~/utils/mozaic.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">mozaic.coffee</span></a><a href="../core~/utils/time.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">time.coffee</span></a><a href="../core~/utils/urls.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">urls.coffee</span></a><a href="../core~/utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">utils.coffee</span></a><a href="../core~/widget/aggregated_channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">aggregated_channels.coffee</span></a><a href="../core~/widget/backbone_events.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">backbone_events.coffee</span></a><a href="../core~/widget/channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">channels.coffee</span></a><a href="../core~/widget/modal_widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">modal_widget.coffee</span></a><a href="../core~/widget/params.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">params.coffee</span></a><a href="../core~/widget/rendering.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">rendering.coffee</span></a><a href="../core~/widget/states.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">states.coffee</span></a><a href="../core~/widget/widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">widget.coffee</span></a><a href="../core~/widget_starter.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">widget_starter.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>loader.coffee</h1><div class="filepath">core~/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div><p>Loader component which is concerned with modules / widgets updating.</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">define</span> <span class="p">[],</span> <span class="p">()</span> <span class="nf">-&gt;</span>

    <span class="k">if</span> <span class="o">not</span> <span class="nx">Handlebars</span><span class="p">.</span><span class="nx">templates</span>
        <span class="nv">Handlebars.templates = </span><span class="p">{}</span>

    <span class="nv">loader =</span>
        <span class="nv">modules: </span><span class="p">{}</span>
        <span class="nv">widgets: </span><span class="p">{}</span>
        <span class="nv">born_dead: </span><span class="p">{}</span>

        <span class="nv">normalize_path: </span><span class="nf">(path) -&gt;</span>
            <span class="k">if</span> <span class="nx">path</span><span class="o">?</span>
                <span class="k">return</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">path</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/cs!/</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s">&quot;</span>

        <span class="nv">widget_path: </span><span class="nf">(name) -&gt;</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>Only add widget prefix if not base widget module</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="k">if</span> <span class="nx">name</span> <span class="o">is</span> <span class="s">&#39;widget&#39;</span> <span class="k">then</span> <span class="s">&#39;cs!widget&#39;</span> <span class="k">else</span> <span class="s">&quot;cs!widget/</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span>

        <span class="nv">load_module: </span><span class="nf">(original_path, callback=null, instantiate=true, params...) -&gt;</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Load a module at a given path</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">path = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">normalize_path</span><span class="p">(</span><span class="nx">original_path</span><span class="p">)</span>

            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Loading module </span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span>

            <span class="nx">require</span> <span class="p">[</span><span class="nx">original_path</span><span class="p">],</span> <span class="nf">(Module) -&gt;</span>
                <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">path</span> <span class="k">of</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">)</span>
                    <span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nv">module: </span><span class="nx">Module</span><span class="p">}</span>
                <span class="k">if</span> <span class="nx">instantiate</span>
                    <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">path</span><span class="p">][</span><span class="s">&#39;instance&#39;</span><span class="p">])</span>
                        <span class="nv">instance = </span><span class="nx">Utils</span><span class="p">.</span><span class="nx">createModuleInstance</span><span class="p">(</span><span class="nx">Module</span><span class="p">,</span> <span class="nx">params</span><span class="p">...)</span>
                        <span class="nx">instance</span><span class="p">.</span><span class="nx">initialize</span><span class="p">()</span>
                        <span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">path</span><span class="p">][</span><span class="s">&#39;instance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">instance</span>
                    <span class="k">else</span>
                        <span class="nv">instance = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">path</span><span class="p">][</span><span class="s">&#39;instance&#39;</span><span class="p">]</span>
                <span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">path</span><span class="p">][</span><span class="s">&#39;running&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>Execute the callback with instance if instantiate was enabled
or without any params if we only wished to load the module code.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="nx">instantiate</span>
                    <span class="nx">callback</span><span class="p">(</span><span class="nx">instance</span><span class="p">)</span> <span class="k">if</span> <span class="nx">callback</span>
                <span class="k">else</span>
                    <span class="nx">callback</span><span class="p">()</span> <span class="k">if</span> <span class="nx">callback</span>

        <span class="nv">load_modules: </span><span class="nf">(paths, callback=null, instantiate=true) -&gt;</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>Load multiple modules given their paths.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>The callback is called once <strong>all</strong> modules are loaded.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Make a request to require.js to load the modules with all their dependencies</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">require</span> <span class="nx">paths</span><span class="p">,</span> <span class="nf">(modules...) =&gt;</span>
                <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">paths</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="nv">path = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">normalize_path</span><span class="p">(</span><span class="nx">paths</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
                    <span class="nv">Module = </span><span class="nx">modules</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Initialize the registry of modules for the current module</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">path</span> <span class="k">of</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">)</span>
                        <span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">path</span><span class="p">].</span><span class="nv">module = </span><span class="nx">Module</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>If we should instantiate this module and there isn't
already an instance, create it</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="nx">instantiate</span> <span class="o">and</span> <span class="o">not</span> <span class="p">(</span><span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">path</span><span class="p">][</span><span class="s">&#39;instance&#39;</span><span class="p">])</span>
                        <span class="nv">instance = </span><span class="nx">Utils</span><span class="p">.</span><span class="nx">createModuleInstance</span><span class="p">(</span><span class="nx">Module</span><span class="p">)</span>
                        <span class="nx">instance</span><span class="p">.</span><span class="nx">initialize</span><span class="p">()</span>
                        <span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">path</span><span class="p">][</span><span class="s">&#39;instance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">instance</span>
                    <span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">path</span><span class="p">][</span><span class="s">&#39;running&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>Run the callback if there is one, when all the modules have been loaded.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="nx">instantiate</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>If instantiate was enabled, we will build a list of all instances
of the modules (not just the ones that have been loaded this time,
but also the ones that were already loaded).</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nv">instances = </span><span class="p">[</span><span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">loader</span><span class="p">.</span><span class="nx">normalize_path</span><span class="p">(</span><span class="nx">path</span><span class="p">)][</span><span class="s">&#39;instance&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="nx">path</span> <span class="k">in</span> <span class="nx">paths</span><span class="p">]</span>
                    <span class="nx">callback</span><span class="p">(</span><span class="nx">instances</span><span class="p">...)</span> <span class="k">if</span> <span class="nx">callback</span>
                <span class="k">else</span>
                    <span class="nx">callback</span><span class="p">()</span> <span class="k">if</span> <span class="nx">callback</span>

        <span class="nv">unload_module: </span><span class="nf">(original_path, callback = null) -&gt;</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>Unload a module at a given path</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">path = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">normalize_path</span><span class="p">(</span><span class="nx">original_path</span><span class="p">)</span>

            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Unloading module </span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span>
            <span class="k">if</span> <span class="o">not</span> <span class="nx">path</span> <span class="k">of</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span>
                <span class="k">return</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Destroy the instance if there is one</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">path</span><span class="p">][</span><span class="s">&#39;instance&#39;</span><span class="p">]</span>
                <span class="nv">instance = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">path</span><span class="p">][</span><span class="s">&#39;instance&#39;</span><span class="p">]</span>
                <span class="nx">instance</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span>
            <span class="k">delete</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="k">if</span> <span class="nx">callback</span>

        <span class="nv">get_module: </span><span class="nf">(original_path) -&gt;</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>Getting an instatiated module</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">path = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">normalize_path</span><span class="p">(</span><span class="nx">original_path</span><span class="p">)</span>

            <span class="k">if</span> <span class="nx">path</span> <span class="k">of</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span> <span class="o">and</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">path</span><span class="p">].</span><span class="nx">running</span>
                <span class="k">return</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">path</span><span class="p">].</span><span class="nx">instance</span>
            <span class="k">else</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&quot;Trying to get unavailable module </span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span>

        <span class="nv">instantiate_widget: </span><span class="nf">(name, id, params) -&gt;</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>Instantiates a given widget, when we know for a fact that its
code has been loaded client-side.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">path = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">normalize_path</span><span class="p">(</span><span class="nx">loader</span><span class="p">.</span><span class="nx">widget_path</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span>

            <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">path</span> <span class="k">of</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">)</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;Trying to instantiate a widget that hasn&#39;t been loaded: </span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span>
                <span class="k">return</span>

            <span class="nv">Module = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">modules</span><span class="p">[</span><span class="nx">path</span><span class="p">][</span><span class="s">&#39;module&#39;</span><span class="p">]</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>Check if widget has also template<em>name declaration.
If it does, also load the template.
TODO: refactor load</em>modules so that it supports params as well,
      so we can take advantage of parallel loading for the
      widget code and its template.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">template_name = </span><span class="nx">params</span><span class="p">.</span><span class="nx">template_name</span> <span class="o">or</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">template_name</span>
            <span class="k">if</span> <span class="nx">template_name</span>
                <span class="nx">loader</span><span class="p">.</span><span class="nx">load_template</span><span class="p">(</span><span class="nx">template_name</span><span class="p">,</span> <span class="nf">(tpl) -&gt;</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>Don't instantiate widgets which should have already been
garbage collected.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">born_dead</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
                        <span class="nv">cloned_params = </span><span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>
                        <span class="k">delete</span> <span class="nx">cloned_params</span><span class="p">[</span><span class="s">&#39;el&#39;</span><span class="p">]</span>
                        <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s">&quot;Widget with id </span><span class="si">#{</span><span class="nx">id</span><span class="si">}</span><span class="s"> was born dead (params = </span><span class="si">#{</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">cloned_params</span><span class="p">)</span><span class="si">}</span><span class="s">). You&#39;re doing something wrong.&quot;</span><span class="p">)</span>
                        <span class="k">delete</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">born_dead</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
                        <span class="k">return</span>
                    <span class="nx">loader</span><span class="p">.</span><span class="nx">widgets</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Utils</span><span class="p">.</span><span class="nx">createModuleInstance</span><span class="p">(</span><span class="nx">Module</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">tpl</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>Don't instantiate widgets which should have already been
garbage collected.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">born_dead</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
                    <span class="nv">cloned_params = </span><span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>
                    <span class="k">delete</span> <span class="nx">cloned_params</span><span class="p">[</span><span class="s">&#39;el&#39;</span><span class="p">]</span>
                    <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s">&quot;Widget with id </span><span class="si">#{</span><span class="nx">id</span><span class="si">}</span><span class="s"> was born dead (params = </span><span class="si">#{</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">cloned_params</span><span class="p">)</span><span class="si">}</span><span class="s">). You&#39;re doing something wrong.&quot;</span><span class="p">)</span>
                    <span class="k">delete</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">born_dead</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
                    <span class="k">return</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p>We don't need to fire initialize() here because the
base method Widget.constructor() does.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">loader</span><span class="p">.</span><span class="nx">widgets</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Utils</span><span class="p">.</span><span class="nx">createModuleInstance</span><span class="p">(</span><span class="nx">Module</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span>

        <span class="nv">load_widget: </span><span class="nf">(name, id, params) -&gt;</span></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>Load a given widget given its name and a unique ID to identify
it system-wide. This ID will usually be a combination between
the name of the template and the name of the widget.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>The path will always be "widget/<name>", which should be configured
in the require.js configuration to point to the correct file.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Loading widget </span><span class="si">#{</span><span class="nx">id</span><span class="si">}</span><span class="s"> (name = </span><span class="si">#{</span><span class="nx">name</span> <span class="si">}</span><span class="s">)&quot;</span>
            <span class="nv">path = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">widget_path</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>

            <span class="nv">callback = </span><span class="o">=&gt;</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">instantiate_widget</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span>
            <span class="nx">loader</span><span class="p">.</span><span class="nx">load_module</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>

        <span class="nv">unload_widget: </span><span class="nf">(id) -&gt;</span></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><p>Unload a widget given its id</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Unloading widget </span><span class="si">#{</span><span class="nx">id</span><span class="si">}</span><span class="s">&quot;</span>

        <span class="nv">mark_as_detached: </span><span class="nf">(widget_id) -&gt;</span></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><p>Marks a widget as being detached from the DOM. This is an
intermediary state while the widget is waiting to be garbage
collected and it should not receive any data events while
in this state.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">widgets</span><span class="p">[</span><span class="nx">widget_id</span><span class="p">]</span>
                <span class="nx">loader</span><span class="p">.</span><span class="nx">widgets</span><span class="p">[</span><span class="nx">widget_id</span><span class="p">].</span><span class="nx">startBeingDetached</span><span class="p">()</span>
            <span class="k">else</span>
                <span class="nx">loader</span><span class="p">.</span><span class="nx">born_dead</span><span class="p">[</span><span class="nx">widget_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>

        <span class="nv">destroy_widget: </span><span class="nf">(widget_id) -&gt;</span>
            <span class="k">if</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">widgets</span><span class="p">[</span><span class="nx">widget_id</span><span class="p">]</span>
                <span class="nx">loader</span><span class="p">.</span><span class="nx">widgets</span><span class="p">[</span><span class="nx">widget_id</span><span class="p">].</span><span class="nx">destroy</span><span class="p">()</span>
                <span class="k">delete</span> <span class="nx">loader</span><span class="p">.</span><span class="nx">widgets</span><span class="p">[</span><span class="nx">widget_id</span><span class="p">]</span>
            <span class="k">else</span>
                <span class="nx">loader</span><span class="p">.</span><span class="nx">born_dead</span><span class="p">[</span><span class="nx">widget_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>

        <span class="nv">get_widgets: </span><span class="nf">-&gt;</span>
            <span class="nx">loader</span><span class="p">.</span><span class="nx">widgets</span>

        <span class="nv">load_template: </span><span class="nf">(template_name, callback) -&gt;</span>
            <span class="k">if</span> <span class="nx">template_name</span><span class="o">?</span>
                <span class="nv">template_path = </span><span class="s">&#39;text!&#39;</span> <span class="o">+</span> <span class="nx">template_name</span>
            <span class="k">else</span></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>No need to return the callback if the temple_name is invalid</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">return</span>

            <span class="k">if</span> <span class="nx">App</span><span class="p">.</span><span class="nx">general</span><span class="p">.</span><span class="nx">USE_PRECOMPILED_TEMPLATES</span>
                <span class="nv">tpl_suffix = </span><span class="nx">template_name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="nx">tpl_suffix</span> <span class="o">==</span> <span class="s">&#39;hjs&#39;</span>
                    <span class="nv">template_path = </span><span class="nx">template_name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;js&#39;</span>
                <span class="k">else</span>
                    <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s">&quot;Trying to load an invalid template with name </span><span class="si">#{</span><span class="nx">template_name</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="nx">require</span> <span class="p">[</span><span class="nx">template_path</span><span class="p">],</span> <span class="nf">(tpl) -&gt;</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><p>If the template is served in production and is precompiled,
send the precompiled version</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="nx">App</span><span class="p">.</span><span class="nx">general</span><span class="p">.</span><span class="nx">USE_PRECOMPILED_TEMPLATES</span>
                    <span class="nx">callback</span><span class="p">(</span><span class="nx">Handlebars</span><span class="p">.</span><span class="nx">templates</span><span class="p">[</span><span class="nx">template_name</span><span class="p">])</span>
                <span class="k">else</span></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><p>Cache the compiled version and send it to the callback</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="o">not</span> <span class="nx">Handlebars</span><span class="p">.</span><span class="nx">templates</span><span class="p">[</span><span class="nx">template_name</span><span class="p">]</span>
                        <span class="nx">Handlebars</span><span class="p">.</span><span class="nx">templates</span><span class="p">[</span><span class="nx">template_name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Handlebars</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">tpl</span><span class="p">)</span>

                    <span class="nx">callback</span><span class="p">(</span><span class="nx">Handlebars</span><span class="p">.</span><span class="nx">templates</span><span class="p">[</span><span class="nx">template_name</span><span class="p">])</span>

    <span class="nb">window</span><span class="p">.</span><span class="nv">loader = </span><span class="nx">loader</span>
    <span class="k">return</span> <span class="nx">loader</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Mon Aug 05 2013 15:56:39 GMT+0300 (EEST)  </div></div></body></html>