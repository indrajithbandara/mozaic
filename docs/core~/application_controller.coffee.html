<!DOCTYPE html><html><head><title>application_controller.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../index.html" class="source"><span class="file_name">README</span></a><a href="../core~/api_mock.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">api_mock.coffee</span></a><a href="../core~/application_controller.coffee.html" class="source selected"><span class="base_path">core~ / </span><span class="file_name">application_controller.coffee</span></a><a href="../core~/auth.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">auth.coffee</span></a><a href="../core~/base_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_collection.coffee</span></a><a href="../core~/base_model.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_model.coffee</span></a><a href="../core~/base_widgets/autocomplete.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">autocomplete.coffee</span></a><a href="../core~/base_widgets/base_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">base_form.coffee</span></a><a href="../core~/base_widgets/delete_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">delete_form.coffee</span></a><a href="../core~/base_widgets/expanding_list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">expanding_list.coffee</span></a><a href="../core~/base_widgets/item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">item_count.coffee</span></a><a href="../core~/base_widgets/list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">list.coffee</span></a><a href="../core~/base_widgets/mediator_widget.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">mediator_widget.coffee</span></a><a href="../core~/base_widgets/nested_attributes_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">nested_attributes_form.coffee</span></a><a href="../core~/base_widgets/new_items_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">new_items_count.coffee</span></a><a href="../core~/base_widgets/notification_bar.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notification_bar.coffee</span></a><a href="../core~/base_widgets/notifications.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notifications.coffee</span></a><a href="../core~/base_widgets/order_by.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">order_by.coffee</span></a><a href="../core~/base_widgets/update_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">update_form.coffee</span></a><a href="../core~/base_widgets/url.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">url.coffee</span></a><a href="../core~/base_widgets/user_item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">user_item_count.coffee</span></a><a href="../core~/base_widgets/widget_editor.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">widget_editor.coffee</span></a><a href="../core~/channels_utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">channels_utils.coffee</span></a><a href="../core~/constants.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">constants.coffee</span></a><a href="../core~/context_processors.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">context_processors.coffee</span></a><a href="../core~/controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">controller.coffee</span></a><a href="../core~/core_modules.js.html" class="source "><span class="base_path">core~ / </span><span class="file_name">core_modules.js</span></a><a href="../core~/datasource/channel/create.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">create.coffee</span></a><a href="../core~/datasource/channel/destroy.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">destroy.coffee</span></a><a href="../core~/datasource/channel/read.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">read.coffee</span></a><a href="../core~/datasource/channel/update.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">update.coffee</span></a><a href="../core~/datasource/channel.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">channel.coffee</span></a><a href="../core~/datasource/datasource.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">datasource.coffee</span></a><a href="../core~/datasource/gc.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">gc.coffee</span></a><a href="../core~/datasource/refresher.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">refresher.coffee</span></a><a href="../core~/datasource/scheduler.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">scheduler.coffee</span></a><a href="../core~/datasource/widget.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">widget.coffee</span></a><a href="../core~/flags_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">flags_collection.coffee</span></a><a href="../core~/interceptor.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">interceptor.coffee</span></a><a href="../core~/layout.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">layout.coffee</span></a><a href="../core~/loader.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loader.coffee</span></a><a href="../core~/loading_animation.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loading_animation.coffee</span></a><a href="../core~/logging/sentry_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">sentry_logger.coffee</span></a><a href="../core~/logging/standard_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">standard_logger.coffee</span></a><a href="../core~/mocks.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mocks.coffee</span></a><a href="../core~/modal_window.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">modal_window.coffee</span></a><a href="../core~/module.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">module.coffee</span></a><a href="../core~/mozaic_backbone_form.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mozaic_backbone_form.coffee</span></a><a href="../core~/profiler.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">profiler.coffee</span></a><a href="../core~/pubsub.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">pubsub.coffee</span></a><a href="../core~/raw_data.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">raw_data.coffee</span></a><a href="../core~/router.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">router.coffee</span></a><a href="../core~/scrollable_widget.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">scrollable_widget.coffee</span></a><a href="../core~/utils/dom.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">dom.coffee</span></a><a href="../core~/utils/images.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">images.coffee</span></a><a href="../core~/utils/misc.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">misc.coffee</span></a><a href="../core~/utils/mozaic.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">mozaic.coffee</span></a><a href="../core~/utils/time.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">time.coffee</span></a><a href="../core~/utils/urls.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">urls.coffee</span></a><a href="../core~/utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">utils.coffee</span></a><a href="../core~/widget/aggregated_channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">aggregated_channels.coffee</span></a><a href="../core~/widget/backbone_events.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">backbone_events.coffee</span></a><a href="../core~/widget/channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">channels.coffee</span></a><a href="../core~/widget/modal_widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">modal_widget.coffee</span></a><a href="../core~/widget/params.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">params.coffee</span></a><a href="../core~/widget/rendering.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">rendering.coffee</span></a><a href="../core~/widget/states.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">states.coffee</span></a><a href="../core~/widget/widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">widget.coffee</span></a><a href="../core~/widget_starter.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">widget_starter.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>application_controller.coffee</h1><div class="filepath">core~/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span><span class="s">&#39;cs!layout&#39;</span><span class="p">,</span> <span class="s">&#39;cs!mozaic_module&#39;</span><span class="p">],</span> <span class="nf">(Layout, Module) -&gt;</span>
    <span class="nv">injectControllerInterval = </span><span class="kc">null</span>

    <span class="k">class</span> <span class="nx">ApplicationController</span> <span class="k">extends</span> <span class="nx">Module</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>Layout-based controller</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">constructor: </span><span class="nf">(page_template) -&gt;</span>
            <span class="k">super</span><span class="p">()</span>
            <span class="vi">@page_template = </span><span class="nx">page_template</span>

        <span class="nv">initialize: </span><span class="o">=&gt;</span>

        <span class="nv">renderLayout: </span><span class="nf">(layout_params = {}, stringify = true) =&gt;</span>
            <span class="vi">@layout = </span><span class="k">new</span> <span class="nx">Layout</span><span class="p">(</span><span class="nx">@page_template</span><span class="p">,</span> <span class="nx">layout_params</span><span class="p">)</span>
            <span class="nx">@layout</span><span class="p">.</span><span class="nx">renderHTML</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">stringify</span><span class="p">)</span>

        <span class="nv">action: </span><span class="nf">(controller, params, injectControllerCallback, deleteControllerCallback) =&gt;</span>
            <span class="nx">@renderLayout</span><span class="p">()</span>
            <span class="nx">deleteControllerCallback</span><span class="p">()</span>
            <span class="nx">injectControllerCallback</span><span class="p">()</span>

        <span class="nv">bootstrapModules: </span><span class="nf">-&gt;</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Return the current modules that should be started
at the bootstrap process. In particular, this means
that you can customize the list in your own derived
application controller.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">modules = </span><span class="p">[</span><span class="s">&#39;cs!datasource&#39;</span><span class="p">,</span> <span class="s">&#39;cs!loading_animation&#39;</span><span class="p">,</span> <span class="s">&#39;cs!modal_window&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nx">App</span><span class="p">.</span><span class="nx">general</span><span class="p">.</span><span class="nx">ENABLE_PROFILING</span> <span class="k">then</span> <span class="nx">modules</span><span class="p">.</span><span class="nx">push</span> <span class="s">&#39;cs!profiler&#39;</span>
            <span class="k">return</span> <span class="nx">modules</span>

        <span class="nv">injectController: </span><span class="nf">(new_controller_config, controller_params) =&gt;</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><h1>TODO(andrei): very very strange bug causing the code</h1>

<p>to not see the $('#controller-container') div although
it's right there in the DOM. We keep waiting in 20ms
increments until it's there.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#controller-container&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">injectControllerInterval</span><span class="p">)</span>
                <span class="nx">Utils</span><span class="p">.</span><span class="nx">injectWidget</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#controller-container&#39;</span><span class="p">),</span>
                                   <span class="nx">new_controller_config</span><span class="p">.</span><span class="nx">controller</span><span class="p">,</span>
                                   <span class="nx">controller_params</span><span class="p">,</span>
                                   <span class="nx">new_controller_config</span><span class="p">.</span><span class="nx">controller</span><span class="p">)</span>

        <span class="nv">new_controller: </span><span class="nf">(new_controller_config, url_params) =&gt;</span>
            <span class="nx">loader</span><span class="p">.</span><span class="nx">load_modules</span> <span class="p">[</span><span class="s">&#39;cs!pubsub&#39;</span><span class="p">],</span> <span class="o">=&gt;</span>
                <span class="nx">loader</span><span class="p">.</span><span class="nx">load_modules</span> <span class="p">[</span><span class="s">&#39;cs!widget_starter&#39;</span><span class="p">],</span> <span class="o">=&gt;</span>
                    <span class="nx">loader</span><span class="p">.</span><span class="nx">load_modules</span> <span class="nx">@bootstrapModules</span><span class="p">(),</span> <span class="o">=&gt;</span>

                        <span class="nv">inject_callback = </span><span class="nf">(extra_params) =&gt;</span>
                            <span class="nv">controller_params =</span>
                                <span class="nv">config: </span><span class="nx">new_controller_config</span>
                                <span class="nv">url_params: </span><span class="nx">url_params</span>
                                <span class="nv">template_name: </span><span class="nx">new_controller_config</span><span class="p">.</span><span class="nx">layout</span>
                                <span class="nv">channels: </span><span class="nx">@controller_channels</span>
                            <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">controller_params</span><span class="p">,</span> <span class="nx">extra_params</span><span class="p">)</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>Scroll to the top of the viewport before injecting
the controller. When going from controller to controller
the scroll is kept and this triggers a weird behaviour
when you go from scrolled mentions to the analytics section:
no analytics shown, but if you scroll to the top you can
see it</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="nb">window</span><span class="p">.</span><span class="nx">scrollTo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Because the callback is called too soon, the DOM may not be
ready sometimes. Just to be sure that an element with id
controller-container is present in the DOM</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="nv">injectControllerInterval = </span><span class="nx">setInterval</span><span class="p">(</span> <span class="o">=&gt;</span>
                                    <span class="nx">@injectController</span><span class="p">(</span><span class="nx">new_controller_config</span><span class="p">,</span>
                                                      <span class="nx">controller_params</span><span class="p">)</span>
                                <span class="p">,</span> <span class="mi">20</span>
                            <span class="p">)</span>

                        <span class="nv">delete_callback = </span><span class="o">=&gt;</span>
                            <span class="nv">controller = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#controller-container&#39;</span><span class="p">)</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Emptying $('#controller-container') might not
be synchronous with the call to
widget_starter.checkRemovedNode()
because on IE we're using setTimeout() in order
to check for disappeared widgets. This is why
we will manually call it, to ensure that it
gets called before the next controller gets
injected.</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="nv">widget_starter = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">get_module</span><span class="p">(</span><span class="s">&#39;widget_starter&#39;</span><span class="p">)</span>
                            <span class="nx">widget_starter</span><span class="p">.</span><span class="nx">checkRemovedNode</span><span class="p">(</span><span class="nx">controller</span><span class="p">)</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>The previous call marked the widgets as detached
from DOM, but this didn't correspond to reality.
Make this right ASAP :)</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="nx">controller</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>Calling checkRemovedNode() only marks widgets
for GC, but the next round of GC will be run
asynchronously, and we need to forcedly GC
"urgent<em>for</em>gc" widgets (such as mediators)
that can mess the transition from one controller
to another. Therefore, we manually call GC
and know for sure that these guys will be put to
sleep NOW :)</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="nx">widget_starter</span><span class="p">.</span><span class="nx">garbageCollectWidgets</span><span class="p">()</span>

                        <span class="nx">@action</span><span class="p">(</span><span class="nx">new_controller_config</span><span class="p">,</span> <span class="nx">url_params</span><span class="p">,</span>
                                <span class="nx">inject_callback</span><span class="p">,</span> <span class="nx">delete_callback</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">ApplicationController</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Mon Aug 05 2013 15:56:29 GMT+0300 (EEST)  </div></div></body></html>