<!DOCTYPE html><html><head><title>loading_animation.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../index.html" class="source"><span class="file_name">README</span></a><a href="../core~/api_mock.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">api_mock.coffee</span></a><a href="../core~/application_controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">application_controller.coffee</span></a><a href="../core~/auth.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">auth.coffee</span></a><a href="../core~/base_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_collection.coffee</span></a><a href="../core~/base_model.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_model.coffee</span></a><a href="../core~/base_widgets/autocomplete.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">autocomplete.coffee</span></a><a href="../core~/base_widgets/base_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">base_form.coffee</span></a><a href="../core~/base_widgets/delete_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">delete_form.coffee</span></a><a href="../core~/base_widgets/expanding_list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">expanding_list.coffee</span></a><a href="../core~/base_widgets/item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">item_count.coffee</span></a><a href="../core~/base_widgets/list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">list.coffee</span></a><a href="../core~/base_widgets/mediator_widget.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">mediator_widget.coffee</span></a><a href="../core~/base_widgets/nested_attributes_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">nested_attributes_form.coffee</span></a><a href="../core~/base_widgets/new_items_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">new_items_count.coffee</span></a><a href="../core~/base_widgets/notification_bar.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notification_bar.coffee</span></a><a href="../core~/base_widgets/notifications.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notifications.coffee</span></a><a href="../core~/base_widgets/order_by.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">order_by.coffee</span></a><a href="../core~/base_widgets/update_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">update_form.coffee</span></a><a href="../core~/base_widgets/url.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">url.coffee</span></a><a href="../core~/base_widgets/user_item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">user_item_count.coffee</span></a><a href="../core~/base_widgets/widget_editor.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">widget_editor.coffee</span></a><a href="../core~/channels_utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">channels_utils.coffee</span></a><a href="../core~/constants.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">constants.coffee</span></a><a href="../core~/context_processors.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">context_processors.coffee</span></a><a href="../core~/controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">controller.coffee</span></a><a href="../core~/core_modules.js.html" class="source "><span class="base_path">core~ / </span><span class="file_name">core_modules.js</span></a><a href="../core~/datasource/channel/create.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">create.coffee</span></a><a href="../core~/datasource/channel/destroy.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">destroy.coffee</span></a><a href="../core~/datasource/channel/read.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">read.coffee</span></a><a href="../core~/datasource/channel/update.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">update.coffee</span></a><a href="../core~/datasource/channel.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">channel.coffee</span></a><a href="../core~/datasource/datasource.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">datasource.coffee</span></a><a href="../core~/datasource/gc.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">gc.coffee</span></a><a href="../core~/datasource/refresher.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">refresher.coffee</span></a><a href="../core~/datasource/scheduler.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">scheduler.coffee</span></a><a href="../core~/datasource/widget.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">widget.coffee</span></a><a href="../core~/flags_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">flags_collection.coffee</span></a><a href="../core~/interceptor.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">interceptor.coffee</span></a><a href="../core~/layout.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">layout.coffee</span></a><a href="../core~/loader.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loader.coffee</span></a><a href="../core~/loading_animation.coffee.html" class="source selected"><span class="base_path">core~ / </span><span class="file_name">loading_animation.coffee</span></a><a href="../core~/logging/sentry_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">sentry_logger.coffee</span></a><a href="../core~/logging/standard_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">standard_logger.coffee</span></a><a href="../core~/mocks.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mocks.coffee</span></a><a href="../core~/modal_window.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">modal_window.coffee</span></a><a href="../core~/module.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">module.coffee</span></a><a href="../core~/mozaic_backbone_form.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mozaic_backbone_form.coffee</span></a><a href="../core~/profiler.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">profiler.coffee</span></a><a href="../core~/pubsub.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">pubsub.coffee</span></a><a href="../core~/raw_data.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">raw_data.coffee</span></a><a href="../core~/router.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">router.coffee</span></a><a href="../core~/scrollable_widget.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">scrollable_widget.coffee</span></a><a href="../core~/utils/dom.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">dom.coffee</span></a><a href="../core~/utils/images.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">images.coffee</span></a><a href="../core~/utils/misc.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">misc.coffee</span></a><a href="../core~/utils/mozaic.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">mozaic.coffee</span></a><a href="../core~/utils/time.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">time.coffee</span></a><a href="../core~/utils/urls.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">urls.coffee</span></a><a href="../core~/utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">utils.coffee</span></a><a href="../core~/widget/aggregated_channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">aggregated_channels.coffee</span></a><a href="../core~/widget/backbone_events.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">backbone_events.coffee</span></a><a href="../core~/widget/channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">channels.coffee</span></a><a href="../core~/widget/modal_widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">modal_widget.coffee</span></a><a href="../core~/widget/params.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">params.coffee</span></a><a href="../core~/widget/rendering.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">rendering.coffee</span></a><a href="../core~/widget/states.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">states.coffee</span></a><a href="../core~/widget/widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">widget.coffee</span></a><a href="../core~/widget_starter.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">widget_starter.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>loading_animation.coffee</h1><div class="filepath">core~/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span><span class="s">&#39;cs!mozaic_module&#39;</span><span class="p">],</span> <span class="nf">(Module) -&gt;</span>
    <span class="k">class</span> <span class="nx">LoadingAnimation</span> <span class="k">extends</span> <span class="nx">Module</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>A graceful way to preload the app widgets, having a "loading"
screen that waits until widgets are being loaded in the back,
thus assuming that the widgets are not to be shown while loading
TODO: Should ignore widgets that have own loading states, they
don't need a global screen to cater for them</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>It subscribes to the /new<em>widget and /new</em>widget_rendered pubsub
channels, in order to track each created and rendered widget,
respectively.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>On an interval of LOADING<em>FINISHED</em>CHECK<em>INTERVAL, it repeatedly
checks what's the current loading progress of the entire app, based
on a (highly) estimative logic:
- With each interval iteration, the list of widgets that have
been triggered as created, but not yet rendered, are collected.
They are called "nasty widgets"
- Whenever an interation happens with zero nasty widgets, it is
considered a "success round"
- We expect MAX</em>SUCCESS<em>RENDER</em>ROUNDS <strong>consecutive</strong> success
rounds to happen before considering the app loaded and hiding
the loading animation. This translates to: we keep the loading
animation visible until at some point in time no widgets are
pending to load for a LOADING<em>FINISHED</em>CHECK<em>INTERVAL *
MAX</em>SUCCESS<em>RENDER</em>ROUNDS period of time (half a second with
the current configuration)
- In contrast, if a round with nasty widgets happens after
more than REPORT<em>NASTY</em>WIDGETS<em>INTERVAL seconds of total
loading, the current nasty widgets will be reported using error
logging, and in production the loading animation will be
forcibly removed. The last part translates to: The loading
animation can't take more than REPORT</em>NASTY<em>WIDGETS</em>INTERVAL
seconds in production (25 seconds in current configuration)</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>The formula for displaying the loading progress is just as
unpredictible:
- It estimates that 99% of the loading will take
INTERVAL<em>FOR</em>99<em>PERCENT seconds (6 seconds in current
configuration). So it loads linearly up to this point
- If it takes more than INTERVAL</em>FOR<em>99</em>PERCENT seconds, it
will be locked at 99% until the previous logic considers the
app to be loaded
- If the loading is flagged as done before
INTERVAL<em>FOR</em>99<em>PERCENT seconds have passed, the progress bar
is accelerated to 100% in order to feel natural (even though
the app is ready at this point). This fake loading compensation
can only take up to ACCELERATED</em>FINISH seconds, though (0.2
seconds in the current configuration)</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">MAX_SUCCESS_RENDER_ROUNDS: </span><span class="mi">20</span>
        <span class="nv">LOADING_FINISHED_CHECK_INTERVAL: </span><span class="mi">25</span> <span class="c1">#ms</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>List widget is allowed here as the ones with empty data will not be rendered</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">ALLOWED_TO_BE_NASTY: </span><span class="p">[</span>
            <span class="s">&#39;top_locations_filter&#39;</span><span class="p">,</span> <span class="s">&#39;current_location&#39;</span><span class="p">,</span> <span class="s">&#39;new_items&#39;</span><span class="p">,</span>
            <span class="s">&#39;item_count&#39;</span><span class="p">,</span> <span class="s">&#39;stream_info&#39;</span><span class="p">,</span> <span class="s">&#39;custom_sources_info&#39;</span><span class="p">,</span>
            <span class="s">&#39;custom_source_item&#39;</span><span class="p">,</span> <span class="s">&#39;custom_sources_list&#39;</span><span class="p">,</span> <span class="s">&#39;list&#39;</span><span class="p">,</span>
            <span class="s">&#39;signals_count&#39;</span><span class="p">,</span> <span class="s">&#39;mentions&#39;</span><span class="p">,</span> <span class="s">&#39;signals&#39;</span><span class="p">]</span>
        <span class="nv">INTERVAL_FOR_99_PERCENT: </span><span class="mi">6</span> <span class="c1"># seconds</span>
        <span class="nv">ACCELERATED_FINISH: </span><span class="mf">0.2</span> <span class="c1"># seconds at most to finish after we had a lucky streak</span>
        <span class="nv">REPORT_NASTY_WIDGETS_INTERVAL: </span><span class="mi">25</span> <span class="c1"># seconds</span>

        <span class="nv">new_widgets: </span><span class="p">[]</span>
        <span class="nv">rendered_widgets: </span><span class="p">[]</span>
        <span class="nv">success_render_rounds: </span><span class="mi">0</span>
        <span class="nv">id_to_name: </span><span class="p">{}</span>
        <span class="nv">start_time: </span><span class="mi">0</span>

        <span class="nv">constructor: </span><span class="nf">-&gt;</span>
            <span class="k">super</span><span class="p">()</span>
            <span class="nx">@updateLoadingMessage</span><span class="p">()</span>

        <span class="nv">initialize: </span><span class="o">=&gt;</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>When the loading animation module is first initialized,
it subscribes itself to widget events such as
"widget initialized" and "widget rendered", and starts checking
periodically what's in the difference of these two sets.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="vi">@pipe = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">get_module</span><span class="p">(</span><span class="s">&#39;pubsub&#39;</span><span class="p">)</span>
            <span class="nx">@pipe</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s">&#39;/new_widget&#39;</span><span class="p">,</span> <span class="nx">@newWidgetAppeared</span><span class="p">)</span>
            <span class="nx">@pipe</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s">&#39;/new_widget_rendered&#39;</span><span class="p">,</span> <span class="nx">@newWidgetRendered</span><span class="p">)</span>
            <span class="vi">@start_time = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span>
            <span class="vi">@intervalHandle = </span><span class="nx">setInterval</span><span class="p">(</span><span class="nx">@checkIfLoadingFinished</span><span class="p">,</span> <span class="nx">@LOADING_FINISHED_CHECK_INTERVAL</span><span class="p">)</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Mark the entire application as "loading"</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">App.isLoading = </span><span class="kc">true</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>If the admin changed the group, personalize
loading message.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">updateLoadingMessage: </span><span class="o">=&gt;</span>
            <span class="k">if</span> <span class="nx">Utils</span><span class="p">.</span><span class="nx">inPrintMode</span><span class="p">()</span>
                <span class="nx">$</span><span class="p">(</span><span class="s">&#39;.loading-text&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s">&#39; Generating preview...&#39;</span><span class="p">)</span>
            <span class="k">else</span> <span class="k">if</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&#39;group_id&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="nx">$</span><span class="p">(</span><span class="s">&#39;.loading-text&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s">&#39; Changing view...&#39;</span><span class="p">)</span>

        <span class="nv">newWidgetAppeared: </span><span class="nf">(message) =&gt;</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>This callback is performed whenever a new widget has appeared
in the system. Widgets are initialized by the widget starter
whenever all their channels have been initialized, and after
they have been injected into the DOM.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>We store both the widget ID and a mapping from ID to name
to use later without needing to break encapsulation and
hack into loader's internal structures to get the widget name.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="k">if</span> <span class="nx">@shouldIgnoreWidget</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">widget</span><span class="p">)</span>
            <span class="nv">id = </span><span class="nx">message</span><span class="p">.</span><span class="nx">widget</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">widget_id</span>
            <span class="nx">@new_widgets</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
            <span class="nx">@id_to_name</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">widget</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span>

        <span class="nv">newWidgetRendered: </span><span class="nf">(id) =&gt;</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>This callback is performed whenever a widget is rendered for
the first time. Widgets publish this kind of event automatically
when they do renderLayout() for the first time. The single
exception to this are widgets without a template_name, who
are considered "container" widgets whose sole role is to
insert other widgets into the DOM.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="k">if</span> <span class="nx">@shouldIgnoreWidget</span><span class="p">(</span><span class="nx">loader</span><span class="p">.</span><span class="nx">widgets</span><span class="p">[</span><span class="nx">id</span><span class="p">])</span>
            <span class="nx">@rendered_widgets</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>

        <span class="nv">checkIfLoadingFinished: </span><span class="o">=&gt;</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>This function is called periodically to check if loading has
finished. It compares the list of newly appeared widgets
with the list of rendered widgets and decides that it's ready
when the difference contains only "allowed" widgets.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@updateProgressBar</span><span class="p">()</span>
            <span class="nv">current_time = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span>
            <span class="nv">nasty_widgets_time = </span><span class="p">(</span><span class="nx">current_time</span> <span class="o">-</span> <span class="nx">@start_time</span> <span class="o">&gt;</span> <span class="mi">1000</span> <span class="o">*</span> <span class="nx">@REPORT_NASTY_WIDGETS_INTERVAL</span><span class="p">)</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>Check if there are still nasty widgets, and if there are
rest the counter of consecutive iterations without nasty widgets.</p>

<p>Also, if enough time has passed since the loading started,
report the "nasty" widgets for debugging purposes.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">nasty = </span><span class="nx">@getNastyWidgets</span><span class="p">()</span>
            <span class="k">if</span> <span class="nx">nasty</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="vi">@success_render_rounds = </span><span class="mi">0</span>
                <span class="nv">current_time = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span>
                <span class="k">if</span> <span class="nx">nasty_widgets_time</span>
                    <span class="nx">@reportNastyWidgets</span><span class="p">()</span>
                <span class="k">return</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>Don't allow any more nasty widgets on production.'
Just log them with critical, but try to deliver a partial
user experience as opposed to a completely broken one. (#739)</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">nasty_widgets_time</span> <span class="o">and</span> <span class="nx">App</span><span class="p">.</span><span class="nx">general</span><span class="p">.</span><span class="nx">environment</span> <span class="o">==</span> <span class="s">&#39;production&#39;</span>
                <span class="nx">@finishLoadingAnimation</span><span class="p">()</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>If we reached this point, it means that there haven't been
nasty widgets for success<em>render</em>rounds + 1 consecutive
iterations.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="vi">@success_render_rounds = </span><span class="nx">@success_render_rounds</span> <span class="o">+</span> <span class="mi">1</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>Store the first moment in time when we have had a good "streak"
of widgets. Since this moment on, we consider that loading has
finished and our job is just to get the progress bar quickly
to the end.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">@success_render_rounds</span> <span class="o">&gt;=</span> <span class="nx">@MAX_SUCCESS_RENDER_ROUNDS</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@momentLoadingFinished</span>
                <span class="vi">@momentLoadingFinished = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span>

            <span class="nx">@finishLoadingAnimation</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@getProgress</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">100</span>

        <span class="nv">finishLoadingAnimation: </span><span class="o">=&gt;</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>Hide the loading animation and stop polling for nasty widgets.
Fade out the loading animation with a nice transition, this way
the user gets a bit of extra closure and sees the last instant
step of the progress bar filling up, when widgets catch up with
the estimated progress</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#loading-animation&#39;</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">()</span>
            <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">@intervalHandle</span><span class="p">)</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p>Update the global "loading" flag from the application once the
loading is done</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">App.isLoading = </span><span class="kc">false</span>
            <span class="nx">@pipe</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s">&#39;/loading_animation_finished&#39;</span><span class="p">)</span></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>No need to listen to widget events once the loading animation
finishes</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@pipe</span><span class="p">.</span><span class="nx">unsubscribe</span><span class="p">(</span><span class="s">&#39;/new_widget&#39;</span><span class="p">,</span> <span class="nx">@newWidgetAppeared</span><span class="p">)</span>
            <span class="nx">@pipe</span><span class="p">.</span><span class="nx">unsubscribe</span><span class="p">(</span><span class="s">&#39;/new_widget_rendered&#39;</span><span class="p">,</span> <span class="nx">@newWidgetRendered</span><span class="p">)</span>

        <span class="nv">getNastyWidgets: </span><span class="o">=&gt;</span></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>Get the list of nasty widgets.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><p>These are widgets which have announced themselves as
being initialized, but have not performed renderLayout().
Notable exceptions to this rule are specified in
ALLOWED<em>TO</em>BE_NASTY.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">candidates = </span><span class="nx">_</span><span class="p">.</span><span class="nx">difference</span><span class="p">(</span><span class="nx">@new_widgets</span><span class="p">,</span> <span class="nx">@rendered_widgets</span><span class="p">)</span>
            <span class="nv">nasty_widgets = </span><span class="p">[]</span>
            <span class="k">for</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">candidates</span>
                <span class="nv">name = </span><span class="nx">@id_to_name</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
                <span class="k">unless</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">@ALLOWED_TO_BE_NASTY</span>
                    <span class="nx">nasty_widgets</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
            <span class="nx">nasty_widgets</span>

        <span class="nv">reportNastyWidgets: </span><span class="o">=&gt;</span></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><p>Reports the current list of nasty widgets.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>For debugging purposes only.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="vi">@iterations = </span><span class="k">if</span> <span class="nx">@iterations</span> <span class="k">then</span> <span class="nx">@iterations</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="nv">nasty = </span><span class="nx">@getNastyWidgets</span><span class="p">()</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><p>Make sure we display the nasty widgets the first time we
try to report them. This is because on production we will
NOT keep an infinite loading to prevent a completely broken
user experience.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">@iterations</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="nv">names = </span><span class="p">(</span><span class="nx">id</span> <span class="o">+</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">@id_to_name</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span> <span class="k">for</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">nasty</span><span class="p">)</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s">&#39;Nasty widgets: &#39;</span> <span class="o">+</span> <span class="nx">names</span><span class="p">)</span>

        <span class="nv">getProgress: </span><span class="o">=&gt;</span></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><p>Get the current percentage of progress.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><p>Since we cannot estimate how many widgets there will be
in the page, we will simply scale it linearly to a few seconds.
This number of seconds is stored in INTERVAL<em>FOR</em>99_PERCENT.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><p>After this linear interval has passed, loading gets stuck
at 99%, hoping that it won't take much longer to load :)</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a href="#section-29" class="pilcrow">&#182;</a></div><p>Compute the linear progress so far. We go from 0% to 99% linearly
in INTERVAL<em>FOR</em>99_PERCENT seconds.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">current_time = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span>
            <span class="nv">millis = </span><span class="nx">@INTERVAL_FOR_99_PERCENT</span> <span class="o">*</span> <span class="mf">1000.0</span>
            <span class="nv">difference = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">current_time</span> <span class="o">-</span> <span class="nx">@start_time</span><span class="p">,</span> <span class="nx">millis</span><span class="p">)</span>
            <span class="nv">linear_progress = </span><span class="nx">difference</span> <span class="o">/</span> <span class="nx">millis</span> <span class="o">*</span> <span class="mi">99</span></pre></div></td></tr><tr id="section-30"><td class="docs"><div class="pilwrap"><a href="#section-30" class="pilcrow">&#182;</a></div><p>If loading has finished already, we accelerate the progress to
still simulate a bit of a transition at the end</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">@momentLoadingFinished</span>
                <span class="nv">accelerated_progress = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span>
                    <span class="p">(</span><span class="nx">current_time</span> <span class="o">-</span> <span class="nx">@momentLoadingFinished</span><span class="p">)</span> <span class="o">/</span>
                    <span class="p">(</span><span class="nx">@ACCELERATED_FINISH</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">accelerated_progress</span><span class="p">,</span> <span class="nx">linear_progress</span><span class="p">)</span>

            <span class="k">return</span> <span class="nx">linear_progress</span>

        <span class="nv">updateProgressBar: </span><span class="o">=&gt;</span></pre></div></td></tr><tr id="section-31"><td class="docs"><div class="pilwrap"><a href="#section-31" class="pilcrow">&#182;</a></div><p>Update the progress bar animation.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">progress = </span><span class="nx">@getProgress</span><span class="p">()</span>
            <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#loading-animation .progress .bar&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s">&quot;width&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">progress</span><span class="si">}</span><span class="s">%&quot;</span><span class="p">)</span>

        <span class="nv">shouldIgnoreWidget: </span><span class="nf">(widget) -&gt;</span></pre></div></td></tr><tr id="section-32"><td class="docs"><div class="pilwrap"><a href="#section-32" class="pilcrow">&#182;</a></div><p>Check if a widget should be ignored by the loading animation
completely. This happens when its element or a parent one has
the .skip-loading-animation CSS class
Clearly we shouldn't wait for widgets if they don't have a
template to begin with</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="kc">true</span> <span class="k">unless</span> <span class="nx">widget</span><span class="p">.</span><span class="nx">template_name</span><span class="o">?</span></pre></div></td></tr><tr id="section-33"><td class="docs"><div class="pilwrap"><a href="#section-33" class="pilcrow">&#182;</a></div><p>Don't skip any widget in print mode, we need to make sure things
are rendered completely when we make the capture</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">Utils</span><span class="p">.</span><span class="nx">inPrintMode</span><span class="p">()</span>
            <span class="k">return</span> <span class="nx">widget</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s">&#39;skip-loading-animation&#39;</span><span class="p">)</span> <span class="o">or</span>
                   <span class="nx">widget</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">closest</span><span class="p">(</span><span class="s">&#39;.skip-loading-animation&#39;</span><span class="p">).</span><span class="nx">length</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Mon Aug 05 2013 15:56:39 GMT+0300 (EEST)  </div></div></body></html>