<!DOCTYPE html><html><head><title>auth.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../index.html" class="source"><span class="file_name">README</span></a><a href="../core~/api_mock.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">api_mock.coffee</span></a><a href="../core~/application_controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">application_controller.coffee</span></a><a href="../core~/auth.coffee.html" class="source selected"><span class="base_path">core~ / </span><span class="file_name">auth.coffee</span></a><a href="../core~/base_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_collection.coffee</span></a><a href="../core~/base_model.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_model.coffee</span></a><a href="../core~/base_widgets/autocomplete.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">autocomplete.coffee</span></a><a href="../core~/base_widgets/base_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">base_form.coffee</span></a><a href="../core~/base_widgets/delete_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">delete_form.coffee</span></a><a href="../core~/base_widgets/expanding_list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">expanding_list.coffee</span></a><a href="../core~/base_widgets/item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">item_count.coffee</span></a><a href="../core~/base_widgets/list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">list.coffee</span></a><a href="../core~/base_widgets/mediator_widget.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">mediator_widget.coffee</span></a><a href="../core~/base_widgets/nested_attributes_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">nested_attributes_form.coffee</span></a><a href="../core~/base_widgets/new_items_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">new_items_count.coffee</span></a><a href="../core~/base_widgets/notification_bar.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notification_bar.coffee</span></a><a href="../core~/base_widgets/notifications.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notifications.coffee</span></a><a href="../core~/base_widgets/order_by.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">order_by.coffee</span></a><a href="../core~/base_widgets/update_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">update_form.coffee</span></a><a href="../core~/base_widgets/url.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">url.coffee</span></a><a href="../core~/base_widgets/user_item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">user_item_count.coffee</span></a><a href="../core~/base_widgets/widget_editor.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">widget_editor.coffee</span></a><a href="../core~/channels_utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">channels_utils.coffee</span></a><a href="../core~/constants.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">constants.coffee</span></a><a href="../core~/context_processors.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">context_processors.coffee</span></a><a href="../core~/controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">controller.coffee</span></a><a href="../core~/core_modules.js.html" class="source "><span class="base_path">core~ / </span><span class="file_name">core_modules.js</span></a><a href="../core~/datasource/channel/create.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">create.coffee</span></a><a href="../core~/datasource/channel/destroy.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">destroy.coffee</span></a><a href="../core~/datasource/channel/read.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">read.coffee</span></a><a href="../core~/datasource/channel/update.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">update.coffee</span></a><a href="../core~/datasource/channel.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">channel.coffee</span></a><a href="../core~/datasource/datasource.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">datasource.coffee</span></a><a href="../core~/datasource/gc.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">gc.coffee</span></a><a href="../core~/datasource/refresher.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">refresher.coffee</span></a><a href="../core~/datasource/scheduler.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">scheduler.coffee</span></a><a href="../core~/datasource/widget.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">widget.coffee</span></a><a href="../core~/flags_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">flags_collection.coffee</span></a><a href="../core~/interceptor.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">interceptor.coffee</span></a><a href="../core~/layout.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">layout.coffee</span></a><a href="../core~/loader.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loader.coffee</span></a><a href="../core~/loading_animation.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loading_animation.coffee</span></a><a href="../core~/logging/sentry_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">sentry_logger.coffee</span></a><a href="../core~/logging/standard_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">standard_logger.coffee</span></a><a href="../core~/mocks.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mocks.coffee</span></a><a href="../core~/modal_window.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">modal_window.coffee</span></a><a href="../core~/module.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">module.coffee</span></a><a href="../core~/mozaic_backbone_form.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mozaic_backbone_form.coffee</span></a><a href="../core~/profiler.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">profiler.coffee</span></a><a href="../core~/pubsub.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">pubsub.coffee</span></a><a href="../core~/raw_data.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">raw_data.coffee</span></a><a href="../core~/router.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">router.coffee</span></a><a href="../core~/scrollable_widget.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">scrollable_widget.coffee</span></a><a href="../core~/utils/dom.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">dom.coffee</span></a><a href="../core~/utils/images.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">images.coffee</span></a><a href="../core~/utils/misc.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">misc.coffee</span></a><a href="../core~/utils/mozaic.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">mozaic.coffee</span></a><a href="../core~/utils/time.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">time.coffee</span></a><a href="../core~/utils/urls.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">urls.coffee</span></a><a href="../core~/utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">utils.coffee</span></a><a href="../core~/widget/aggregated_channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">aggregated_channels.coffee</span></a><a href="../core~/widget/backbone_events.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">backbone_events.coffee</span></a><a href="../core~/widget/channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">channels.coffee</span></a><a href="../core~/widget/modal_widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">modal_widget.coffee</span></a><a href="../core~/widget/params.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">params.coffee</span></a><a href="../core~/widget/rendering.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">rendering.coffee</span></a><a href="../core~/widget/states.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">states.coffee</span></a><a href="../core~/widget/widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">widget.coffee</span></a><a href="../core~/widget_starter.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">widget_starter.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>auth.coffee</h1><div class="filepath">core~/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span><span class="s">&#39;cs!interceptor&#39;</span><span class="p">,</span> <span class="s">&#39;cs!constants&#39;</span><span class="p">,</span> <span class="s">&#39;cs!utils&#39;</span><span class="p">,</span> <span class="s">&#39;cs!collection/current_user_data&#39;</span><span class="p">],</span> <span class="nf">(Interceptor, Constants, Utils, CurrentUserData) -&gt;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">ajaxRequests = </span><span class="p">[]</span>

    <span class="k">class</span> <span class="nx">Auth</span>
        <span class="nv">constructor: </span><span class="nf">-&gt;</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>Set default for Mozaic.stopping<em>ajax</em>requests to false</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">Mozaic.stopping_ajax_requests = </span><span class="nx">Mozaic</span><span class="p">.</span><span class="nx">stopping_ajax_requests</span> <span class="o">?</span> <span class="kc">no</span>

            <span class="nx">Interceptor</span><span class="p">.</span><span class="nx">addAjaxSendRequestCallback</span><span class="p">(</span><span class="nf">(e, xhr, settings) =&gt;</span>
                <span class="k">if</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Mozaic</span><span class="p">.</span><span class="nx">stopping_ajax_requests</span>
                    <span class="nx">xhr</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span>
                <span class="k">else</span>
                    <span class="nb">window</span><span class="p">.</span><span class="nx">ajaxRequests</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="nv">login: </span><span class="nf">(username, password, callback) =&gt;</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Try to login an user with the given username and password.
Whenever the request completes, perform a callback regardless
of the result.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>This stuff will be sent to the login API</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">params =</span>
                <span class="nv">username: </span><span class="nx">username</span>
                <span class="nv">password: </span><span class="nx">password</span>

            <span class="nx">@makeAjaxRequest</span><span class="p">(</span><span class="s">&#39;login&#39;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span>

        <span class="nv">logout: </span><span class="nf">(callback) =&gt;</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>Try to log out the current user.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">callback = </span><span class="nf">(type, data) -&gt;</span>
                <span class="k">if</span> <span class="nx">type</span> <span class="o">==</span> <span class="s">&#39;success&#39;</span>
                    <span class="nb">window</span><span class="p">.</span><span class="nv">user = </span><span class="kc">null</span>
                    <span class="nb">window</span><span class="p">.</span><span class="nv">Mozaic.stopping_ajax_requests = </span><span class="kc">true</span>
                    <span class="nb">window</span><span class="p">.</span><span class="nv">location.href = </span><span class="nx">App</span><span class="p">.</span><span class="nx">general</span><span class="p">.</span><span class="nx">LOGIN_PAGE</span>


            <span class="nx">@makeAjaxRequest</span><span class="p">(</span><span class="s">&#39;logout&#39;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>

        <span class="nv">makeAjaxRequest: </span><span class="nf">(type, callback, params={}) =&gt;</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Define own callbacks which call the callback given by the user
with an extra parameter 'success' / 'error' depending on the
result of the AJAX request.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">success_callback = </span><span class="nf">(data) -&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="s">&#39;success&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
            <span class="nv">error_callback = </span><span class="nf">(jqXHR, textStatus, errorThrown) -&gt;</span> <span class="nx">callback</span><span class="p">(</span><span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nx">jqXHR</span><span class="p">)</span>
            <span class="nv">complete_callback = </span><span class="nf">(jqXHR, textStatus) -&gt;</span>

            <span class="k">switch</span> <span class="nx">type</span>
                <span class="k">when</span> <span class="s">&#39;login&#39;</span>
                    <span class="nv">url = </span><span class="nx">App</span><span class="p">.</span><span class="nx">general</span><span class="p">.</span><span class="nx">LOGIN_URL</span>
                    <span class="nv">type = </span><span class="s">&#39;POST&#39;</span>
                <span class="k">when</span> <span class="s">&#39;logout&#39;</span>
                    <span class="nv">url = </span><span class="nx">App</span><span class="p">.</span><span class="nx">general</span><span class="p">.</span><span class="nx">LOGOUT_URL</span>
                    <span class="nv">type = </span><span class="s">&#39;POST&#39;</span>
                <span class="k">else</span>
                    <span class="nv">url = </span><span class="nx">App</span><span class="p">.</span><span class="nx">general</span><span class="p">.</span><span class="nx">CURRENT_USER_URL</span>
                    <span class="nv">type = </span><span class="s">&#39;GET&#39;</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Make the actual AJAX request</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span>
                <span class="nv">url: </span><span class="nx">url</span>
                <span class="nv">dataType: </span><span class="s">&#39;json&#39;</span>
                <span class="nv">data: </span><span class="nx">params</span>
                <span class="nv">success: </span><span class="nx">success_callback</span>
                <span class="nv">error: </span><span class="nx">error_callback</span>
                <span class="nv">complete: </span><span class="nx">complete_callback</span>
                <span class="nv">type: </span><span class="nx">type</span>

        <span class="nv">abortExpiredAjaxRequests: </span><span class="p">()</span> <span class="o">=&gt;</span>
            <span class="k">while</span> <span class="nv">request = </span><span class="nx">ajaxRequests</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
                <span class="nx">request</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span>

        <span class="nv">startWatchingForUnauthorizedApiAnswers: </span><span class="o">=&gt;</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Hooks all AJAX requests in order to detect 401 unauthorized
status codes and redirect to the login page.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>We intercept all AJAX requests done via XMLHttpRequest in order
to stop them whenever needed. The problem is that sometimes
when we issue a redirect to the login page because we are detecting
a 401 status code from the API we are consuming, there are still
pending HTTP requests and callbacks to be called which need
to fail gracefully.</p>

<p>TODO: check if core data structures can become corrupted from
not calling these callbacks</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>Get attempted page before login, if any. Maybe the user
was trying to access a page but was not logged in, so
save it, to redirect him after a successful login.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">url = </span><span class="nx">Utils</span><span class="p">.</span><span class="nx">current_url</span><span class="p">(</span><span class="kc">false</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="vi">@params = </span><span class="k">if</span> <span class="nx">url</span> <span class="k">then</span> <span class="p">{</span><span class="nv">url: </span><span class="nx">url</span><span class="p">}</span> <span class="k">else</span> <span class="p">{}</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>Add Interceptor callback for ajaxComplete. If a request fails with
401 unauthorized we make all pending AJAX requests fail gracefully
and redirect the user to the login page.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">Interceptor</span><span class="p">.</span><span class="nx">addAjaxCompleteRequestCallback</span><span class="p">(</span><span class="nf">(e, xhr, settings) =&gt;</span>
                <span class="k">if</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">401</span>
                    <span class="nx">@redirectToLogin</span><span class="p">(</span><span class="nx">@params</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="nv">refreshCurrentUser: </span><span class="nf">(user_callback = null) =&gt;</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>Refreshes the current user by issuing an AJAX request.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">callback = </span><span class="nf">(type, data) -&gt;</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>The current user call returns either a:</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><ul>
<li>HTTP 200 OK with the content of the current user
(stuff like permissions, role, name, last login)</li>
</ul>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><ul>
<li>HTTP 401 unauthorized, which should NOT be treated
here (it will be intercepted automatically by the
HTTP request interception component, which will
afterwards redirect the user to the login page)</li>
</ul>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="nx">type</span> <span class="o">==</span> <span class="s">&#39;success&#39;</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>Make sure that we always have an (at least empty)
user in window.user before setting the new data.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="o">not</span> <span class="nb">window</span><span class="p">.</span><span class="nx">user</span><span class="o">?</span>
                        <span class="nb">window</span><span class="p">.</span><span class="nv">user = </span><span class="k">new</span> <span class="nx">CurrentUserData</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nx">App</span><span class="p">.</span><span class="nx">general</span><span class="p">.</span><span class="nx">LOGGER_MODULE</span> <span class="o">is</span> <span class="s">&#39;sentry_logger&#39;</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>Register the currently logged-in user with the
logging service for enhanced exception tracking</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="nx">logger</span><span class="p">.</span><span class="nx">setUser</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pick</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;email&#39;</span><span class="p">))</span>
                    <span class="nb">window</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>

                <span class="nx">user_callback</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="k">if</span> <span class="nx">user_callback</span>

            <span class="nv">params =</span>
                <span class="nv">cacheBust: </span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">).</span><span class="nx">getTime</span><span class="p">()</span>
            <span class="nv">params.display_group_id = </span><span class="nb">window</span><span class="p">.</span><span class="nx">Mozaic</span><span class="p">.</span><span class="nx">group_id</span> <span class="k">if</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Mozaic</span><span class="p">.</span><span class="nx">group_id</span><span class="o">?</span>
            <span class="nv">params.version = </span><span class="nx">App</span><span class="p">.</span><span class="nx">version</span> <span class="k">if</span> <span class="nx">App</span><span class="p">.</span><span class="nx">version</span>

            <span class="nx">@makeAjaxRequest</span><span class="p">(</span><span class="s">&#39;current&#39;</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span>

        <span class="nv">setupCurrentUserRefresh: </span><span class="nf">-&gt;</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>Setup periodic refresh for the current user object.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">setInterval</span><span class="p">(</span><span class="nx">@refreshCurrentUser</span><span class="p">,</span> <span class="nx">App</span><span class="p">.</span><span class="nx">general</span><span class="p">.</span><span class="nx">CURRENT_USER_TIMEOUT</span><span class="p">)</span>

        <span class="nv">redirectToLogin: </span><span class="nf">(params = {}) =&gt;</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p>Redirects the user to the login page. If params
contains a url it means the user was trying to access
this but was not loged in. So, after login, redirect
him to the page stored in tue URL as ..?returnto=url.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>Note: setting window.location.href does <em>not</em> provoke
an immediate redirect, so in order to simulate that
we throw a custom exception, UNAUTHORIZED_EXCEPTION.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>This exception should not be caught by any of our layers,
and should be propagated to either the main error handler
or the application bootstrap code in main.js</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nb">window</span><span class="p">.</span><span class="nv">Mozaic.stopping_ajax_requests = </span><span class="kc">true</span>
            <span class="nx">@abortExpiredAjaxRequests</span><span class="p">()</span>
            <span class="nv">url = </span><span class="nx">App</span><span class="p">.</span><span class="nx">general</span><span class="p">.</span><span class="nx">LOGIN_PAGE</span></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><p>Encode the URL part added to returnto, and decode it
after the login was successful.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">url</span> <span class="o">+=</span> <span class="s">&#39;?returnto=&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span> <span class="k">if</span> <span class="nx">params</span><span class="p">.</span><span class="nx">url</span>
            <span class="nb">window</span><span class="p">.</span><span class="nv">location.href = </span><span class="nx">url</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">Constants</span><span class="p">.</span><span class="nx">UNAUTHORIZED_EXCEPTION</span><span class="p">)</span>

        <span class="nv">getRedirectPageAfterLogin: </span><span class="nf">-&gt;</span></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><p>Redirect to the page the user was trying to access but was
prompted with a login page.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>If the url is of type login.html?returnto='search/18181/stream'
redirect the user after a successful login to search/18181/stream</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">url = </span><span class="nx">Utils</span><span class="p">.</span><span class="nx">current_url</span><span class="p">()</span>
            <span class="nv">returnto = </span><span class="nx">$</span><span class="p">.</span><span class="nx">url</span><span class="p">(</span><span class="nx">url</span><span class="p">).</span><span class="nx">param</span><span class="p">(</span><span class="s">&#39;returnto&#39;</span><span class="p">)</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><p>Decode the previous encoded URL.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">returnto = </span><span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">returnto</span><span class="p">)</span> <span class="k">if</span> <span class="nx">returnto</span>
            <span class="nv">url_new = </span><span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="k">if</span> <span class="nx">returnto</span> <span class="k">then</span> <span class="s">&#39;#&#39;</span><span class="o">+</span><span class="nx">returnto</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">url_new</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Mon Aug 05 2013 15:56:29 GMT+0300 (EEST)  </div></div></body></html>