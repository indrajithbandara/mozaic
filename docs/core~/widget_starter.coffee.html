<!DOCTYPE html><html><head><title>widget_starter.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../index.html" class="source"><span class="file_name">README</span></a><a href="../core~/api_mock.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">api_mock.coffee</span></a><a href="../core~/application_controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">application_controller.coffee</span></a><a href="../core~/auth.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">auth.coffee</span></a><a href="../core~/base_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_collection.coffee</span></a><a href="../core~/base_model.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_model.coffee</span></a><a href="../core~/base_widgets/autocomplete.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">autocomplete.coffee</span></a><a href="../core~/base_widgets/base_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">base_form.coffee</span></a><a href="../core~/base_widgets/delete_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">delete_form.coffee</span></a><a href="../core~/base_widgets/expanding_list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">expanding_list.coffee</span></a><a href="../core~/base_widgets/item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">item_count.coffee</span></a><a href="../core~/base_widgets/list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">list.coffee</span></a><a href="../core~/base_widgets/mediator_widget.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">mediator_widget.coffee</span></a><a href="../core~/base_widgets/nested_attributes_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">nested_attributes_form.coffee</span></a><a href="../core~/base_widgets/new_items_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">new_items_count.coffee</span></a><a href="../core~/base_widgets/notification_bar.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notification_bar.coffee</span></a><a href="../core~/base_widgets/notifications.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notifications.coffee</span></a><a href="../core~/base_widgets/order_by.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">order_by.coffee</span></a><a href="../core~/base_widgets/update_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">update_form.coffee</span></a><a href="../core~/base_widgets/url.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">url.coffee</span></a><a href="../core~/base_widgets/user_item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">user_item_count.coffee</span></a><a href="../core~/base_widgets/widget_editor.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">widget_editor.coffee</span></a><a href="../core~/channels_utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">channels_utils.coffee</span></a><a href="../core~/constants.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">constants.coffee</span></a><a href="../core~/context_processors.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">context_processors.coffee</span></a><a href="../core~/controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">controller.coffee</span></a><a href="../core~/core_modules.js.html" class="source "><span class="base_path">core~ / </span><span class="file_name">core_modules.js</span></a><a href="../core~/datasource/channel/create.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">create.coffee</span></a><a href="../core~/datasource/channel/destroy.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">destroy.coffee</span></a><a href="../core~/datasource/channel/read.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">read.coffee</span></a><a href="../core~/datasource/channel/update.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">update.coffee</span></a><a href="../core~/datasource/channel.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">channel.coffee</span></a><a href="../core~/datasource/datasource.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">datasource.coffee</span></a><a href="../core~/datasource/gc.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">gc.coffee</span></a><a href="../core~/datasource/refresher.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">refresher.coffee</span></a><a href="../core~/datasource/scheduler.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">scheduler.coffee</span></a><a href="../core~/datasource/widget.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">widget.coffee</span></a><a href="../core~/flags_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">flags_collection.coffee</span></a><a href="../core~/interceptor.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">interceptor.coffee</span></a><a href="../core~/layout.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">layout.coffee</span></a><a href="../core~/loader.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loader.coffee</span></a><a href="../core~/loading_animation.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loading_animation.coffee</span></a><a href="../core~/logging/sentry_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">sentry_logger.coffee</span></a><a href="../core~/logging/standard_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">standard_logger.coffee</span></a><a href="../core~/mocks.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mocks.coffee</span></a><a href="../core~/modal_window.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">modal_window.coffee</span></a><a href="../core~/module.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">module.coffee</span></a><a href="../core~/mozaic_backbone_form.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mozaic_backbone_form.coffee</span></a><a href="../core~/profiler.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">profiler.coffee</span></a><a href="../core~/pubsub.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">pubsub.coffee</span></a><a href="../core~/raw_data.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">raw_data.coffee</span></a><a href="../core~/router.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">router.coffee</span></a><a href="../core~/scrollable_widget.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">scrollable_widget.coffee</span></a><a href="../core~/utils/dom.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">dom.coffee</span></a><a href="../core~/utils/images.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">images.coffee</span></a><a href="../core~/utils/misc.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">misc.coffee</span></a><a href="../core~/utils/mozaic.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">mozaic.coffee</span></a><a href="../core~/utils/time.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">time.coffee</span></a><a href="../core~/utils/urls.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">urls.coffee</span></a><a href="../core~/utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">utils.coffee</span></a><a href="../core~/widget/aggregated_channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">aggregated_channels.coffee</span></a><a href="../core~/widget/backbone_events.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">backbone_events.coffee</span></a><a href="../core~/widget/channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">channels.coffee</span></a><a href="../core~/widget/modal_widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">modal_widget.coffee</span></a><a href="../core~/widget/params.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">params.coffee</span></a><a href="../core~/widget/rendering.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">rendering.coffee</span></a><a href="../core~/widget/states.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">states.coffee</span></a><a href="../core~/widget/widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">widget.coffee</span></a><a href="../core~/widget_starter.coffee.html" class="source selected"><span class="base_path">core~ / </span><span class="file_name">widget_starter.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>widget_starter.coffee</h1><div class="filepath">core~/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>Widget starter is the Mozaic component managing the relationship
between in-memory widgets and the DOM. In principle, it listens to
changes of the DOM (widgets added/removed) and reacts intelligently to them.
I will denote these two types of processes by the terms "spawn" and "GC".</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Changes to the DOM are detected through the preferred method available
on the client's browser. The faster, the more preferred :)
In the order of preference, the methods we use are:
- mutation observers
- DOM mutation events
- polling (for those browsers written in Redmond :P)</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><h1>spawning</h1>

<p>TODO: explain it.</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span>
    <span class="s">&#39;cs!mozaic_module&#39;</span>
    <span class="s">&#39;cs!pubsub&#39;</span>
    <span class="s">&#39;cs!channels_utils&#39;</span>
<span class="p">],</span> <span class="nf">(</span>
<span class="nf">    Module</span>
<span class="nf">    PubSub</span>
<span class="nf">    channels_utils</span>
<span class="nf">) -&gt;</span>
    <span class="nv">checkDOMInterval = </span><span class="mi">200</span>

    <span class="k">class</span> <span class="nx">WidgetStarter</span> <span class="k">extends</span> <span class="nx">Module</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>Monitors the DOM for the appearance of new widgets.
Loads them up whenever they appear.
When new widgets are marked as delayed (i.e with Constanst.DELAY_WIDGET class)
the starter delayes their execution untill the class is removed.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>waiting_list: dictionary of channels, every value
is a list of widgets neededing that channel to become available
widgets: dictionary of widgets that still need some channels`
channels: dictionary which retains available channels</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">waiting_list: </span><span class="p">{}</span>
        <span class="nv">widgets: </span><span class="p">{}</span>
        <span class="nv">channels: </span><span class="p">{}</span>
        <span class="nv">widgets_for_gc: </span><span class="p">[]</span>
        <span class="nv">widgets_for_urgent_gc: </span><span class="p">[]</span> <span class="c1"># Widgets with priority for GC</span>
        <span class="nv">destroyed_widgets: </span><span class="p">{}</span> <span class="c1"># A hash with the ids of destroyed widgets</span>

        <span class="nv">garbageCollectionInterval: </span><span class="mi">10000</span>
        <span class="nv">garbageCollectionBatchSize: </span><span class="mi">30</span>

        <span class="nv">constructor: </span><span class="nf">-&gt;</span>
            <span class="k">super</span><span class="p">()</span>
            <span class="nv">pipe = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">get_module</span><span class="p">(</span><span class="s">&#39;pubsub&#39;</span><span class="p">)</span>
            <span class="nx">pipe</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s">&#39;/initialized_channel&#39;</span><span class="p">,</span> <span class="nf">(channel) =&gt;</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Make widget starter aware of incoming channels</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nv">channel = </span><span class="nx">channel</span><span class="p">.</span><span class="nx">name</span>
                <span class="nx">@channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>

                <span class="k">if</span> <span class="o">not</span> <span class="nx">@waiting_list</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span> <span class="k">then</span> <span class="nx">@waiting_list</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Consume widgets which are waiting on this channel</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">while</span>  <span class="p">(</span><span class="nv">widget = </span><span class="nx">@waiting_list</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">shift</span><span class="p">())</span>
                    <span class="nx">@widgets</span><span class="p">[</span><span class="nx">widget</span><span class="p">].</span><span class="nx">unitialized_channels</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="nx">@widgets</span><span class="p">[</span><span class="nx">widget</span><span class="p">].</span><span class="nx">unitialized_channels</span> <span class="o">==</span> <span class="mi">0</span>
                        <span class="nx">@loadWidget</span><span class="p">(</span><span class="nx">@widgets</span><span class="p">[</span><span class="nx">widget</span><span class="p">].</span><span class="nx">params</span><span class="p">)</span>
                        <span class="k">delete</span> <span class="nx">@widgets</span><span class="p">[</span><span class="nx">widget</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="nv">wasDelayedNode: </span><span class="nf">(mutation) -&gt;</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><h1>Checks if the mutation object passed as argument is caused by the removal of class.</h1>

<h1>Handles both MutationEvents and MutationObserver objects.</h1>

<h1>@param {Object} mutation MutationEvent | MutationRecord depending on source.</h1>

<h1>@return {Boolean}</h1>

<h1>@reference http://www.w3.org/TR/dom/#mutation-observers</h1>

<h1>@reference http://www.w3.org/TR/DOM-Level-3-Events/#events-mutationevents</h1>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">nodeClassName = </span><span class="nx">mutation</span><span class="p">.</span><span class="nx">target</span><span class="o">?</span><span class="p">.</span><span class="nx">className</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>The className can be a SVGAnimatedString because that's what a
SVG dom element returns for className
Reference: https://developer.mozilla.org/en-US/docs/Web/API/SVGAnimatedString</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">nodeClassName = </span><span class="k">if</span> <span class="nx">nodeClassName</span><span class="o">?</span><span class="p">.</span><span class="nx">baseVal</span><span class="o">?</span> <span class="k">then</span> <span class="nx">nodeClassName</span><span class="p">.</span><span class="nx">baseVal</span> <span class="k">else</span> <span class="nx">nodeClassName</span>

            <span class="nv">isMutationRecord =</span>
                <span class="nx">mutation</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s">&#39;attributes&#39;</span> <span class="o">and</span>
                <span class="nx">mutation</span><span class="p">.</span><span class="nx">attributeName</span> <span class="o">is</span> <span class="s">&#39;class&#39;</span> <span class="o">and</span>
                <span class="nx">nodeClassName</span><span class="o">?</span> <span class="o">and</span>
                <span class="nx">nodeClassName</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&#39;mozaic-widget&#39;</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span> <span class="o">and</span> <span class="c1"># Must be widget.</span>
                <span class="nx">mutation</span><span class="p">.</span><span class="nx">oldValue</span><span class="o">?</span> <span class="o">and</span>
                <span class="nx">mutation</span><span class="p">.</span><span class="nx">oldValue</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">Constants</span><span class="p">.</span><span class="nx">DELAY_WIDGET</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span> <span class="o">and</span> <span class="c1"># Should have been delayed</span>
                <span class="nx">nodeClassName</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">Constants</span><span class="p">.</span><span class="nx">DELAY_WIDGET</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># Should not be delayed anymore</span>

            <span class="nv">isMutationEvent = </span><span class="c1"># for DOM Mutation Events</span>
                <span class="nx">mutation</span><span class="p">.</span><span class="nx">attrChange</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">and</span> <span class="c1"># MODIFICATION type change.</span>
                <span class="nx">mutation</span><span class="p">.</span><span class="nx">attrName</span> <span class="o">is</span> <span class="s">&#39;class&#39;</span> <span class="o">and</span> <span class="c1"># Changed attr should be a class.</span>
                <span class="nx">mutation</span><span class="p">.</span><span class="nx">newValue</span><span class="o">?</span> <span class="o">and</span>
                <span class="nx">mutation</span><span class="p">.</span><span class="nx">newValue</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&#39;mozaic-widget&#39;</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span> <span class="o">and</span> <span class="c1"># Element should be a widget.</span>
                <span class="nx">mutation</span><span class="p">.</span><span class="nx">newValue</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">Constants</span><span class="p">.</span><span class="nx">DELAY_WIDGET</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span> <span class="o">and</span> <span class="c1"># Element should no longer be delayed.</span>
                <span class="nx">mutation</span><span class="p">.</span><span class="nx">prevValue</span><span class="o">?</span> <span class="o">and</span>
                <span class="nx">mutation</span><span class="p">.</span><span class="nx">prevValue</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">Constants</span><span class="p">.</span><span class="nx">DELAY_WIDGET</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># Element was previously marked as delayed.</span>

            <span class="k">return</span> <span class="nx">isMutationRecord</span> <span class="o">or</span> <span class="nx">isMutationEvent</span>

        <span class="nv">initialize: </span><span class="o">=&gt;</span>

            <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">@garbageCollectWidgets</span><span class="p">,</span> <span class="nx">@garbageCollectionInterval</span><span class="p">)</span>

            <span class="nv">MutationObserver = </span><span class="nb">window</span><span class="p">.</span><span class="nx">MutationObserver</span> <span class="o">or</span> <span class="nb">window</span><span class="p">.</span><span class="nx">WebKitMutationObserver</span> <span class="o">or</span> <span class="nb">window</span><span class="p">.</span><span class="nx">MozMutationObserver</span>

            <span class="k">if</span> <span class="nx">MutationObserver</span>
                <span class="nv">observer = </span><span class="k">new</span> <span class="nx">MutationObserver</span> <span class="nf">(mutations) =&gt;</span>
                    <span class="k">for</span> <span class="nx">mutation</span> <span class="k">in</span> <span class="nx">mutations</span>
                        <span class="nx">@checkInsertedNode</span> <span class="nx">$</span> <span class="nx">node</span> <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">mutation</span><span class="p">.</span><span class="nx">addedNodes</span> <span class="k">if</span> <span class="nx">mutation</span><span class="p">.</span><span class="nx">addedNodes</span><span class="o">?</span>
                        <span class="nx">@checkRemovedNode</span> <span class="nx">$</span> <span class="nx">node</span> <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">mutation</span><span class="p">.</span><span class="nx">removedNodes</span> <span class="k">if</span> <span class="nx">mutation</span><span class="p">.</span><span class="nx">removedNodes</span><span class="o">?</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>Check nodes that previously had Constants.DELAY_WIDGET class and now it's been removed by FoldedController</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">@checkInsertedNode</span> <span class="nx">$</span> <span class="nx">mutation</span><span class="p">.</span><span class="nx">target</span> <span class="k">if</span> <span class="nx">@wasDelayedNode</span> <span class="nx">mutation</span>
                    <span class="k">return</span> <span class="kc">false</span>

                <span class="nx">observer</span><span class="p">.</span><span class="nx">observe</span> <span class="nb">document</span><span class="p">,</span>
                    <span class="nv">childList: </span><span class="kc">true</span>
                    <span class="nv">subtree: </span><span class="kc">true</span>
                    <span class="nv">attributes: </span><span class="kc">true</span> <span class="c1"># Listen for attribute changes as well.</span>
                    <span class="nv">attributeOldValue: </span><span class="kc">true</span> <span class="c1"># Pass in the old attribute value, we need it to check if it had Constants.DELAY_WIDGET class.</span>
                    <span class="nv">attributeFilter: </span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span> <span class="c1"># Pass only class attribute changes</span>

            <span class="k">else</span> <span class="k">if</span> <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="o">?</span>
                <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="s">&quot;DOMNodeInserted&quot;</span><span class="p">,</span> <span class="nf">(e) =&gt;</span>
                    <span class="nx">@checkInsertedNode</span> <span class="nx">$</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span>

                <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="s">&quot;DOMNodeRemoved&quot;</span><span class="p">,</span> <span class="nf">(e) =&gt;</span>
                    <span class="nx">@checkRemovedNode</span> <span class="nx">$</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>Listen for attribute changes and filter them by class and Constants.DELAY_WIDGET</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="s">&quot;DOMAttrModified&quot;</span><span class="p">,</span> <span class="nf">(e) =&gt;</span>
                    <span class="nx">@checkInsertedNode</span> <span class="nx">$</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span> <span class="k">if</span> <span class="nx">@wasDelayedNode</span> <span class="nx">e</span>

            <span class="k">else</span> <span class="c1"># e.g IE7, IE8 -&gt; use setInterval technique for checking the DOM at certain intervals</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Right now, it doesn't know when DOM elements are removed to garbage collect them
Also, it doesn't use a setInterval, but rather a recursive Timeout after the inner
execution has finished. Since the functions from checkDOM will be called very
frequently, for performance issues the fat arrow is not used anymore</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nv">initializeWidget = </span><span class="nx">@initializeWidget</span>
                <span class="nv">checkDOM = </span><span class="nf">-&gt;</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s">&#39;.mozaic-widget&#39;</span><span class="p">).</span><span class="nx">each</span> <span class="nf">(idx, el) -&gt;</span>
                        <span class="nv">$el = </span><span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>Do nothing if the widget is either already initialized or delayed</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="k">if</span> <span class="nx">$el</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s">&#39;mozaic-initialized&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">$el</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="nx">Constants</span><span class="p">.</span><span class="nx">DELAY_WIDGET</span><span class="p">)</span>
                            <span class="k">return</span>

                        <span class="nx">setTimeout</span> <span class="nf">-&gt;</span>
                                <span class="nx">initializeWidget</span> <span class="nx">$el</span>
                            <span class="p">,</span> <span class="mi">0</span>

                    <span class="nx">setTimeout</span> <span class="nf">-&gt;</span>
                            <span class="nx">checkDOM</span><span class="p">()</span>
                        <span class="p">,</span> <span class="nx">checkDOMInterval</span>

                <span class="nx">checkDOM</span><span class="p">()</span>

        <span class="nv">checkInsertedNode: </span><span class="nf">($el) -&gt;</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>Checks to see the which type of element is the newly
iserted node. If it is an injected widget, then initialize
it</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">widgets = </span><span class="p">[]</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>If the current element is an mozaic-widget but it's not delayed</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">$el</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s">&#39;mozaic-widget&#39;</span><span class="p">)</span> <span class="o">and</span>
               <span class="o">not</span> <span class="nx">$el</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="nx">Constants</span><span class="p">.</span><span class="nx">DELAY_WIDGET</span><span class="p">)</span>
                <span class="nx">widgets</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">$el</span><span class="p">)</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>Find all its children widgets, while filtering out delayed
widgets</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&quot;.mozaic-widget&quot;</span><span class="p">)</span>
               <span class="p">.</span><span class="o">not</span><span class="p">(</span><span class="s">&quot;.</span><span class="si">#{</span><span class="nx">Constants</span><span class="p">.</span><span class="nx">DELAY_WIDGET</span><span class="si">}</span><span class="s">&quot;</span><span class="p">).</span><span class="nx">each</span> <span class="nf">(i, el) -&gt;</span>
                <span class="nx">widgets</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">))</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>Shouldn't try to initialize an empty list</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@initializeNewWidgets</span><span class="p">(</span><span class="nx">widgets</span><span class="p">)</span> <span class="k">if</span> <span class="nx">widgets</span><span class="p">.</span><span class="nx">length</span>

        <span class="nv">checkRemovedNode: </span><span class="nf">($el) -&gt;</span>
            <span class="nv">markForGarbageCollection = </span><span class="nx">@markForGarbageCollection</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p>If the removed element is a widget, garbage collect it.
Be careful, some widgets are removed from the DOM
before they have the chance to be initialized. Thus,
they don't have a GUID yet, and nothing must be done.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">$el</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s">&#39;mozaic-widget&#39;</span><span class="p">)</span>
                <span class="nx">markForGarbageCollection</span><span class="p">(</span><span class="nx">$el</span><span class="p">)</span></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>Find all its children widgets and garbage collect them</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;.mozaic-widget&#39;</span><span class="p">).</span><span class="nx">each</span> <span class="nf">(idx, el) -&gt;</span>
                <span class="nx">markForGarbageCollection</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span>

            <span class="kc">false</span>

        <span class="nv">markForGarbageCollection: </span><span class="nf">(el) =&gt;</span></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>Marks a DOM element containing a widget (can be either
initialized or uninitialized) as ready for garbage collection.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><p>This has two consequences: first, the widget is put into a
garbage collection queue which will eventually garbage collect
all their internal references and also unbind them from events.
But this is an expensive operation and we need an easy way out
until we stop receiving events (a detached widget will not
receive any DOM events but only data events). Therefore,
the second consequence is the setting of a flag for that widget
which will immediately cause it to start ignoring data events.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">guid = </span><span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;guid&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">unless</span> <span class="nx">guid</span> <span class="o">or</span> <span class="nx">@destroyed_widgets</span><span class="p">[</span><span class="nx">guid</span><span class="p">]</span></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><p>First mark it as detached</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">loader</span><span class="p">.</span><span class="nx">mark_as_detached</span><span class="p">(</span><span class="nx">guid</span><span class="p">)</span></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>And afterwards put it in the garbage collection queue.</p>

<p>Check if this is a widget with priority for GC, and if yes,
add it to the priority queue instead of the normal one.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s">&#39;urgent_for_gc&#39;</span><span class="p">)</span>
                <span class="nx">@widgets_for_urgent_gc</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">guid</span><span class="p">)</span>
            <span class="k">else</span>
                <span class="nx">@widgets_for_gc</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">guid</span><span class="p">)</span>

        <span class="nv">initializeNewWidgets: </span><span class="nf">(widgets) =&gt;</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><p>Asynchrounous batch initializing of new widgets</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">while</span> <span class="nv">widget = </span><span class="nx">widgets</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
                <span class="nx">do</span> <span class="nf">(widget) =&gt;</span></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><p>Set the GUID synchronously so that the widget can be
picked up instantly in case it get removed from the DOM
very quickly and needs to be GCed</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">@addGuidToWidget</span><span class="p">(</span><span class="nx">widget</span><span class="p">)</span></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><p>Initialize the widget asynchronously in order to avoid
hogging the browser (expecially IE) by having too many
recursive calls or even reaching a maximum call stack</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">setTimeout</span><span class="p">((</span><span class="o">=&gt;</span> <span class="nx">@initializeWidget</span><span class="p">(</span><span class="nx">widget</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="nv">startWidget: </span><span class="nf">(params) =&gt;</span></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><p>Checks if a widget can be started.
The main reason for which widgets can't be started is that
the datasource hasn't initialized all the data channels
they are subscribed to.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a href="#section-29" class="pilcrow">&#182;</a></div><p>No subscribed channels means no obligations :-)</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="s">&#39;channels&#39;</span> <span class="k">of</span> <span class="nx">params</span><span class="p">)</span>
                <span class="nx">@loadWidget</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">true</span>

            <span class="nv">unitialized_channels = </span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">channels</span><span class="p">).</span><span class="nx">length</span>
            <span class="nv">id = </span><span class="nx">params</span><span class="p">.</span><span class="nx">widget_id</span></pre></div></td></tr><tr id="section-30"><td class="docs"><div class="pilwrap"><a href="#section-30" class="pilcrow">&#182;</a></div><p>See how many of widget channels are available and put
widget on a waiting list for uninitialized channels</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">params</span><span class="p">.</span><span class="nx">channels</span>
                <span class="k">if</span> <span class="o">!</span><span class="nx">@channels</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span><span class="o">?</span>
                    <span class="k">if</span> <span class="o">!</span><span class="nx">@waiting_list</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span><span class="o">?</span>
                        <span class="nx">@waiting_list</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">id</span><span class="p">]</span>
                    <span class="k">else</span>
                        <span class="nx">@waiting_list</span><span class="p">[</span><span class="nx">v</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
                <span class="k">else</span>
                    <span class="nx">unitialized_channels</span> <span class="o">-=</span> <span class="mi">1</span></pre></div></td></tr><tr id="section-31"><td class="docs"><div class="pilwrap"><a href="#section-31" class="pilcrow">&#182;</a></div><p>If widget has all channels already initialize,</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">unitialized_channels</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="nx">@loadWidget</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="nx">@widgets</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span>
                <span class="nv">unitialized_channels: </span><span class="nx">unitialized_channels</span>
                <span class="nv">params: </span><span class="nx">params</span>

        <span class="nv">loadWidget: </span><span class="nf">(params) =&gt;</span>
            <span class="nx">loader</span><span class="p">.</span><span class="nx">load_widget</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">widget_id</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span>

        <span class="nv">addGuidToWidget: </span><span class="nf">($el) -&gt;</span></pre></div></td></tr><tr id="section-32"><td class="docs"><div class="pilwrap"><a href="#section-32" class="pilcrow">&#182;</a></div><p>Generate and attach a GUID to a widget DOM element
Tag the widget's DOM element with its GUID in order to track and
identify that element at any time (even before a widget class is
instantiated)</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">$el</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;data-guid&#39;</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniqueId</span><span class="p">(</span><span class="s">&#39;widget-&#39;</span><span class="p">))</span>

        <span class="nv">initializeWidget: </span><span class="nf">($el) =&gt;</span>
            <span class="k">if</span> <span class="nx">$el</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s">&#39;mozaic-initialized&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">false</span></pre></div></td></tr><tr id="section-33"><td class="docs"><div class="pilwrap"><a href="#section-33" class="pilcrow">&#182;</a></div><p>First thing, mark the widget as initialized</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;mozaic-initialized&#39;</span><span class="p">)</span>

            <span class="nv">name = </span><span class="nx">$el</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;widget&#39;</span><span class="p">)</span></pre></div></td></tr><tr id="section-34"><td class="docs"><div class="pilwrap"><a href="#section-34" class="pilcrow">&#182;</a></div><p>The widget GUID was generated and attached before the
asynchronous initializing of the widget begun</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">widget_id = </span><span class="nx">$el</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;guid&#39;</span><span class="p">)</span></pre></div></td></tr><tr id="section-35"><td class="docs"><div class="pilwrap"><a href="#section-35" class="pilcrow">&#182;</a></div><p>Extract widget initialization parameters from the DOM</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">params = </span><span class="nx">$</span><span class="p">.</span><span class="nx">parseJSON</span><span class="p">(</span><span class="nx">$el</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;data-params&#39;</span><span class="p">))</span> <span class="o">or</span> <span class="p">{}</span>
            <span class="nx">params</span><span class="p">[</span><span class="s">&#39;el&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$el</span>
            <span class="nx">params</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">name</span>
            <span class="nx">params</span><span class="p">[</span><span class="s">&#39;widget_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">widget_id</span>

            <span class="nx">$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&quot;widget-</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span></pre></div></td></tr><tr id="section-36"><td class="docs"><div class="pilwrap"><a href="#section-36" class="pilcrow">&#182;</a></div><p>We need to translate global channels into their true uid here</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">params.channels = </span><span class="nx">channels_utils</span><span class="p">.</span><span class="nx">translateGlobalChannels</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">channels</span><span class="p">)</span></pre></div></td></tr><tr id="section-37"><td class="docs"><div class="pilwrap"><a href="#section-37" class="pilcrow">&#182;</a></div><p>Start the widget</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@startWidget</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>

        <span class="nv">garbageCollectWidgets: </span><span class="p">()</span> <span class="o">=&gt;</span></pre></div></td></tr><tr id="section-38"><td class="docs"><div class="pilwrap"><a href="#section-38" class="pilcrow">&#182;</a></div><p>Destroy all widgets marked as garbage collected
On each GC round, the widgets to destroy are:
1) all the URGENT widgets to GC
2) if the number of widgets at 1) doesn't surpass the GC
    batch size, some more 'normal' widgets</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">widgets_to_destroy = </span><span class="nx">@widgets_for_urgent_gc</span>
            <span class="vi">@widgets_for_urgent_gc = </span><span class="p">[]</span>
            <span class="k">if</span> <span class="nx">widgets_to_destroy</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">@garbageCollectionBatchSize</span> <span class="o">and</span> <span class="nx">@widgets_for_gc</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div></td></tr><tr id="section-39"><td class="docs"><div class="pilwrap"><a href="#section-39" class="pilcrow">&#182;</a></div><p>Compute how many widgets we need to complete this round</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nv">still_need = </span><span class="nx">@garbageCollectionBatchSize</span> <span class="o">-</span> <span class="nx">widgets_to_destroy</span><span class="p">.</span><span class="nx">length</span></pre></div></td></tr><tr id="section-40"><td class="docs"><div class="pilwrap"><a href="#section-40" class="pilcrow">&#182;</a></div><p>Make sure we don't need too many - only GC what is available</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nv">still_need = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">still_need</span><span class="p">,</span> <span class="nx">@widgets_for_gc</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span></pre></div></td></tr><tr id="section-41"><td class="docs"><div class="pilwrap"><a href="#section-41" class="pilcrow">&#182;</a></div><p>Extract the remainder of this batch ..</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nv">batch_remainder = </span><span class="nx">@widgets_for_gc</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">still_need</span><span class="p">)</span></pre></div></td></tr><tr id="section-42"><td class="docs"><div class="pilwrap"><a href="#section-42" class="pilcrow">&#182;</a></div><p>.. and append it to the list of urgent widgets</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nv">widgets_to_destroy = </span><span class="nx">widgets_to_destroy</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">batch_remainder</span><span class="p">)</span></pre></div></td></tr><tr id="section-43"><td class="docs"><div class="pilwrap"><a href="#section-43" class="pilcrow">&#182;</a></div><p>For each widget to be destroyed, mark it as such and
destroy it without any doubt :)</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">while</span> <span class="nv">widget_id = </span><span class="nx">widgets_to_destroy</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
                <span class="k">if</span> <span class="o">not</span> <span class="nx">@destroyed_widgets</span><span class="p">[</span><span class="nx">widget_id</span><span class="p">]</span>
                    <span class="nx">loader</span><span class="p">.</span><span class="nx">destroy_widget</span><span class="p">(</span><span class="nx">widget_id</span><span class="p">)</span>
                    <span class="nx">@destroyed_widgets</span><span class="p">[</span><span class="nx">widget_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span></pre></div></td></tr><tr id="section-44"><td class="docs"><div class="pilwrap"><a href="#section-44" class="pilcrow">&#182;</a></div><p>Also made a periodically check in case some widgets were destroyed
within the same controller, without changing it</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">@garbageCollectWidgets</span><span class="p">,</span> <span class="nx">@garbageCollectionInterval</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">WidgetStarter</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Mon Aug 05 2013 15:56:46 GMT+0300 (EEST)  </div></div></body></html>