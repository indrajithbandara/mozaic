<!DOCTYPE html><html><head><title>channels.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../index.html" class="source"><span class="file_name">README</span></a><a href="../../core~/api_mock.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">api_mock.coffee</span></a><a href="../../core~/application_controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">application_controller.coffee</span></a><a href="../../core~/auth.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">auth.coffee</span></a><a href="../../core~/base_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_collection.coffee</span></a><a href="../../core~/base_model.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_model.coffee</span></a><a href="../../core~/base_widgets/autocomplete.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">autocomplete.coffee</span></a><a href="../../core~/base_widgets/base_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">base_form.coffee</span></a><a href="../../core~/base_widgets/delete_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">delete_form.coffee</span></a><a href="../../core~/base_widgets/expanding_list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">expanding_list.coffee</span></a><a href="../../core~/base_widgets/item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">item_count.coffee</span></a><a href="../../core~/base_widgets/list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">list.coffee</span></a><a href="../../core~/base_widgets/mediator_widget.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">mediator_widget.coffee</span></a><a href="../../core~/base_widgets/nested_attributes_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">nested_attributes_form.coffee</span></a><a href="../../core~/base_widgets/new_items_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">new_items_count.coffee</span></a><a href="../../core~/base_widgets/notification_bar.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notification_bar.coffee</span></a><a href="../../core~/base_widgets/notifications.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notifications.coffee</span></a><a href="../../core~/base_widgets/order_by.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">order_by.coffee</span></a><a href="../../core~/base_widgets/update_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">update_form.coffee</span></a><a href="../../core~/base_widgets/url.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">url.coffee</span></a><a href="../../core~/base_widgets/user_item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">user_item_count.coffee</span></a><a href="../../core~/base_widgets/widget_editor.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">widget_editor.coffee</span></a><a href="../../core~/channels_utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">channels_utils.coffee</span></a><a href="../../core~/constants.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">constants.coffee</span></a><a href="../../core~/context_processors.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">context_processors.coffee</span></a><a href="../../core~/controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">controller.coffee</span></a><a href="../../core~/core_modules.js.html" class="source "><span class="base_path">core~ / </span><span class="file_name">core_modules.js</span></a><a href="../../core~/datasource/channel/create.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">create.coffee</span></a><a href="../../core~/datasource/channel/destroy.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">destroy.coffee</span></a><a href="../../core~/datasource/channel/read.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">read.coffee</span></a><a href="../../core~/datasource/channel/update.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">update.coffee</span></a><a href="../../core~/datasource/channel.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">channel.coffee</span></a><a href="../../core~/datasource/datasource.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">datasource.coffee</span></a><a href="../../core~/datasource/gc.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">gc.coffee</span></a><a href="../../core~/datasource/refresher.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">refresher.coffee</span></a><a href="../../core~/datasource/scheduler.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">scheduler.coffee</span></a><a href="../../core~/datasource/widget.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">widget.coffee</span></a><a href="../../core~/flags_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">flags_collection.coffee</span></a><a href="../../core~/interceptor.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">interceptor.coffee</span></a><a href="../../core~/layout.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">layout.coffee</span></a><a href="../../core~/loader.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loader.coffee</span></a><a href="../../core~/loading_animation.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loading_animation.coffee</span></a><a href="../../core~/logging/sentry_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">sentry_logger.coffee</span></a><a href="../../core~/logging/standard_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">standard_logger.coffee</span></a><a href="../../core~/mocks.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mocks.coffee</span></a><a href="../../core~/modal_window.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">modal_window.coffee</span></a><a href="../../core~/module.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">module.coffee</span></a><a href="../../core~/mozaic_backbone_form.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mozaic_backbone_form.coffee</span></a><a href="../../core~/profiler.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">profiler.coffee</span></a><a href="../../core~/pubsub.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">pubsub.coffee</span></a><a href="../../core~/raw_data.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">raw_data.coffee</span></a><a href="../../core~/router.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">router.coffee</span></a><a href="../../core~/scrollable_widget.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">scrollable_widget.coffee</span></a><a href="../../core~/utils/dom.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">dom.coffee</span></a><a href="../../core~/utils/images.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">images.coffee</span></a><a href="../../core~/utils/misc.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">misc.coffee</span></a><a href="../../core~/utils/mozaic.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">mozaic.coffee</span></a><a href="../../core~/utils/time.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">time.coffee</span></a><a href="../../core~/utils/urls.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">urls.coffee</span></a><a href="../../core~/utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">utils.coffee</span></a><a href="../../core~/widget/aggregated_channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">aggregated_channels.coffee</span></a><a href="../../core~/widget/backbone_events.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">backbone_events.coffee</span></a><a href="../../core~/widget/channels.coffee.html" class="source selected"><span class="base_path">core~ / widget / </span><span class="file_name">channels.coffee</span></a><a href="../../core~/widget/modal_widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">modal_widget.coffee</span></a><a href="../../core~/widget/params.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">params.coffee</span></a><a href="../../core~/widget/rendering.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">rendering.coffee</span></a><a href="../../core~/widget/states.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">states.coffee</span></a><a href="../../core~/widget/widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">widget.coffee</span></a><a href="../../core~/widget_starter.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">widget_starter.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>channels.coffee</h1><div class="filepath">core~/widget/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span><span class="s">&#39;cs!channels_utils&#39;</span><span class="p">],</span> <span class="nf">(channels_utils) -&gt;</span>

    <span class="k">class</span> <span class="nx">WidgetChannelsMixin</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>This class contains all data channel interaction code from
mozaic widgets. A channel is basically a Backbone collection
that is managed by the Mozaic datasource.</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">addChannel: </span><span class="nf">(channel, dict, sync = true) -&gt;</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Adds a new model to the collection represented by the channel name</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>Translate the channel using the channel mapping received
from the controller.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">translated_channel = </span><span class="nx">channels_utils</span><span class="p">.</span><span class="nx">translateChannel</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">@channel_mapping</span><span class="p">)</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>Crunch the "sync" argument in the updates dict</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">dict</span><span class="p">[</span><span class="s">&#39;__sync__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sync</span>

            <span class="nv">pipe = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">get_module</span><span class="p">(</span><span class="s">&#39;pubsub&#39;</span><span class="p">)</span>
            <span class="nx">pipe</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s">&#39;/add&#39;</span><span class="p">,</span> <span class="nx">translated_channel</span><span class="p">,</span> <span class="nx">dict</span><span class="p">)</span>

        <span class="nv">modifyChannel: </span><span class="nf">(channel, dict, options = {}) -&gt;</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Request a modification of a certain data channel.
If new_value is true, the sent value is the new value
of the parameters for the data channel (e.g., internal
parameters are reset).</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>@param {String} channel
@param {Object} dict
@param {Object} options
@param {String} [options.update<em>mode = 'append']
Appends the parameters to existing ones
(possibly overwriting them)
@param {String} [options.update</em>mode = 'reset']
Makes these the actual parameters
(and updates the old values)
@param {String} [options.update<em>mode = 'exclude']
Excludes these parameters
(deletes them from the current parameters)
@param {Boolean} [options.already</em>translated]
The channel is already in GUID form, don't
bother to translate it
@param {Boolean} [options.sync]
Decides whether a server sync should be done (POST/PUT),
or only a local update of the backbone model. Note:
the local model update is also done if sync = true,
but <em>AFTER</em> the server response has come back.
@param {Boolean} [options.silent]
Decides whether the local backbone model update (which
is done regardless of the sync flag) should be done
silently or not.
@param {Object} [options.filter]
A collection of filters to select which objects from
collection will be updated</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>How to use this:
@modifyChannel('/mention/123', {title: 'new title'})
@modifyChannel('/mentions_count', {count: 123})</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">options = </span><span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span>
                <span class="nv">update_mode: </span>       <span class="s">&#39;append&#39;</span>
                <span class="nv">already_translated: </span><span class="kc">false</span>
                <span class="nv">sync: </span>              <span class="kc">true</span>
                <span class="nv">silent: </span>            <span class="kc">false</span><span class="p">)</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>Translate the channel using the channel mapping received
from the controller.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">already_translated</span>
                <span class="nv">translated_channel = </span><span class="nx">channels_utils</span><span class="p">.</span><span class="nx">translateChannel</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">@channel_mapping</span><span class="p">)</span>
            <span class="k">else</span>
                <span class="nv">translated_channel = </span><span class="nx">channel</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>Replace tokens in the translated channel with tokens from params
This will allow us to post modifications to stuff like /mention/{{id}}</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">replaced_channel = </span><span class="nx">@replaceTokensWithParams</span><span class="p">(</span><span class="nx">translated_channel</span><span class="p">)</span>

            <span class="nv">pipe = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">get_module</span><span class="p">(</span><span class="s">&#39;pubsub&#39;</span><span class="p">)</span>
            <span class="nx">pipe</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s">&#39;/modify&#39;</span><span class="p">,</span> <span class="nx">replaced_channel</span><span class="p">,</span> <span class="nx">dict</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pick</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="s">&#39;update_mode&#39;</span><span class="p">,</span><span class="s">&#39;sync&#39;</span><span class="p">,</span><span class="s">&#39;silent&#39;</span><span class="p">,</span> <span class="s">&#39;filter&#39;</span><span class="p">))</span>


        <span class="nv">deleteChannel: </span><span class="nf">(channel, options = {sync: true}) -&gt;</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>Delete a model from the channel. The channel argument should be
of this form: '/folders/123', as it contains the id of the model
to be deleted</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>Translate the channel using the channel mapping received
from the controller.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">translated_channel = </span><span class="nx">channels_utils</span><span class="p">.</span><span class="nx">translateChannel</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">@channel_mapping</span><span class="p">)</span>

            <span class="nv">pipe = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">get_module</span><span class="p">(</span><span class="s">&#39;pubsub&#39;</span><span class="p">)</span>
            <span class="nx">pipe</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s">&#39;/delete&#39;</span><span class="p">,</span> <span class="nx">translated_channel</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>

        <span class="nv">scrollChannel: </span><span class="nf">(channel) -&gt;</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Publish the scroll event on pubsub for
the specified channel argument</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">translated_channel = </span><span class="nx">channels_utils</span><span class="p">.</span><span class="nx">translateChannel</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">@channel_mapping</span><span class="p">)</span>

            <span class="nv">pipe = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">get_module</span><span class="p">(</span><span class="s">&#39;pubsub&#39;</span><span class="p">)</span>
            <span class="nx">pipe</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s">&#39;/scroll&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">translated_channel</span><span class="p">])</span>

        <span class="nv">refreshChannel: </span><span class="nf">(channel, params = null, already_translated = false) -&gt;</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>Shortcut for refreshing a single channel.
See refreshChannels for more info.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="o">not</span> <span class="nx">params</span>
                <span class="nx">@refreshChannels</span><span class="p">([</span><span class="nx">channel</span><span class="p">],</span> <span class="nx">already_translated</span><span class="p">)</span>
            <span class="k">else</span>
                <span class="nv">dict = </span><span class="p">{}</span>
                <span class="nx">dict</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span> <span class="o">=</span> <span class="nx">params</span>
                <span class="nx">@refreshChannels</span><span class="p">(</span><span class="nx">dict</span><span class="p">,</span> <span class="nx">already_translated</span><span class="p">)</span>

        <span class="nv">refreshChannels: </span><span class="nf">(channels, already_translated = false) -&gt;</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>Request a refresh of certain data channels to which this widget is subscribed.
Note! This method will not work for channels the widget is not subscribed to!</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>The method of the widget corresponding to the channel will be called
back whenever the data is available.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>We want to refresh an array of channels without any parameters at all</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">channels</span><span class="p">)</span>
                <span class="k">if</span> <span class="nx">already_translated</span>
                    <span class="nv">translated_channels = </span><span class="nx">channels</span>
                <span class="k">else</span>
                    <span class="p">[</span><span class="nx">translated_channels</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">@channel_mapping</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span> <span class="k">for</span> <span class="nx">channel</span> <span class="k">in</span> <span class="nx">channels</span><span class="p">]</span>
                <span class="nv">pipe = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">get_module</span><span class="p">(</span><span class="s">&#39;pubsub&#39;</span><span class="p">)</span>
                <span class="nx">pipe</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s">&#39;/refresh&#39;</span><span class="p">,</span> <span class="nx">translated_channels</span><span class="p">)</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>We want to refresh a dict with keys = channels and values = params for refresh</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">(</span><span class="nx">channels</span><span class="p">)</span>
                <span class="k">if</span> <span class="nx">already_translated</span>
                    <span class="nv">translated_channels = </span><span class="nx">channels</span>
                <span class="k">else</span>
                    <span class="nv">translated_channels = </span><span class="p">{}</span>
                    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">channels</span>
                        <span class="nx">translated_channels</span><span class="p">[</span><span class="nx">@channel_mapping</span><span class="p">[</span><span class="nx">k</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">v</span>
                <span class="nv">pipe = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">get_module</span><span class="p">(</span><span class="s">&#39;pubsub&#39;</span><span class="p">)</span>
                <span class="nx">pipe</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s">&#39;/refresh&#39;</span><span class="p">,</span> <span class="nx">translated_channels</span><span class="p">)</span>

        <span class="nv">subscribeToChannel: </span><span class="nf">(channel, type, params) =&gt;</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p>Subscribes the current widget to a new channel. There are
2 main use-cases here:</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>1) conditionally decide whether to subscribe to notifications
to a channel that is passed on inject</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>@subscribeToChannel('/social_profiles')</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><p>2) create a new channel and subscribe to it immediately.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><p>@subscribeToChannel('/social<em>profiles</em>for<em>posting',
'/social</em>profiles',
{'parent_id': 1234})</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>For the second use-case, note that the local alias of the
widget might be different from the channel type name as defined
in datasource.js (social<em>profiles</em>for<em>posting vs.
social</em>profiles).</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><p>Prevent widgets from subscribing 2 times to the same
channel. The behaviour is unpredictable in this case.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">@subscribed_channels</span><span class="p">,</span> <span class="nx">channel</span><span class="p">)</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s">&quot;Widget </span><span class="si">#{</span><span class="nx">@params</span><span class="p">.</span><span class="nx">widget_id</span><span class="si">}</span><span class="s"> is already &quot;</span> <span class="o">+</span>
                            <span class="s">&quot;subscribed to </span><span class="si">#{</span><span class="nx">channel</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">null</span></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><p>Prevent widgets from subscribing to global channels at
runtime. It should not be their decision to be subscribed
to channels like this, but rather that of the one who injects
the widget. Widgets should be kept reusable to the max.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">channels_utils</span><span class="p">.</span><span class="nx">isGlobal</span><span class="p">(</span><span class="nx">channel</span><span class="p">)</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s">&quot;Widget </span><span class="si">#{</span><span class="nx">@params</span><span class="p">.</span><span class="nx">widget_id</span><span class="si">}</span><span class="s"> is not allowed to &quot;</span> <span class="o">+</span>
                             <span class="s">&quot;subscribe to global channel </span><span class="si">#{</span><span class="nx">channel</span><span class="si">}</span><span class="s"> at runtime&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">null</span></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><p>Use-case # 2 - subscribe to a newly created channel. What
differs in this case is that we need to create a channel
and add it to channel mapping.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">type</span><span class="o">?</span></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><p>Make sure that the channel we're trying to create doesn't
already exist in channel_mapping.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="nx">channel</span> <span class="k">of</span> <span class="nx">@channel_mapping</span>
                    <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s">&quot;Widget </span><span class="si">#{</span><span class="nx">@params</span><span class="p">.</span><span class="nx">widget_id</span><span class="si">}</span><span class="s"> already has &quot;</span> <span class="o">+</span>
                                 <span class="s">&quot;channel </span><span class="si">#{</span><span class="nx">channel</span><span class="si">}</span><span class="s"> in its channel mapping&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">null</span>

                <span class="nv">channel_params = </span><span class="p">{}</span>
                <span class="nx">channel_params</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">params</span>
                <span class="p">[</span><span class="nx">channel_uid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Utils</span><span class="p">.</span><span class="nx">newDataChannels</span><span class="p">(</span><span class="nx">channel_params</span><span class="p">)</span>
                <span class="nx">@channel_mapping</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span> <span class="o">=</span> <span class="nx">channel_uid</span>
            <span class="k">else</span></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a href="#section-29" class="pilcrow">&#182;</a></div><p>Check that the channel is indeed in the channel mapping.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">channel</span> <span class="k">of</span> <span class="nx">@channel_mapping</span><span class="p">)</span>
                    <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s">&quot;Widget @{params.widget_id} wants to &quot;</span> <span class="o">+</span>
                                 <span class="s">&quot;subscribe to channel </span><span class="si">#{</span><span class="nx">channel</span><span class="si">}</span><span class="s"> not &quot;</span> <span class="o">+</span>
                                 <span class="s">&quot;present in channel_mapping!&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">null</span></pre></div></td></tr><tr id="section-30"><td class="docs"><div class="pilwrap"><a href="#section-30" class="pilcrow">&#182;</a></div><p>Now we only need to add the channel to subscribed-channels,
no matter what.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@subscribed_channels</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">channel</span><span class="p">)</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s">&quot;Widget </span><span class="si">#{</span><span class="nx">@params</span><span class="p">.</span><span class="nx">widget_id</span><span class="si">}</span><span class="s"> is successfully &quot;</span>
                        <span class="s">&quot;subscribed to </span><span class="si">#{</span><span class="nx">channel</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="nx">@channel_mapping</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Mon Aug 05 2013 15:56:45 GMT+0300 (EEST)  </div></div></body></html>