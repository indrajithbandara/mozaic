<!DOCTYPE html><html><head><title>scheduler.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../index.html" class="source"><span class="file_name">README</span></a><a href="../../core~/api_mock.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">api_mock.coffee</span></a><a href="../../core~/application_controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">application_controller.coffee</span></a><a href="../../core~/auth.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">auth.coffee</span></a><a href="../../core~/base_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_collection.coffee</span></a><a href="../../core~/base_model.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_model.coffee</span></a><a href="../../core~/base_widgets/autocomplete.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">autocomplete.coffee</span></a><a href="../../core~/base_widgets/base_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">base_form.coffee</span></a><a href="../../core~/base_widgets/delete_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">delete_form.coffee</span></a><a href="../../core~/base_widgets/expanding_list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">expanding_list.coffee</span></a><a href="../../core~/base_widgets/item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">item_count.coffee</span></a><a href="../../core~/base_widgets/list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">list.coffee</span></a><a href="../../core~/base_widgets/mediator_widget.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">mediator_widget.coffee</span></a><a href="../../core~/base_widgets/nested_attributes_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">nested_attributes_form.coffee</span></a><a href="../../core~/base_widgets/new_items_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">new_items_count.coffee</span></a><a href="../../core~/base_widgets/notification_bar.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notification_bar.coffee</span></a><a href="../../core~/base_widgets/notifications.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notifications.coffee</span></a><a href="../../core~/base_widgets/order_by.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">order_by.coffee</span></a><a href="../../core~/base_widgets/update_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">update_form.coffee</span></a><a href="../../core~/base_widgets/url.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">url.coffee</span></a><a href="../../core~/base_widgets/user_item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">user_item_count.coffee</span></a><a href="../../core~/base_widgets/widget_editor.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">widget_editor.coffee</span></a><a href="../../core~/channels_utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">channels_utils.coffee</span></a><a href="../../core~/constants.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">constants.coffee</span></a><a href="../../core~/context_processors.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">context_processors.coffee</span></a><a href="../../core~/controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">controller.coffee</span></a><a href="../../core~/core_modules.js.html" class="source "><span class="base_path">core~ / </span><span class="file_name">core_modules.js</span></a><a href="../../core~/datasource/channel/create.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">create.coffee</span></a><a href="../../core~/datasource/channel/destroy.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">destroy.coffee</span></a><a href="../../core~/datasource/channel/read.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">read.coffee</span></a><a href="../../core~/datasource/channel/update.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">update.coffee</span></a><a href="../../core~/datasource/channel.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">channel.coffee</span></a><a href="../../core~/datasource/datasource.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">datasource.coffee</span></a><a href="../../core~/datasource/gc.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">gc.coffee</span></a><a href="../../core~/datasource/refresher.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">refresher.coffee</span></a><a href="../../core~/datasource/scheduler.coffee.html" class="source selected"><span class="base_path">core~ / datasource / </span><span class="file_name">scheduler.coffee</span></a><a href="../../core~/datasource/widget.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">widget.coffee</span></a><a href="../../core~/flags_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">flags_collection.coffee</span></a><a href="../../core~/interceptor.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">interceptor.coffee</span></a><a href="../../core~/layout.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">layout.coffee</span></a><a href="../../core~/loader.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loader.coffee</span></a><a href="../../core~/loading_animation.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loading_animation.coffee</span></a><a href="../../core~/logging/sentry_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">sentry_logger.coffee</span></a><a href="../../core~/logging/standard_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">standard_logger.coffee</span></a><a href="../../core~/mocks.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mocks.coffee</span></a><a href="../../core~/modal_window.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">modal_window.coffee</span></a><a href="../../core~/module.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">module.coffee</span></a><a href="../../core~/mozaic_backbone_form.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mozaic_backbone_form.coffee</span></a><a href="../../core~/profiler.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">profiler.coffee</span></a><a href="../../core~/pubsub.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">pubsub.coffee</span></a><a href="../../core~/raw_data.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">raw_data.coffee</span></a><a href="../../core~/router.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">router.coffee</span></a><a href="../../core~/scrollable_widget.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">scrollable_widget.coffee</span></a><a href="../../core~/utils/dom.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">dom.coffee</span></a><a href="../../core~/utils/images.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">images.coffee</span></a><a href="../../core~/utils/misc.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">misc.coffee</span></a><a href="../../core~/utils/mozaic.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">mozaic.coffee</span></a><a href="../../core~/utils/time.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">time.coffee</span></a><a href="../../core~/utils/urls.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">urls.coffee</span></a><a href="../../core~/utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">utils.coffee</span></a><a href="../../core~/widget/aggregated_channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">aggregated_channels.coffee</span></a><a href="../../core~/widget/backbone_events.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">backbone_events.coffee</span></a><a href="../../core~/widget/channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">channels.coffee</span></a><a href="../../core~/widget/modal_widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">modal_widget.coffee</span></a><a href="../../core~/widget/params.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">params.coffee</span></a><a href="../../core~/widget/rendering.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">rendering.coffee</span></a><a href="../../core~/widget/states.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">states.coffee</span></a><a href="../../core~/widget/widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">widget.coffee</span></a><a href="../../core~/widget_starter.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">widget_starter.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>scheduler.coffee</h1><div class="filepath">core~/datasource/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">define</span> <span class="p">[],</span> <span class="p">()</span> <span class="nf">-&gt;</span>

    <span class="k">class</span> <span class="nx">DataSourceScheduler</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>Includes methods to ...</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">pushDataAfterScroll: </span><span class="nf">(channels) -&gt;</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>This gets called every time a widget publishes to "/scroll"</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>Data sources receives the scrollable_channels, sets the new collection
page based on the channels, which will trigger the widget to update</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>For each of the scrollable channels the widget is subscribed to</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">for</span> <span class="nx">channel</span> <span class="k">in</span> <span class="nx">channels</span>
                <span class="nx">do</span> <span class="nf">(channel) =&gt;</span>
                    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Scrolling </span><span class="si">#{</span><span class="nx">channel</span><span class="si">}</span><span class="s"> in DataSource&quot;</span>
                    <span class="nx">@_fetchChannelDataFromServer</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="s">&#39;scroll&#39;</span><span class="p">)</span>

        <span class="nv">pushDataAfterRefresh: </span><span class="nf">(channels, options = {}) -&gt;</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>This gets called every time a widget publishes to "/refresh"</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Data sources will update the data channel according to its
configured policy.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Here it can happen a flush channel buffer or a channel refresh
To skip the buffer flush pass skipStreampollBuffer = true in options param</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>If channels is an array, it means that we're not receiving any
parameters to the channels refresh.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">channels</span><span class="p">)</span>
                <span class="nv">dict = </span><span class="p">{}</span>
                <span class="k">for</span> <span class="nx">channel</span> <span class="k">in</span> <span class="nx">channels</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>Use existing params if no params were specified</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">dict</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@meta_data</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">params</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>Otherwise, we're getting channel-specific params for refresh</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">else</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">(</span><span class="nx">channels</span><span class="p">)</span>
                <span class="nv">dict = </span><span class="nx">channels</span>
            <span class="k">else</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s">&quot;Unknown parameter type for pushDataAfterRefresh: </span><span class="si">#{</span><span class="nx">channels</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">for</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">params</span> <span class="k">of</span> <span class="nx">dict</span>
                <span class="nx">do</span> <span class="nf">(channel, params) =&gt;</span>
                    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Sends data to </span><span class="si">#{</span><span class="nx">channel</span><span class="si">}</span><span class="s"> in DataSource&quot;</span>

                    <span class="nv">params_modified = </span><span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEqual</span><span class="p">(</span><span class="nx">@meta_data</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">params</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span>
                    <span class="nx">@meta_data</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nv">params = </span><span class="nx">params</span> <span class="k">if</span> <span class="nx">params_modified</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>Allow to skip a streampoll buffer flush
By default skip<em>streampoll</em>buffer = false</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nv">skip_streampoll_buffer = </span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">skipStreampollBuffer</span><span class="o">?</span> <span class="k">then</span> <span class="nx">options</span><span class="p">.</span><span class="nx">skipStreampollBuffer</span> <span class="k">else</span> <span class="kc">false</span>

                    <span class="nv">config_buffer_size = </span><span class="nx">@_getBufferSize</span><span class="p">(</span><span class="nx">channel</span><span class="p">)</span>
                    <span class="nv">channel_has_buffer = </span><span class="nx">config_buffer_size</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Current buffer length is 0 if channel is not configured with a buffer</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nv">current_buffer_size = </span><span class="k">if</span> <span class="nx">channel_has_buffer</span> <span class="k">then</span> <span class="nx">@data</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span> <span class="k">else</span> <span class="mi">0</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>If channel has no buffer that buffer<em>is</em>full = true</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nv">buffer_is_full = </span><span class="nx">current_buffer_size</span> <span class="o">&gt;=</span> <span class="nx">config_buffer_size</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>Refresh channel if these conditions are met:
 - skip<em>streampoll</em>buffer = true, or
 - The channel buffer is full, or
 - The channel params were modified</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="nx">skip_streampoll_buffer</span> <span class="o">or</span> <span class="nx">buffer_is_full</span> <span class="o">or</span> <span class="nx">params_modified</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>If we have to do a fresh fetch from the server,
empty the existing buffer first</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">@data</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">reset</span><span class="p">([])</span> <span class="k">if</span> <span class="nx">channel_has_buffer</span>
                        <span class="nx">@_fetchChannelDataFromServer</span><span class="p">(</span><span class="nx">channel</span><span class="p">)</span>
                        <span class="nx">@_restartRefreshing</span><span class="p">(</span><span class="nx">channel</span><span class="p">)</span>
                    <span class="k">else</span>
                        <span class="nx">@_flushChannelBuffer</span><span class="p">(</span><span class="nx">channel</span><span class="p">)</span>

        <span class="nv">_scheduleNextRefresh: </span><span class="nf">(channel_key, success) -&gt;</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>Schedule the next refresh for a given channel and a reason.
The next refresh will call this function again via callback,
to schedule the next refresh after that, and so on.
Are we still refreshing this channel?</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="o">not</span> <span class="nx">@meta_data</span><span class="p">[</span><span class="nx">channel_key</span><span class="p">].</span><span class="nx">refreshing</span>
                <span class="k">return</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>Basic refresh_after.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">refresh_after = </span><span class="nx">@_getRefreshInterval</span><span class="p">(</span><span class="nx">channel_key</span><span class="p">)</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p>Do not apply the backoff algorithm to fetching failures.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">@_getConfig</span><span class="p">(</span><span class="nx">channel_key</span><span class="p">).</span><span class="nx">refresh</span> <span class="o">==</span> <span class="s">&#39;backoff&#39;</span> <span class="o">and</span> <span class="nx">success</span></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>Current item count = data + buffer</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nv">current_item_count = </span><span class="nx">@data</span><span class="p">[</span><span class="nx">channel_key</span><span class="p">].</span><span class="nx">length</span>
                <span class="k">if</span> <span class="s">&#39;buffer&#39;</span> <span class="k">of</span> <span class="nx">@data</span><span class="p">[</span><span class="nx">channel_key</span><span class="p">]</span>
                    <span class="nx">current_item_count</span> <span class="o">+=</span> <span class="nx">@data</span><span class="p">[</span><span class="nx">channel_key</span><span class="p">].</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>If there are no new items, increment backoff, otherwise reset it.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="nx">current_item_count</span> <span class="o">==</span> <span class="nx">@meta_data</span><span class="p">[</span><span class="nx">channel_key</span><span class="p">].</span><span class="nx">last_item_count</span></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><p>Initialize the exponential backoff to 1, then double it.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="o">not</span> <span class="nx">@meta_data</span><span class="p">[</span><span class="nx">channel_key</span><span class="p">].</span><span class="nx">backoff</span>
                        <span class="nx">@meta_data</span><span class="p">[</span><span class="nx">channel_key</span><span class="p">].</span><span class="nv">backoff = </span><span class="mi">1</span>
                    <span class="nx">@meta_data</span><span class="p">[</span><span class="nx">channel_key</span><span class="p">].</span><span class="nx">backoff</span> <span class="o">*=</span> <span class="mi">2</span>
                    <span class="nx">refresh_after</span> <span class="o">*=</span> <span class="nx">@meta_data</span><span class="p">[</span><span class="nx">channel_key</span><span class="p">].</span><span class="nx">backoff</span></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><p>Ensure refresh<em>after &lt; max</em>refresh_interval.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nv">refresh_after = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">refresh_after</span><span class="p">,</span> <span class="nx">@_getMaxRefreshInterval</span><span class="p">(</span><span class="nx">channel_key</span><span class="p">))</span>
                    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Refreshing </span><span class="si">#{</span><span class="nx">channel_key</span><span class="si">}</span><span class="s"> after </span><span class="si">#{</span><span class="nx">refresh_after</span><span class="si">}</span><span class="s">ms&quot;</span>
                <span class="k">else</span></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>Some new items, reset backoff.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">@meta_data</span><span class="p">[</span><span class="nx">channel_key</span><span class="p">].</span><span class="nv">backoff = </span><span class="mi">1</span>
                    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Reset backoff for </span><span class="si">#{</span><span class="nx">channel_key</span><span class="si">}</span><span class="s">&quot;</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><p>TODO(mihnea): if a scroll down event is triggered, the number
of items in the channel will increase, regardless of the
refreshing logic. This will be perceived as "new data" and
we might refresh sooner than needed because of it.
Possible fix: recompute last<em>item</em>count after each
reason='scroll' refresh.
Update last<em>item</em>count.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">@meta_data</span><span class="p">[</span><span class="nx">channel_key</span><span class="p">].</span><span class="nv">last_item_count = </span><span class="nx">current_item_count</span></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><p>Configure periodic refresh with reason="refresh" or "streampoll"
(or "scroll", but that makes very little sense).</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">refresh_type = </span><span class="nx">@_getRefreshType</span><span class="p">(</span><span class="nx">channel_key</span><span class="p">)</span>
            <span class="nv">handle = </span><span class="nx">setTimeout</span><span class="p">((</span><span class="o">=&gt;</span> <span class="nx">@_fetchChannelDataFromServer</span><span class="p">(</span><span class="nx">channel_key</span><span class="p">,</span> <span class="nx">refresh_type</span><span class="p">,</span> <span class="nx">@_scheduleNextRefresh</span><span class="p">)),</span>
                                <span class="nx">refresh_after</span><span class="p">)</span>
            <span class="nx">@meta_data</span><span class="p">[</span><span class="nx">channel_key</span><span class="p">].</span><span class="nv">timeout_variable = </span><span class="nx">handle</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Mon Aug 05 2013 15:56:38 GMT+0300 (EEST)  </div></div></body></html>