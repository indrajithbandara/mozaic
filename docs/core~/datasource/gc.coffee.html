<!DOCTYPE html><html><head><title>gc.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../index.html" class="source"><span class="file_name">README</span></a><a href="../../core~/api_mock.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">api_mock.coffee</span></a><a href="../../core~/application_controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">application_controller.coffee</span></a><a href="../../core~/auth.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">auth.coffee</span></a><a href="../../core~/base_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_collection.coffee</span></a><a href="../../core~/base_model.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_model.coffee</span></a><a href="../../core~/base_widgets/autocomplete.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">autocomplete.coffee</span></a><a href="../../core~/base_widgets/base_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">base_form.coffee</span></a><a href="../../core~/base_widgets/delete_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">delete_form.coffee</span></a><a href="../../core~/base_widgets/expanding_list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">expanding_list.coffee</span></a><a href="../../core~/base_widgets/item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">item_count.coffee</span></a><a href="../../core~/base_widgets/list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">list.coffee</span></a><a href="../../core~/base_widgets/mediator_widget.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">mediator_widget.coffee</span></a><a href="../../core~/base_widgets/nested_attributes_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">nested_attributes_form.coffee</span></a><a href="../../core~/base_widgets/new_items_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">new_items_count.coffee</span></a><a href="../../core~/base_widgets/notification_bar.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notification_bar.coffee</span></a><a href="../../core~/base_widgets/notifications.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notifications.coffee</span></a><a href="../../core~/base_widgets/order_by.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">order_by.coffee</span></a><a href="../../core~/base_widgets/update_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">update_form.coffee</span></a><a href="../../core~/base_widgets/url.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">url.coffee</span></a><a href="../../core~/base_widgets/user_item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">user_item_count.coffee</span></a><a href="../../core~/base_widgets/widget_editor.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">widget_editor.coffee</span></a><a href="../../core~/channels_utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">channels_utils.coffee</span></a><a href="../../core~/constants.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">constants.coffee</span></a><a href="../../core~/context_processors.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">context_processors.coffee</span></a><a href="../../core~/controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">controller.coffee</span></a><a href="../../core~/core_modules.js.html" class="source "><span class="base_path">core~ / </span><span class="file_name">core_modules.js</span></a><a href="../../core~/datasource/channel/create.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">create.coffee</span></a><a href="../../core~/datasource/channel/destroy.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">destroy.coffee</span></a><a href="../../core~/datasource/channel/read.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">read.coffee</span></a><a href="../../core~/datasource/channel/update.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">update.coffee</span></a><a href="../../core~/datasource/channel.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">channel.coffee</span></a><a href="../../core~/datasource/datasource.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">datasource.coffee</span></a><a href="../../core~/datasource/gc.coffee.html" class="source selected"><span class="base_path">core~ / datasource / </span><span class="file_name">gc.coffee</span></a><a href="../../core~/datasource/refresher.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">refresher.coffee</span></a><a href="../../core~/datasource/scheduler.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">scheduler.coffee</span></a><a href="../../core~/datasource/widget.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">widget.coffee</span></a><a href="../../core~/flags_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">flags_collection.coffee</span></a><a href="../../core~/interceptor.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">interceptor.coffee</span></a><a href="../../core~/layout.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">layout.coffee</span></a><a href="../../core~/loader.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loader.coffee</span></a><a href="../../core~/loading_animation.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loading_animation.coffee</span></a><a href="../../core~/logging/sentry_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">sentry_logger.coffee</span></a><a href="../../core~/logging/standard_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">standard_logger.coffee</span></a><a href="../../core~/mocks.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mocks.coffee</span></a><a href="../../core~/modal_window.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">modal_window.coffee</span></a><a href="../../core~/module.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">module.coffee</span></a><a href="../../core~/mozaic_backbone_form.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mozaic_backbone_form.coffee</span></a><a href="../../core~/profiler.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">profiler.coffee</span></a><a href="../../core~/pubsub.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">pubsub.coffee</span></a><a href="../../core~/raw_data.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">raw_data.coffee</span></a><a href="../../core~/router.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">router.coffee</span></a><a href="../../core~/scrollable_widget.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">scrollable_widget.coffee</span></a><a href="../../core~/utils/dom.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">dom.coffee</span></a><a href="../../core~/utils/images.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">images.coffee</span></a><a href="../../core~/utils/misc.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">misc.coffee</span></a><a href="../../core~/utils/mozaic.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">mozaic.coffee</span></a><a href="../../core~/utils/time.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">time.coffee</span></a><a href="../../core~/utils/urls.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">urls.coffee</span></a><a href="../../core~/utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">utils.coffee</span></a><a href="../../core~/widget/aggregated_channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">aggregated_channels.coffee</span></a><a href="../../core~/widget/backbone_events.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">backbone_events.coffee</span></a><a href="../../core~/widget/channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">channels.coffee</span></a><a href="../../core~/widget/modal_widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">modal_widget.coffee</span></a><a href="../../core~/widget/params.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">params.coffee</span></a><a href="../../core~/widget/rendering.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">rendering.coffee</span></a><a href="../../core~/widget/states.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">states.coffee</span></a><a href="../../core~/widget/widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">widget.coffee</span></a><a href="../../core~/widget_starter.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">widget_starter.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>gc.coffee</h1><div class="filepath">core~/datasource/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span><span class="s">&#39;cs!channels_utils&#39;</span><span class="p">],</span> <span class="nf">(channels_utils) -&gt;</span>

    <span class="k">class</span> <span class="nx">DataSourceGCMixin</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>Includes a method for garbage collect channels when they
are no longer used</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">channelCanBeGarbageCollected: </span><span class="nf">(channel) -&gt;</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Checks if a Datasource channel can be safely garbage collected.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>There are several factors which can influence this:</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><ul>
<li>the channel has waiting fetches (aka, we have launched
a request to fetch data, and that request will have nowhere
to add the data to)</li>
</ul>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><ul>
<li>the channel hasn't had reference_count 0 for enough time
(having a channel lurking around for a little while with
data in it is useful when changing from one controller to
another - the same channels from the new controller will
be cloned from the old ones)</li>
</ul>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><ul>
<li>the channel is eternal (this is useful if you have info
that is displayed on absolutely all pages and don't want
it to ever be garbage collection); this should be used
in conjunction with application_controller which should
be careful to create those eternal channels and pass them
on correctly.</li>
</ul>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">meta = </span><span class="nx">@meta_data</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span>
            <span class="nv">reference = </span><span class="nx">@reference_data</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Eternal channels are never expired</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">eternal</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s">&quot;Channel </span><span class="si">#{</span><span class="nx">channel</span><span class="si">}</span><span class="s"> cannot be garbage &quot;</span> <span class="o">+</span>
                            <span class="s">&quot;collected because it&#39;s eternal&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">false</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>If this channel still has references attached, so skip it.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">unless</span> <span class="nx">reference</span><span class="p">[</span><span class="s">&#39;time_of_reference_expiry&#39;</span><span class="p">]</span><span class="o">?</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s">&quot;Channel </span><span class="si">#{</span><span class="nx">channel</span><span class="si">}</span><span class="s"> cannot be garbage &quot;</span> <span class="o">+</span>
                            <span class="s">&quot;collected because it still has widgets &quot;</span> <span class="o">+</span>
                            <span class="s">&quot;referencing it. (reference count: </span><span class="si">#{</span><span class="nx">reference</span><span class="p">.</span><span class="nx">reference_count</span><span class="si">}</span><span class="s">)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">false</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>Channels with pending fetches should not be garbage collected</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="s">&#39;waiting_fetches&#39;</span> <span class="k">of</span> <span class="nx">meta</span> <span class="o">and</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">waiting_fetches</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s">&quot;Channel </span><span class="si">#{</span><span class="nx">channel</span><span class="si">}</span><span class="s"> cannot be garbage &quot;</span> <span class="o">+</span>
                            <span class="s">&quot;collected because it still has fetches &quot;</span> <span class="o">+</span>
                            <span class="s">&quot;waiting to arrive&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">false</span>

            <span class="nv">expired_for = </span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">).</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">reference</span><span class="p">[</span><span class="s">&#39;time_of_reference_expiry&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nx">expired_for</span> <span class="o">&lt;=</span> <span class="nx">@checkIntervalForUnusedChannels</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s">&quot;Channel </span><span class="si">#{</span><span class="nx">channel</span><span class="si">}</span><span class="s"> hasn&#39;t lurked around enough. &quot;</span> <span class="o">+</span>
                            <span class="s">&quot;Leaving it right there for now, because maybe &quot;</span> <span class="o">+</span>
                            <span class="s">&quot;someone wants to clone or re-use it.&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">true</span>

        <span class="nv">garbageCollectChannel: </span><span class="nf">(channel) -&gt;</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>Garbage collect a channel after we detect that it's of no use
to anyone else.
Declare that channel has expired loudly and openly.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s">&quot;Garbage collecting channel </span><span class="si">#{</span><span class="nx">channel</span><span class="si">}</span><span class="s"> in DataSource.&quot;</span><span class="p">)</span>
            <span class="k">delete</span> <span class="nx">@reference_data</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>The meta_data might not have even been created if a channel got
removed before its collection loaded</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="k">unless</span> <span class="nx">@meta_data</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span><span class="o">?</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Stop periodic refresh if it was enabled</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@_stopRefreshing</span><span class="p">(</span><span class="nx">channel</span><span class="p">)</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>Throw away channel meta-data</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">delete</span> <span class="nx">@meta_data</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>Delete cyclic reference from channel to its buffer</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">@data</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">buffer</span><span class="o">?</span>
                <span class="k">delete</span> <span class="nx">@data</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">collection</span>
                <span class="nx">@data</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">off</span><span class="p">()</span>
                <span class="k">delete</span> <span class="nx">@data</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">buffer</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>Unbind all remaining widgets (should be none!)</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@data</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">off</span><span class="p">()</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>Throw away reference to the actual data</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">delete</span> <span class="nx">@data</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span>

        <span class="nv">checkForUnusedChannels: </span><span class="nf">-&gt;</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>This function gets cleaned up periodically in order to
inspect which channels still have a non-zero reference count
and which don't.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p>Those who have been inactive (e.g., 0 reference count) for
quite a while (> checkIntervalForUnusedChannels) will be
garbage colllected, unless they are eternal.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>Some collections might be eternal, and this is a per-channel
flag (so not found in datasource.js, but passed to
Utils.newDataChannels when creating channel instances) because
for example they are created from the application controller
and they should live for the whole navigation session regardless
of whether what is found on the page actually references them
or not.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">for</span> <span class="nx">channel</span> <span class="k">of</span> <span class="nx">@meta_data</span>
                <span class="k">if</span> <span class="nx">@channelCanBeGarbageCollected</span><span class="p">(</span><span class="nx">channel</span><span class="p">)</span>
                    <span class="nx">@garbageCollectChannel</span><span class="p">(</span><span class="nx">channel</span><span class="p">)</span>

        <span class="nv">increaseReferenceCountsForChannelsOfNewWidget: </span><span class="nf">(widget) -&gt;</span></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>Given a newly-appeared widget, increase reference counts for
channels it references via channel_mapping (the mapping from
the channels the widget needs to actual channel IDs from the
Datasource).</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">for</span> <span class="nx">reference</span><span class="p">,</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">widget</span><span class="p">.</span><span class="nx">channel_mapping</span>
                <span class="k">unless</span> <span class="nx">@reference_data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">?</span>
                    <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t increase count of </span><span class="si">#{</span><span class="nx">key</span><span class="si">}</span><span class="s"> &quot;</span> <span class="o">+</span>
                                <span class="s">&quot;because it was already removed&quot;</span><span class="p">)</span>
                    <span class="k">continue</span></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><p>Add reference counter for determining if this channel
is still in use or not</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">@reference_data</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="s">&#39;reference_count&#39;</span><span class="p">]</span> <span class="o">?=</span> <span class="mi">0</span>
                <span class="nx">@reference_data</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="s">&#39;reference_count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><p>This timestamp allows us to see for how long the channel
has been inactive</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">@reference_data</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="s">&#39;time_of_reference_expiry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span>

        <span class="nv">decreaseReferenceCountsForChannelsOfDestroyedWidget: </span><span class="nf">(widget) -&gt;</span></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>Given a freshly-garbage-collected widget, decrease the reference
counts of the channels used by the widget (found in
widget.channel_mapping). When a channel's reference count
reaches 0, it will be garbage collected itself (see
@checkForUnusedChannels).</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">for</span> <span class="nx">channel</span> <span class="k">in</span> <span class="nx">_</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">widget</span><span class="p">.</span><span class="nx">channel_mapping</span><span class="p">)</span>
                <span class="k">unless</span> <span class="nx">@reference_data</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span><span class="o">?</span>
                    <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t decrease count of </span><span class="si">#{</span><span class="nx">channel</span><span class="si">}</span><span class="s"> &quot;</span> <span class="o">+</span>
                                <span class="s">&quot;because it was already removed&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="nx">@reference_data</span><span class="p">[</span><span class="nx">channel</span><span class="p">][</span><span class="s">&#39;reference_count&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="nv">new_count = </span><span class="nx">@reference_data</span><span class="p">[</span><span class="nx">channel</span><span class="p">][</span><span class="s">&#39;reference_count&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nx">@reference_data</span><span class="p">[</span><span class="nx">channel</span><span class="p">][</span><span class="s">&#39;reference_count&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="nx">@reference_data</span><span class="p">[</span><span class="nx">channel</span><span class="p">][</span><span class="s">&#39;time_of_reference_expiry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">).</span><span class="nx">getTime</span><span class="p">()</span>

        <span class="nv">unbindWidgetFromBackboneEvents: </span><span class="nf">(widget) -&gt;</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><p>Unbinds a widget from all of its related backbone events
(be it collection-level events or model-level events),
for classical Backbone collections or for our own RawData.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><p>The datasource is responsible for this because it's also
responsible for binding the widget to channel events.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">for</span> <span class="nx">fake_channel</span><span class="p">,</span> <span class="nx">channel</span> <span class="k">of</span> <span class="nx">widget</span><span class="p">.</span><span class="nx">channel_mapping</span>
                <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">channel</span> <span class="k">of</span> <span class="nx">@meta_data</span><span class="p">)</span>
                    <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s">&#39;Could not unbind widget from collection &#39;</span> <span class="o">+</span>
                                 <span class="nx">channel</span> <span class="o">+</span> <span class="s">&#39; because it was already gone&#39;</span><span class="p">)</span>
                    <span class="k">continue</span></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><p>Start unbinding the widget to the existing channel.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nv">widget_method = </span><span class="nx">@_getWidgetMethod</span><span class="p">(</span><span class="nx">fake_channel</span><span class="p">,</span> <span class="nx">widget</span><span class="p">)</span>
                <span class="p">[</span><span class="nx">collection</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">events</span><span class="p">]</span> <span class="o">=</span> <span class="nx">channels_utils</span><span class="p">.</span><span class="nx">splitChannel</span><span class="p">(</span><span class="nx">fake_channel</span><span class="p">)</span></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><p>For relational channel, we have item-level unbinding and
collection-level unbinding, depending on the type of widget
subscription.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="nx">@_getType</span><span class="p">(</span><span class="nx">channel</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;relational&#39;</span>
                    <span class="k">if</span> <span class="nx">item</span> <span class="o">==</span> <span class="s">&quot;all&quot;</span>
                        <span class="nx">@data</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">off</span><span class="p">(</span><span class="nx">events</span><span class="p">,</span> <span class="nx">widget_method</span><span class="p">,</span> <span class="nx">widget</span><span class="p">)</span>
                    <span class="k">else</span>
                        <span class="nv">individual_item = </span><span class="nx">@data</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">get</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a href="#section-29" class="pilcrow">&#182;</a></div><p>Here we might have a problem: when resetting a
collection, there is no way to keep references to the
old widgets so that we unbind events from them.
TODO(andrei): investigate if we can do something in
the BaseModel class.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="k">if</span> <span class="nx">individual_item</span>
                            <span class="nx">individual_item</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="nx">events</span><span class="p">,</span> <span class="nx">widget_method</span><span class="p">,</span> <span class="nx">widget</span><span class="p">)</span>
                <span class="k">else</span> <span class="k">if</span> <span class="nx">@_getType</span><span class="p">(</span><span class="nx">channel</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;api&#39;</span>
                    <span class="nx">@data</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">off</span><span class="p">(</span><span class="nx">events</span><span class="p">,</span> <span class="nx">widget_method</span><span class="p">,</span> <span class="nx">widget</span><span class="p">)</span>

        <span class="nv">destroyWidget: </span><span class="nf">(widget_data) -&gt;</span></pre></div></td></tr><tr id="section-30"><td class="docs"><div class="pilwrap"><a href="#section-30" class="pilcrow">&#182;</a></div><p>Handler for the /destroy<em>widget event published by
widgets when their destroy() method gets called. Their destroy()
method is called by the widget</em>starter, when it has detected
that the widget has been removed from the DOM and the time
for the widget to be GC'ed has come (GC is done in batches).</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s">&quot;Destroy </span><span class="si">#{</span><span class="nx">widget_data</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s"> widget in DataSource&quot;</span><span class="p">)</span>
            <span class="nx">@unbindWidgetFromBackboneEvents</span><span class="p">(</span><span class="nx">widget_data</span><span class="p">.</span><span class="nx">widget</span><span class="p">)</span>
            <span class="nx">@decreaseReferenceCountsForChannelsOfDestroyedWidget</span><span class="p">(</span><span class="nx">widget_data</span><span class="p">.</span><span class="nx">widget</span><span class="p">)</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Mon Aug 05 2013 15:56:37 GMT+0300 (EEST)  </div></div></body></html>