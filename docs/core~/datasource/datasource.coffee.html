<!DOCTYPE html><html><head><title>datasource.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../index.html" class="source"><span class="file_name">README</span></a><a href="../../core~/api_mock.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">api_mock.coffee</span></a><a href="../../core~/application_controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">application_controller.coffee</span></a><a href="../../core~/auth.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">auth.coffee</span></a><a href="../../core~/base_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_collection.coffee</span></a><a href="../../core~/base_model.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_model.coffee</span></a><a href="../../core~/base_widgets/autocomplete.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">autocomplete.coffee</span></a><a href="../../core~/base_widgets/base_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">base_form.coffee</span></a><a href="../../core~/base_widgets/delete_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">delete_form.coffee</span></a><a href="../../core~/base_widgets/expanding_list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">expanding_list.coffee</span></a><a href="../../core~/base_widgets/item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">item_count.coffee</span></a><a href="../../core~/base_widgets/list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">list.coffee</span></a><a href="../../core~/base_widgets/mediator_widget.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">mediator_widget.coffee</span></a><a href="../../core~/base_widgets/nested_attributes_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">nested_attributes_form.coffee</span></a><a href="../../core~/base_widgets/new_items_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">new_items_count.coffee</span></a><a href="../../core~/base_widgets/notification_bar.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notification_bar.coffee</span></a><a href="../../core~/base_widgets/notifications.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notifications.coffee</span></a><a href="../../core~/base_widgets/order_by.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">order_by.coffee</span></a><a href="../../core~/base_widgets/update_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">update_form.coffee</span></a><a href="../../core~/base_widgets/url.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">url.coffee</span></a><a href="../../core~/base_widgets/user_item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">user_item_count.coffee</span></a><a href="../../core~/base_widgets/widget_editor.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">widget_editor.coffee</span></a><a href="../../core~/channels_utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">channels_utils.coffee</span></a><a href="../../core~/constants.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">constants.coffee</span></a><a href="../../core~/context_processors.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">context_processors.coffee</span></a><a href="../../core~/controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">controller.coffee</span></a><a href="../../core~/core_modules.js.html" class="source "><span class="base_path">core~ / </span><span class="file_name">core_modules.js</span></a><a href="../../core~/datasource/channel/create.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">create.coffee</span></a><a href="../../core~/datasource/channel/destroy.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">destroy.coffee</span></a><a href="../../core~/datasource/channel/read.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">read.coffee</span></a><a href="../../core~/datasource/channel/update.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">update.coffee</span></a><a href="../../core~/datasource/channel.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">channel.coffee</span></a><a href="../../core~/datasource/datasource.coffee.html" class="source selected"><span class="base_path">core~ / datasource / </span><span class="file_name">datasource.coffee</span></a><a href="../../core~/datasource/gc.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">gc.coffee</span></a><a href="../../core~/datasource/refresher.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">refresher.coffee</span></a><a href="../../core~/datasource/scheduler.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">scheduler.coffee</span></a><a href="../../core~/datasource/widget.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">widget.coffee</span></a><a href="../../core~/flags_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">flags_collection.coffee</span></a><a href="../../core~/interceptor.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">interceptor.coffee</span></a><a href="../../core~/layout.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">layout.coffee</span></a><a href="../../core~/loader.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loader.coffee</span></a><a href="../../core~/loading_animation.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loading_animation.coffee</span></a><a href="../../core~/logging/sentry_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">sentry_logger.coffee</span></a><a href="../../core~/logging/standard_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">standard_logger.coffee</span></a><a href="../../core~/mocks.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mocks.coffee</span></a><a href="../../core~/modal_window.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">modal_window.coffee</span></a><a href="../../core~/module.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">module.coffee</span></a><a href="../../core~/mozaic_backbone_form.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mozaic_backbone_form.coffee</span></a><a href="../../core~/profiler.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">profiler.coffee</span></a><a href="../../core~/pubsub.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">pubsub.coffee</span></a><a href="../../core~/raw_data.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">raw_data.coffee</span></a><a href="../../core~/router.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">router.coffee</span></a><a href="../../core~/scrollable_widget.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">scrollable_widget.coffee</span></a><a href="../../core~/utils/dom.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">dom.coffee</span></a><a href="../../core~/utils/images.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">images.coffee</span></a><a href="../../core~/utils/misc.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">misc.coffee</span></a><a href="../../core~/utils/mozaic.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">mozaic.coffee</span></a><a href="../../core~/utils/time.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">time.coffee</span></a><a href="../../core~/utils/urls.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">urls.coffee</span></a><a href="../../core~/utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">utils.coffee</span></a><a href="../../core~/widget/aggregated_channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">aggregated_channels.coffee</span></a><a href="../../core~/widget/backbone_events.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">backbone_events.coffee</span></a><a href="../../core~/widget/channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">channels.coffee</span></a><a href="../../core~/widget/modal_widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">modal_widget.coffee</span></a><a href="../../core~/widget/params.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">params.coffee</span></a><a href="../../core~/widget/rendering.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">rendering.coffee</span></a><a href="../../core~/widget/states.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">states.coffee</span></a><a href="../../core~/widget/widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">widget.coffee</span></a><a href="../../core~/widget_starter.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">widget_starter.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>datasource.coffee</h1><div class="filepath">core~/datasource/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span>
    <span class="s">&#39;cs!mozaic_module&#39;</span><span class="p">,</span>
    <span class="s">&#39;cs!channels_utils&#39;</span><span class="p">,</span>
    <span class="s">&#39;cs!core/datasource/channel&#39;</span><span class="p">,</span>
    <span class="s">&#39;cs!core/datasource/channel/create&#39;</span><span class="p">,</span>
    <span class="s">&#39;cs!core/datasource/channel/read&#39;</span><span class="p">,</span>
    <span class="s">&#39;cs!core/datasource/channel/update&#39;</span><span class="p">,</span>
    <span class="s">&#39;cs!core/datasource/channel/destroy&#39;</span><span class="p">,</span>
    <span class="s">&#39;cs!core/datasource/refresher&#39;</span><span class="p">,</span>
    <span class="s">&#39;cs!core/datasource/scheduler&#39;</span><span class="p">,</span>
    <span class="s">&#39;cs!core/datasource/gc&#39;</span><span class="p">,</span>
    <span class="s">&#39;cs!core/datasource/widget&#39;</span>
<span class="p">],</span><span class="nf">(</span>
<span class="nf">    Module,</span>
<span class="nf">    channels_utils,</span>
<span class="nf">    DataSourceChannelMixin,</span>
<span class="nf">    DataSourceChannelCreateMixin,</span>
<span class="nf">    DataSourceChannelReadMixin,</span>
<span class="nf">    DataSourceChannelUpdateMixin,</span>
<span class="nf">    DataSourceChannelDestroyMixin,</span>
<span class="nf">    DataSourceRefresher,</span>
<span class="nf">    DataSourceScheduler,</span>
<span class="nf">    DataSourceGCMixin,</span>
<span class="nf">    DataSourceWidgetMixin</span>
<span class="nf">) -&gt;</span>

    <span class="k">class</span> <span class="nx">DataSource</span> <span class="k">extends</span> <span class="nx">Module</span>

        <span class="nv">checkIntervalForUnusedChannels: </span><span class="mi">10000</span>
        <span class="nv">default_max_refresh_factor: </span><span class="mi">10</span>

        <span class="nv">constructor: </span><span class="nf">-&gt;</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>Call super in order to get mixin functionality</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">super</span><span class="p">()</span>

            <span class="vi">@config = </span><span class="nx">App</span><span class="p">.</span><span class="nx">DataSourceConfig</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Pre-process channel definitions in order to factor in
channel templates. This will allow us to write less
for very similar channels and group the common properties
together.</p>

<p>Moreover, channel templates support the notion of parent,
so that there is actually a 3-level hierarchy:
parent of channel template - channel template - channel def</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">channel_templates</span>
                <span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nx">parent</span>
                    <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">parent</span> <span class="k">of</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">channel_templates</span><span class="p">)</span>
                        <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s">&quot;Channel template </span><span class="si">#{</span><span class="nx">k</span><span class="si">}</span><span class="s"> has invalid parent </span><span class="si">#{</span><span class="nx">v</span><span class="p">.</span><span class="nx">parent</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="nv">parent = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">channel_templates</span><span class="p">[</span><span class="nx">v</span><span class="p">.</span><span class="nx">parent</span><span class="p">]</span>
                    <span class="nx">@config</span><span class="p">.</span><span class="nx">channel_templates</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>

            <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">channel_types</span>
                <span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nx">template</span>
                    <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">template</span> <span class="k">of</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">channel_templates</span><span class="p">)</span>
                        <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s">&quot;Channel type </span><span class="si">#{</span><span class="nx">k</span><span class="si">}</span><span class="s"> has invalid template </span><span class="si">#{</span><span class="nx">v</span><span class="p">.</span><span class="nx">template</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="nv">template = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">channel_templates</span><span class="p">[</span><span class="nx">v</span><span class="p">.</span><span class="nx">template</span><span class="p">]</span>
                    <span class="nx">@config</span><span class="p">.</span><span class="nx">channel_types</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">template</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>

        <span class="nv">initialize: </span><span class="nf">-&gt;</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Initializing data source&quot;</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>Create a big collection hash which stores all the models,
collections and data which will be rendered</p>
</td><td class="code"><div class="highlight"><pre>            <span class="vi">@data = </span><span class="p">{}</span>
            <span class="vi">@meta_data = </span><span class="p">{}</span>
            <span class="vi">@reference_data = </span><span class="p">{}</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>Setting this to false will cause all fetches to perform
synchronous ajax requests (used only for testing).</p>
</td><td class="code"><div class="highlight"><pre>            <span class="vi">@_async_fetches = </span><span class="kc">true</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Subscribe DataSource to the new widget channel.
This will make it subscribe widgets to changes for the data they are monitoring.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="vi">@pipe = </span><span class="nx">loader</span><span class="p">.</span><span class="nx">get_module</span><span class="p">(</span><span class="s">&#39;pubsub&#39;</span><span class="p">)</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Requests for new data channels (coming from widgets / controllers).</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@pipe</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s">&#39;/new_data_channels&#39;</span><span class="p">,</span> <span class="nx">@newDataChannels</span><span class="p">)</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Announcements that new widgets are available
This binds the widgets' methods to the proper channel events
(we need this because channels are private to the DataSource)</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@pipe</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s">&#39;/new_widget&#39;</span><span class="p">,</span> <span class="nf">(data) =&gt;</span> <span class="nx">@newWidget</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>Announcements that widgets were removed
This binds the widgets' methods to the proper channel events
(we need this because channels are private to the DataSource)</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@pipe</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s">&#39;/destroy_widget&#39;</span><span class="p">,</span> <span class="nf">(data) =&gt;</span> <span class="nx">@destroyWidget</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
            <span class="nx">setInterval</span><span class="p">(</span><span class="nx">@checkForUnusedChannels</span><span class="p">,</span> <span class="nx">@checkIntervalForUnusedChannels</span><span class="p">)</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>Requests for scrolling channels</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@pipe</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s">&#39;/scroll&#39;</span><span class="p">,</span> <span class="nx">@pushDataAfterScroll</span><span class="p">)</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>Requests for refreshing data of a given channel</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@pipe</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s">&#39;/refresh&#39;</span><span class="p">,</span> <span class="nx">@pushDataAfterRefresh</span><span class="p">)</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>Requests for modifying a given data channel</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@pipe</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s">&#39;/modify&#39;</span><span class="p">,</span> <span class="nx">@modifyDataChannel</span><span class="p">)</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Requests for adding new data to a given channel</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@pipe</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s">&#39;/add&#39;</span><span class="p">,</span> <span class="nx">@addToDataChannel</span><span class="p">)</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>Requests for deleting data from a given channel</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@pipe</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="s">&#39;/delete&#39;</span><span class="p">,</span> <span class="nx">@deleteFromDataChannel</span><span class="p">)</span>

        <span class="nv">newDataChannels: </span><span class="nf">(channels) =&gt;</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>Create some new data channels on-demand.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>Controllers and widgets usually issue this kind of request,
in order to decide which data sources to "glue" to their
subordinated widgets on their page.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Initializing new channels in DataSource&quot;</span>
            <span class="k">for</span> <span class="nx">channel_guid</span><span class="p">,</span> <span class="nx">channel_data</span> <span class="k">of</span> <span class="nx">channels</span>
                <span class="nx">do</span><span class="nf">(channel_guid, channel_data) =&gt;</span></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>If the channel is already initialized, do nothing,
otherwise initialize the associated collection.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="nx">channel_guid</span> <span class="k">of</span> <span class="nx">@data</span>
                        <span class="k">return</span>

                    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s">&quot;Initializing channel </span><span class="si">#{</span><span class="nx">channel_guid</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>

                    <span class="nv">channel_type = </span><span class="nx">channel_data</span><span class="p">.</span><span class="nx">type</span>
                    <span class="nv">channel_params = </span><span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">channel_data</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>Cannot use @_getType() because channel doesn't exist yet.</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="nx">channel_type</span> <span class="k">of</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">channel_types</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p>Create reference data synchronously, in order for it
to be available ASAP, e.g. on /new_widget events
In theory, this won't longer be needed after we fix
issue https://github.com/uberVU/mozaic/issues/54</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">@reference_data</span><span class="p">[</span><span class="nx">channel_guid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                        <span class="nv">resource_type = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">channel_types</span><span class="p">[</span><span class="nx">channel_type</span><span class="p">].</span><span class="nx">type</span>
                        <span class="k">if</span> <span class="nx">resource_type</span> <span class="o">==</span> <span class="s">&#39;relational&#39;</span>
                            <span class="nx">@_initRelationalChannel</span><span class="p">(</span><span class="nx">channel_guid</span><span class="p">,</span> <span class="nx">channel_type</span><span class="p">,</span> <span class="nx">channel_params</span><span class="p">)</span>
                        <span class="k">else</span> <span class="k">if</span> <span class="nx">resource_type</span> <span class="o">==</span> <span class="s">&#39;api&#39;</span>
                            <span class="nx">@_initApiChannel</span><span class="p">(</span><span class="nx">channel_guid</span><span class="p">,</span> <span class="nx">channel_type</span><span class="p">,</span> <span class="nx">channel_params</span><span class="p">)</span>
                    <span class="k">else</span>
                        <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s">&quot;Trying to initialize channel of unknown type: </span><span class="si">#{</span><span class="nx">channel_type</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="nv">syncModelWithResponse: </span><span class="nf">(model, response, silent = true) -&gt;</span></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>Given a model and a response, if the
model has a sync<em>with</em>server list,
look each field in the response and
overwrite it in the model, if it exists.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="k">unless</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">model</span><span class="o">?</span><span class="p">.</span><span class="nx">sync_with_server</span><span class="p">)</span>

            <span class="nv">obj = </span><span class="p">{}</span>
            <span class="k">for</span> <span class="nx">field</span> <span class="k">in</span> <span class="nx">model</span><span class="p">.</span><span class="nx">sync_with_server</span>
                <span class="k">if</span> <span class="nx">field</span> <span class="k">of</span> <span class="nx">response</span>
                    <span class="nx">obj</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="nx">response</span><span class="p">[</span><span class="nx">field</span><span class="p">]</span>
            <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="p">{</span> <span class="nv">silent: </span><span class="nx">silent</span> <span class="p">})</span>

        <span class="nv">destroy: </span><span class="nf">-&gt;</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Destroying data source&quot;</span>

        <span class="nv">_getChannelDuplicates: </span><span class="nf">(channel_guid) =&gt;</span></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>Determines all duplicates of some channel. Returns a list
of channel_guids, or an empty list, if not duplicates are found.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">duplicates = </span><span class="p">[</span> <span class="p">]</span>
            <span class="nv">channel_data = </span><span class="nx">@meta_data</span><span class="p">[</span><span class="nx">channel_guid</span><span class="p">]</span>
            <span class="k">for</span> <span class="nx">other_channel_guid</span><span class="p">,</span> <span class="nx">other_channel_data</span> <span class="k">of</span> <span class="nx">@meta_data</span>
                <span class="k">if</span> <span class="nx">channel_guid</span> <span class="o">!=</span> <span class="nx">other_channel_guid</span> <span class="o">and</span>
                   <span class="nx">channel_data</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">other_channel_data</span><span class="p">.</span><span class="nx">type</span> <span class="o">and</span>
                   <span class="nx">_</span><span class="p">.</span><span class="nx">isEqual</span><span class="p">(</span><span class="nx">channel_data</span><span class="p">.</span><span class="nx">params</span><span class="p">,</span> <span class="nx">other_channel_data</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span>
                    <span class="nx">duplicates</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">other_channel_guid</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">duplicates</span>

        <span class="nv">_finishChannelInitialization: </span><span class="nf">(channel_guid) =&gt;</span></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><p>Channel initialization ends with one of the following outcomes,
depending on existence of channel duplicates:
1) if no duplicates exist => fetch
2) if duplicates exist and some have data => clone
3) if duplicates exist but none have data => wait
Waiting for data only happens when a duplicate exists that
does not have data (yet). That channel is currently waiting
for data (in fetching state), and when it receives data, it
will fill this channel as well (via <em>fillWaitingChannels).
Get the channel's start</em>immediately configuration. It tells us
whether we should fetch channel data from server right after
channel instantiation. Defaults to true</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">start_immediately = </span><span class="nx">@_getConfig</span><span class="p">(</span><span class="nx">channel_guid</span><span class="p">).</span><span class="nx">start_immediately</span>
            <span class="k">if</span> <span class="o">not</span> <span class="nx">start_immediately</span><span class="o">?</span>
                <span class="nv">start_immediately = </span><span class="kc">true</span></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><p>Cloning / fetching logic:</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">duplicates = </span><span class="nx">@_getChannelDuplicates</span><span class="p">(</span><span class="nx">channel_guid</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">duplicates</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">or</span> <span class="nx">@_getConfig</span><span class="p">(</span><span class="nx">channel_guid</span><span class="p">).</span><span class="nx">disable_clone</span></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>1) No channel duplicates exist, perform fetch.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nv">refresh_interval = </span><span class="nx">@_getRefreshInterval</span><span class="p">(</span><span class="nx">channel_guid</span><span class="p">)</span>
                <span class="k">if</span> <span class="nx">refresh_interval</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="nx">start_immediately</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><p>Fetch the initial data for the channel</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">@_fetchChannelDataFromServer</span><span class="p">(</span><span class="nx">channel_guid</span><span class="p">)</span>
                <span class="k">else</span></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><p>Fetch the initial data for the channel</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="k">if</span> <span class="o">not</span> <span class="nx">@meta_data</span><span class="p">[</span><span class="nx">channel_guid</span><span class="p">].</span><span class="nx">populate_on_init</span> <span class="o">and</span> <span class="nx">start_immediately</span>
                        <span class="nx">@_fetchChannelDataFromServer</span><span class="p">(</span><span class="nx">channel_guid</span><span class="p">)</span>
                    <span class="k">else</span></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><p>If this channel was populated on init, mark it
as having data.</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">@meta_data</span><span class="p">[</span><span class="nx">channel_guid</span><span class="p">].</span><span class="nv">last_fetch = </span><span class="nx">Utils</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
            <span class="k">else</span></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><p>If at least one duplicate was fetched (has data), use it
as a cloning source. Otherwise, this channel will wait
for data.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nv">duplicate_channel_guid = </span><span class="kc">null</span>
                <span class="k">for</span> <span class="nx">other_channel_guid</span> <span class="k">in</span> <span class="nx">duplicates</span>
                    <span class="k">if</span> <span class="nx">@meta_data</span><span class="p">[</span><span class="nx">other_channel_guid</span><span class="p">].</span><span class="nx">last_fetch</span><span class="o">?</span>
                        <span class="nv">duplicate_channel_guid = </span><span class="nx">other_channel_guid</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="nx">duplicate_channel_guid</span>
                    <span class="nx">@_cloneChannel</span><span class="p">(</span><span class="nx">channel_guid</span><span class="p">,</span> <span class="nx">duplicate_channel_guid</span><span class="p">)</span>
                <span class="k">else</span>
                    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Channel </span><span class="si">#{</span><span class="nx">channel_guid</span><span class="si">}</span><span class="s"> is waiting for data&quot;</span></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a href="#section-29" class="pilcrow">&#182;</a></div><p>Setup periodic refresh if needed.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@_startRefreshing</span><span class="p">(</span><span class="nx">channel_guid</span><span class="p">)</span></pre></div></td></tr><tr id="section-30"><td class="docs"><div class="pilwrap"><a href="#section-30" class="pilcrow">&#182;</a></div><p>Announce widget starter a new channel is available</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">@pipe</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s">&#39;/initialized_channel&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nv">name: </span><span class="nx">channel_guid</span><span class="p">})</span>

    <span class="nx">DataSource</span><span class="p">.</span><span class="nx">includeMixin</span><span class="p">(</span><span class="nx">DataSourceChannelMixin</span><span class="p">)</span>
    <span class="nx">DataSource</span><span class="p">.</span><span class="nx">includeMixin</span><span class="p">(</span><span class="nx">DataSourceChannelCreateMixin</span><span class="p">)</span>
    <span class="nx">DataSource</span><span class="p">.</span><span class="nx">includeMixin</span><span class="p">(</span><span class="nx">DataSourceChannelReadMixin</span><span class="p">)</span>
    <span class="nx">DataSource</span><span class="p">.</span><span class="nx">includeMixin</span><span class="p">(</span><span class="nx">DataSourceChannelUpdateMixin</span><span class="p">)</span>
    <span class="nx">DataSource</span><span class="p">.</span><span class="nx">includeMixin</span><span class="p">(</span><span class="nx">DataSourceChannelDestroyMixin</span><span class="p">)</span>
    <span class="nx">DataSource</span><span class="p">.</span><span class="nx">includeMixin</span><span class="p">(</span><span class="nx">DataSourceRefresher</span><span class="p">)</span>
    <span class="nx">DataSource</span><span class="p">.</span><span class="nx">includeMixin</span><span class="p">(</span><span class="nx">DataSourceScheduler</span><span class="p">)</span>
    <span class="nx">DataSource</span><span class="p">.</span><span class="nx">includeMixin</span><span class="p">(</span><span class="nx">DataSourceGCMixin</span><span class="p">)</span>
    <span class="nx">DataSource</span><span class="p">.</span><span class="nx">includeMixin</span><span class="p">(</span><span class="nx">DataSourceWidgetMixin</span><span class="p">)</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Mon Aug 05 2013 15:56:37 GMT+0300 (EEST)  </div></div></body></html>