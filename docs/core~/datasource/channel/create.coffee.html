<!DOCTYPE html><html><head><title>create.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../../index.html" class="source"><span class="file_name">README</span></a><a href="../../../core~/api_mock.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">api_mock.coffee</span></a><a href="../../../core~/application_controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">application_controller.coffee</span></a><a href="../../../core~/auth.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">auth.coffee</span></a><a href="../../../core~/base_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_collection.coffee</span></a><a href="../../../core~/base_model.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_model.coffee</span></a><a href="../../../core~/base_widgets/autocomplete.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">autocomplete.coffee</span></a><a href="../../../core~/base_widgets/base_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">base_form.coffee</span></a><a href="../../../core~/base_widgets/delete_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">delete_form.coffee</span></a><a href="../../../core~/base_widgets/expanding_list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">expanding_list.coffee</span></a><a href="../../../core~/base_widgets/item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">item_count.coffee</span></a><a href="../../../core~/base_widgets/list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">list.coffee</span></a><a href="../../../core~/base_widgets/mediator_widget.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">mediator_widget.coffee</span></a><a href="../../../core~/base_widgets/nested_attributes_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">nested_attributes_form.coffee</span></a><a href="../../../core~/base_widgets/new_items_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">new_items_count.coffee</span></a><a href="../../../core~/base_widgets/notification_bar.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notification_bar.coffee</span></a><a href="../../../core~/base_widgets/notifications.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notifications.coffee</span></a><a href="../../../core~/base_widgets/order_by.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">order_by.coffee</span></a><a href="../../../core~/base_widgets/update_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">update_form.coffee</span></a><a href="../../../core~/base_widgets/url.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">url.coffee</span></a><a href="../../../core~/base_widgets/user_item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">user_item_count.coffee</span></a><a href="../../../core~/base_widgets/widget_editor.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">widget_editor.coffee</span></a><a href="../../../core~/channels_utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">channels_utils.coffee</span></a><a href="../../../core~/constants.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">constants.coffee</span></a><a href="../../../core~/context_processors.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">context_processors.coffee</span></a><a href="../../../core~/controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">controller.coffee</span></a><a href="../../../core~/core_modules.js.html" class="source "><span class="base_path">core~ / </span><span class="file_name">core_modules.js</span></a><a href="../../../core~/datasource/channel/create.coffee.html" class="source selected"><span class="base_path">core~ / datasource / channel / </span><span class="file_name">create.coffee</span></a><a href="../../../core~/datasource/channel/destroy.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">destroy.coffee</span></a><a href="../../../core~/datasource/channel/read.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">read.coffee</span></a><a href="../../../core~/datasource/channel/update.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">update.coffee</span></a><a href="../../../core~/datasource/channel.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">channel.coffee</span></a><a href="../../../core~/datasource/datasource.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">datasource.coffee</span></a><a href="../../../core~/datasource/gc.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">gc.coffee</span></a><a href="../../../core~/datasource/refresher.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">refresher.coffee</span></a><a href="../../../core~/datasource/scheduler.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">scheduler.coffee</span></a><a href="../../../core~/datasource/widget.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">widget.coffee</span></a><a href="../../../core~/flags_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">flags_collection.coffee</span></a><a href="../../../core~/interceptor.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">interceptor.coffee</span></a><a href="../../../core~/layout.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">layout.coffee</span></a><a href="../../../core~/loader.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loader.coffee</span></a><a href="../../../core~/loading_animation.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loading_animation.coffee</span></a><a href="../../../core~/logging/sentry_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">sentry_logger.coffee</span></a><a href="../../../core~/logging/standard_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">standard_logger.coffee</span></a><a href="../../../core~/mocks.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mocks.coffee</span></a><a href="../../../core~/modal_window.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">modal_window.coffee</span></a><a href="../../../core~/module.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">module.coffee</span></a><a href="../../../core~/mozaic_backbone_form.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mozaic_backbone_form.coffee</span></a><a href="../../../core~/profiler.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">profiler.coffee</span></a><a href="../../../core~/pubsub.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">pubsub.coffee</span></a><a href="../../../core~/raw_data.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">raw_data.coffee</span></a><a href="../../../core~/router.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">router.coffee</span></a><a href="../../../core~/scrollable_widget.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">scrollable_widget.coffee</span></a><a href="../../../core~/utils/dom.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">dom.coffee</span></a><a href="../../../core~/utils/images.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">images.coffee</span></a><a href="../../../core~/utils/misc.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">misc.coffee</span></a><a href="../../../core~/utils/mozaic.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">mozaic.coffee</span></a><a href="../../../core~/utils/time.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">time.coffee</span></a><a href="../../../core~/utils/urls.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">urls.coffee</span></a><a href="../../../core~/utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">utils.coffee</span></a><a href="../../../core~/widget/aggregated_channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">aggregated_channels.coffee</span></a><a href="../../../core~/widget/backbone_events.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">backbone_events.coffee</span></a><a href="../../../core~/widget/channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">channels.coffee</span></a><a href="../../../core~/widget/modal_widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">modal_widget.coffee</span></a><a href="../../../core~/widget/params.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">params.coffee</span></a><a href="../../../core~/widget/rendering.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">rendering.coffee</span></a><a href="../../../core~/widget/states.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">states.coffee</span></a><a href="../../../core~/widget/widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">widget.coffee</span></a><a href="../../../core~/widget_starter.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">widget_starter.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>create.coffee</h1><div class="filepath">core~/datasource/channel/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span><span class="s">&#39;cs!channels_utils&#39;</span><span class="p">],</span> <span class="nf">(channels_utils) -&gt;</span>

    <span class="k">class</span> <span class="nx">DataSourceChannelCreateMixin</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>Includes methods around adding data to a datasource channel and
syncing data with the server</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">addToDataChannel: </span><span class="nf">(channel, dict) -&gt;</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>This gets called whenever a new widget publishes to '/add' channel</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Adding new data to </span><span class="si">#{</span><span class="nx">channel</span><span class="si">}</span><span class="s"> in DataSource&quot;</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>Get the collection associated with this channel</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">collection = </span><span class="nx">channels_utils</span><span class="p">.</span><span class="nx">getChannelKey</span><span class="p">(</span><span class="nx">channel</span><span class="p">)</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>HACK: determine the sync for this item. It is sent in the
dict updates ...</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">sync = </span><span class="nx">dict</span><span class="p">[</span><span class="s">&#39;__sync__&#39;</span><span class="p">]</span>
            <span class="k">delete</span> <span class="nx">dict</span><span class="p">[</span><span class="s">&#39;__sync__&#39;</span><span class="p">]</span>

            <span class="nv">model = </span><span class="k">new</span> <span class="nx">@data</span><span class="p">[</span><span class="nx">collection</span><span class="p">].</span><span class="nx">model</span><span class="p">(</span><span class="nx">dict</span><span class="p">)</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Based on the sync argument we decide whether we should
save the model on the server</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nx">sync</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Copy the url of the collection to the model, until the model
is appended to the collection. Check BaseModel.url()</p>

<p>If collection doesn't have an URL, we will take the vanilla URL
from the configuration of the channel and check if it needs
any parameters. If it doesn't, we will use it. Otherwise,
we will raise an error.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="o">not</span> <span class="nx">@data</span><span class="p">[</span><span class="nx">collection</span><span class="p">].</span><span class="nx">url</span><span class="o">?</span>
                    <span class="nv">channel_config = </span><span class="nx">@_getConfig</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
                    <span class="k">if</span> <span class="o">not</span> <span class="nx">channel_config</span><span class="p">.</span><span class="nx">url</span><span class="o">?</span> <span class="o">or</span> <span class="nx">channel_config</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="sr">/{{[^{}]*}}/</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s">&quot;Channel </span><span class="si">#{</span><span class="nx">collection</span><span class="si">}</span><span class="s"> doesn&#39;t have an URL or it needs params&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="nv">collection_url = </span><span class="nx">channel_config</span><span class="p">.</span><span class="nx">url</span>
                <span class="k">else</span>
                    <span class="nv">collection_url = </span><span class="nx">@data</span><span class="p">[</span><span class="nx">collection</span><span class="p">].</span><span class="nx">url</span>

                <span class="nv">model.urlRoot = </span><span class="nx">collection_url</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Trigger a custom invalidate event before the
model is saved to the server. Backbone.Model emits
a sync event if the save was successful</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">model</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s">&#39;invalidate&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>Instead of adding the model to the collection via .create perform
a manual save and if the operation is successful then append the
model to the collection. By default collection.create appends
the model to the collection even if the model wasn't saved
successfully (and we don't want that)</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">model</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">attributes</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nv">error: </span><span class="nf">(model, response, options) =&gt;</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>Ignore response if channel was removed in the meantime</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="k">return</span> <span class="k">unless</span> <span class="nx">@reference_data</span><span class="p">[</span><span class="nx">collection</span><span class="p">]</span><span class="o">?</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>Trigger an error event on the collection, even though the model
is not part of the collection yet. This is a CONVENTION to
ease the work with new models</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="nx">@data</span><span class="p">[</span><span class="nx">collection</span><span class="p">].</span><span class="nx">trigger</span><span class="p">(</span><span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">@data</span><span class="p">[</span><span class="nx">collection</span><span class="p">],</span> <span class="nx">response</span><span class="p">)</span>
                    <span class="nv">success: </span><span class="nf">(model, response) =&gt;</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>Ignore response if channel was removed in the meantime</p>
</td><td class="code"><div class="highlight"><pre>                        <span class="k">return</span> <span class="k">unless</span> <span class="nx">@reference_data</span><span class="p">[</span><span class="nx">collection</span><span class="p">]</span><span class="o">?</span>
                        <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>Sometimes, we make one single POST which
result in multiple items being created. In
this case, the response will be an array
of individual items, and these should be added
to the channel instead of the original POSTed
model.</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="nv">model_class = </span><span class="nx">@meta_data</span><span class="p">[</span><span class="nx">collection</span><span class="p">].</span><span class="nx">model_class</span>
                            <span class="k">for</span> <span class="nx">response_item</span> <span class="k">in</span> <span class="nx">response</span>
                                <span class="nv">model = </span><span class="k">new</span> <span class="nx">model_class</span><span class="p">(</span><span class="nx">response_item</span><span class="p">)</span>
                                <span class="nx">@data</span><span class="p">[</span><span class="nx">collection</span><span class="p">].</span><span class="nx">add</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span>
                        <span class="k">else</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>Update model with attributes to sync from response.</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="nx">@syncModelWithResponse</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>Make sure that we propagate ID of object
coming from server to the actual Backbone Model.
Otherwise, the model freshly added in the collection
will not have an ID and we cannot use it immediately.</p>
</td><td class="code"><div class="highlight"><pre>                            <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">{</span><span class="nv">silent: </span><span class="kc">true</span><span class="p">})</span>
                            <span class="nx">@data</span><span class="p">[</span><span class="nx">collection</span><span class="p">].</span><span class="nx">add</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span>
                        <span class="k">else</span>
                            <span class="nx">@data</span><span class="p">[</span><span class="nx">collection</span><span class="p">].</span><span class="nx">add</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span>
                <span class="p">})</span>
            <span class="k">else</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>Just add the model in the collection</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nx">@data</span><span class="p">[</span><span class="nx">collection</span><span class="p">].</span><span class="nx">add</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Mon Aug 05 2013 15:56:36 GMT+0300 (EEST)  </div></div></body></html>