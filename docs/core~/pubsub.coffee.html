<!DOCTYPE html><html><head><title>pubsub.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../index.html" class="source"><span class="file_name">README</span></a><a href="../core~/api_mock.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">api_mock.coffee</span></a><a href="../core~/application_controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">application_controller.coffee</span></a><a href="../core~/auth.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">auth.coffee</span></a><a href="../core~/base_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_collection.coffee</span></a><a href="../core~/base_model.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">base_model.coffee</span></a><a href="../core~/base_widgets/autocomplete.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">autocomplete.coffee</span></a><a href="../core~/base_widgets/base_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">base_form.coffee</span></a><a href="../core~/base_widgets/delete_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">delete_form.coffee</span></a><a href="../core~/base_widgets/expanding_list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">expanding_list.coffee</span></a><a href="../core~/base_widgets/item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">item_count.coffee</span></a><a href="../core~/base_widgets/list.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">list.coffee</span></a><a href="../core~/base_widgets/mediator_widget.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">mediator_widget.coffee</span></a><a href="../core~/base_widgets/nested_attributes_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">nested_attributes_form.coffee</span></a><a href="../core~/base_widgets/new_items_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">new_items_count.coffee</span></a><a href="../core~/base_widgets/notification_bar.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notification_bar.coffee</span></a><a href="../core~/base_widgets/notifications.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">notifications.coffee</span></a><a href="../core~/base_widgets/order_by.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">order_by.coffee</span></a><a href="../core~/base_widgets/update_form.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">update_form.coffee</span></a><a href="../core~/base_widgets/url.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">url.coffee</span></a><a href="../core~/base_widgets/user_item_count.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">user_item_count.coffee</span></a><a href="../core~/base_widgets/widget_editor.coffee.html" class="source "><span class="base_path">core~ / base_widgets / </span><span class="file_name">widget_editor.coffee</span></a><a href="../core~/channels_utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">channels_utils.coffee</span></a><a href="../core~/constants.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">constants.coffee</span></a><a href="../core~/context_processors.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">context_processors.coffee</span></a><a href="../core~/controller.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">controller.coffee</span></a><a href="../core~/core_modules.js.html" class="source "><span class="base_path">core~ / </span><span class="file_name">core_modules.js</span></a><a href="../core~/datasource/channel/create.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">create.coffee</span></a><a href="../core~/datasource/channel/destroy.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">destroy.coffee</span></a><a href="../core~/datasource/channel/read.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">read.coffee</span></a><a href="../core~/datasource/channel/update.coffee.html" class="source "><span class="base_path">core~ / datasource / channel / </span><span class="file_name">update.coffee</span></a><a href="../core~/datasource/channel.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">channel.coffee</span></a><a href="../core~/datasource/datasource.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">datasource.coffee</span></a><a href="../core~/datasource/gc.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">gc.coffee</span></a><a href="../core~/datasource/refresher.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">refresher.coffee</span></a><a href="../core~/datasource/scheduler.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">scheduler.coffee</span></a><a href="../core~/datasource/widget.coffee.html" class="source "><span class="base_path">core~ / datasource / </span><span class="file_name">widget.coffee</span></a><a href="../core~/flags_collection.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">flags_collection.coffee</span></a><a href="../core~/interceptor.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">interceptor.coffee</span></a><a href="../core~/layout.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">layout.coffee</span></a><a href="../core~/loader.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loader.coffee</span></a><a href="../core~/loading_animation.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">loading_animation.coffee</span></a><a href="../core~/logging/sentry_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">sentry_logger.coffee</span></a><a href="../core~/logging/standard_logger.coffee.html" class="source "><span class="base_path">core~ / logging / </span><span class="file_name">standard_logger.coffee</span></a><a href="../core~/mocks.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mocks.coffee</span></a><a href="../core~/modal_window.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">modal_window.coffee</span></a><a href="../core~/module.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">module.coffee</span></a><a href="../core~/mozaic_backbone_form.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">mozaic_backbone_form.coffee</span></a><a href="../core~/profiler.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">profiler.coffee</span></a><a href="../core~/pubsub.coffee.html" class="source selected"><span class="base_path">core~ / </span><span class="file_name">pubsub.coffee</span></a><a href="../core~/raw_data.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">raw_data.coffee</span></a><a href="../core~/router.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">router.coffee</span></a><a href="../core~/scrollable_widget.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">scrollable_widget.coffee</span></a><a href="../core~/utils/dom.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">dom.coffee</span></a><a href="../core~/utils/images.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">images.coffee</span></a><a href="../core~/utils/misc.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">misc.coffee</span></a><a href="../core~/utils/mozaic.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">mozaic.coffee</span></a><a href="../core~/utils/time.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">time.coffee</span></a><a href="../core~/utils/urls.coffee.html" class="source "><span class="base_path">core~ / utils / </span><span class="file_name">urls.coffee</span></a><a href="../core~/utils.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">utils.coffee</span></a><a href="../core~/widget/aggregated_channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">aggregated_channels.coffee</span></a><a href="../core~/widget/backbone_events.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">backbone_events.coffee</span></a><a href="../core~/widget/channels.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">channels.coffee</span></a><a href="../core~/widget/modal_widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">modal_widget.coffee</span></a><a href="../core~/widget/params.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">params.coffee</span></a><a href="../core~/widget/rendering.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">rendering.coffee</span></a><a href="../core~/widget/states.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">states.coffee</span></a><a href="../core~/widget/widget.coffee.html" class="source "><span class="base_path">core~ / widget / </span><span class="file_name">widget.coffee</span></a><a href="../core~/widget_starter.coffee.html" class="source "><span class="base_path">core~ / </span><span class="file_name">widget_starter.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>pubsub.coffee</h1><div class="filepath">core~/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">define</span> <span class="p">[],</span> <span class="p">()</span> <span class="nf">-&gt;</span>
    <span class="k">class</span> <span class="nx">PubSub</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>Communication backbone between the Mozaic components.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Basically, the main Mozaic components such as datasource,
widgets and controllers are completely decoupled and communicate
through a pub-sub model.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>This contains a breakage of a component to a part of the system.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>Regular expression used to split event strings</p>
</td><td class="code"><div class="highlight"><pre>        <span class="nv">eventSplitter = </span><span class="sr">/\s+/</span>
        <span class="nv">slice = </span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span>

        <span class="nv">constructor: </span><span class="nf">-&gt;</span>
            <span class="vi">@_callbacks = </span><span class="p">{}</span>
            <span class="nx">@_callbacks</span><span class="p">[</span><span class="s">&#39;all&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="nv">initialize: </span><span class="nf">-&gt;</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Initializing PubSub&quot;</span>

        <span class="nv">destroy: </span><span class="nf">-&gt;</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Destroying PubSub&quot;</span>

        <span class="nv">subscribe: </span><span class="nf">(events, callback, context) -&gt;</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Bind one or more space separated events, <code>events</code>, to a
<code>callback</code> function. Passing <code>"all"</code> will bind the callback
to all events fired.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Subscribing to an event without providing a callback makes no sense</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">callback</span>

            <span class="nv">events = </span><span class="nx">events</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">eventSplitter</span><span class="p">)</span>
            <span class="k">for</span> <span class="nx">event</span> <span class="k">in</span> <span class="nx">events</span>
                <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">event</span> <span class="k">of</span> <span class="nx">@_callbacks</span><span class="p">)</span>
                    <span class="nx">@_callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="nv">list = </span><span class="nx">@_callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span>
                <span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nv">context: </span><span class="nx">context</span><span class="p">,</span> <span class="nv">callback: </span><span class="nx">callback</span><span class="p">})</span>

        <span class="nv">publish: </span><span class="nf">(events, data, register=false) -&gt;</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Publish one or many events, firing all bound callbacks.
Callbacks are passed the same arguments as 'publish' is, apart
from the event name (unless you're listening on 'all', which
will cause your callback to receive the true name of the event
as the first argument).</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nv">rest = </span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="nv">events = </span><span class="nx">events</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">eventSplitter</span><span class="p">)</span>

            <span class="nv">calls = </span><span class="nx">@_callbacks</span>
            <span class="k">return</span> <span class="k">unless</span> <span class="nx">calls</span>

            <span class="nv">publishEventsOneByOne = </span><span class="nf">(restOfEvents) =&gt;</span>

                <span class="nv">event = </span><span class="nx">restOfEvents</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
                <span class="k">return</span> <span class="k">unless</span> <span class="nx">event</span>

                <span class="nv">triggerCallback = </span><span class="nf">(calls) -&gt;</span>
                    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">calls</span><span class="p">)</span> <span class="o">and</span> <span class="nx">calls</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="nv">node = </span><span class="nx">calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="nx">setTimeout</span> <span class="nf">-&gt;</span>
                            <span class="nx">node</span><span class="p">.</span><span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">context</span> <span class="o">or</span> <span class="k">this</span><span class="p">,</span> <span class="nx">rest</span><span class="p">)</span>
                        <span class="p">,</span> <span class="mi">0</span>
                        <span class="nx">triggerCallback</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">rest</span><span class="p">(</span><span class="nx">calls</span><span class="p">))</span>

                <span class="nx">triggerCallback</span><span class="p">(</span><span class="nx">calls</span><span class="p">[</span><span class="nx">event</span><span class="p">])</span> <span class="k">if</span> <span class="nx">calls</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span>
                <span class="nx">triggerCallback</span><span class="p">(</span><span class="nx">calls</span><span class="p">[</span><span class="s">&#39;all&#39;</span><span class="p">])</span>

                <span class="nx">publishEventsOneByOne</span><span class="p">(</span><span class="nx">restOfEvents</span><span class="p">)</span>

            <span class="nx">publishEventsOneByOne</span><span class="p">(</span><span class="nx">events</span><span class="p">)</span>

        <span class="nv">unsubscribe: </span><span class="nf">(events, callback, context) -&gt;</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>Remove one or many callbacks.</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>If 'context' is null, removes all callbacks with that function.
If 'events' is null, removes all bound callbacks for all events.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;--unsubscribing from </span><span class="si">#{</span><span class="nx">events</span><span class="si">}</span><span class="s">&quot;</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>No events, or removing <em>all</em> events.</p>
</td><td class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nv">calls = </span><span class="nx">@_callbacks</span><span class="p">)</span>
            <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">events</span> <span class="o">or</span> <span class="nx">callback</span> <span class="o">or</span> <span class="nx">context</span><span class="p">)</span>
                <span class="k">delete</span> <span class="nx">@_callbacks</span>

            <span class="nv">events = </span><span class="k">if</span> <span class="nx">events</span> <span class="k">then</span> <span class="nx">events</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">eventSplitter</span><span class="p">)</span> <span class="k">else</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">calls</span><span class="p">)</span>

            <span class="k">for</span> <span class="nx">event</span> <span class="k">in</span> <span class="nx">events</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>If there are no callbacks for this event, bail out.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="o">not</span> <span class="nx">calls</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span>
                    <span class="k">continue</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>If we want to delete all the callbacks for a given event, do it.</p>
</td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span><span class="o">not</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="o">not</span> <span class="nx">context</span><span class="p">)</span>
                    <span class="k">delete</span> <span class="nx">calls</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span>
                    <span class="k">continue</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>If we reached this point, we must remove a non-empty callback
from a list of events. This is actually pretty simple:
iterate through the list and skip this item</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nv">new_list = </span><span class="p">[]</span>
                <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">calls</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">callback</span> <span class="o">!=</span> <span class="nx">callback</span> <span class="o">or</span> <span class="nx">node</span><span class="p">.</span><span class="nx">context</span> <span class="o">!=</span> <span class="nx">context</span>
                        <span class="nx">new_list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
                <span class="nx">calls</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="nx">new_list</span>

    <span class="k">return</span> <span class="nx">PubSub</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Mon Aug 05 2013 15:56:41 GMT+0300 (EEST)  </div></div></body></html>